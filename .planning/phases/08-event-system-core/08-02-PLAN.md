---
phase: 08-event-system-core
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventBusSubsystem.h
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/Subsystems/GSDEventBusSubsystem.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Systems can broadcast events without knowing who receives them"
    - "Systems can subscribe to event types using GameplayTags"
    - "Wildcard matching works (Event.Daily matches Event.Daily.Construction)"
    - "Delegate handles are properly stored and can be used to unsubscribe"
  artifacts:
    - path: "Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventBusSubsystem.h"
      provides: "Event bus subsystem with GameplayTag routing"
      exports: ["UGSDEventBusSubsystem", "FGSDEventHandle", "FOnGSDEvent"]
      min_lines: 80
    - path: "Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/Subsystems/GSDEventBusSubsystem.cpp"
      provides: "Event bus implementation"
      contains: "BroadcastEvent"
      contains: "Subscribe"
      contains: "Unsubscribe"
  key_links:
    - from: "GSDEventBusSubsystem"
      to: "FGameplayTag"
      via: "Event routing"
      pattern: "FGameplayTag.*EventTag"
    - from: "BroadcastEvent"
      to: "EventDelegates"
      via: "TMap lookup and broadcast"
      pattern: "EventDelegates\\.Find"
---

<objective>
Create the event bus subsystem for decoupled messaging with GameplayTag routing.

Purpose: Enable systems to communicate without direct dependencies. Events are routed by GameplayTag, supporting hierarchical matching (Event.Daily.Construction triggers Event.Daily listeners).

Output: UGSDEventBusSubsystem world subsystem with Subscribe, BroadcastEvent, and Unsubscribe methods.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-event-system-core/08-RESEARCH.md

# Reference patterns from existing subsystems
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Subsystems/GSDCrowdManagerSubsystem.h
@Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Subsystems/GSDCrowdManagerSubsystem.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Event Bus Subsystem Header</name>
  <files>
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventBusSubsystem.h
  </files>
  <action>
    Create the event bus subsystem header following the research recommendations and GSD patterns.

    1. Create Subsystems/ directory under Public/ and Private/

    2. Define delegate types:
       ```cpp
       DECLARE_MULTICAST_DELEGATE_ThreeParams(FOnGSDEvent,
           FGameplayTag /*EventTag*/,
           const FVector& /*Location*/,
           float /*Intensity*/);
       ```

    3. Define FGSDEventHandle struct:
       - FDelegateHandle DelegateHandle
       - FGameplayTag SubscribedTag
       - IsValid() method
       - USTRUCT(BlueprintType)

    4. Define UGSDEventBusSubsystem : public UWorldSubsystem:
       - GSD_DAILYEVENTS_API export
       - GENERATED_BODY()

       Public methods:
       - FGSDEventHandle Subscribe(FGameplayTag EventTag, FOnGSDEvent::FDelegate&& Delegate)
       - void BroadcastEvent(FGameplayTag EventTag, FVector Location, float Intensity = 1.0f)
       - void Unsubscribe(FGSDEventHandle& Handle)
       - int32 GetActiveEventCount() const

       Protected:
       - TMap<FGameplayTag, FOnGSDEvent> EventDelegates
       - TArray<FGameplayTag> ActiveEvents
       - bool ShouldCreateSubsystem(UWorld* World) const override

    5. Include proper headers:
       - CoreMinimal.h
       - Subsystems/WorldSubsystem.h
       - GameplayTagContainer.h

    Follow exact documentation style from GSDCrowdManagerSubsystem with Usage comments.
  </action>
  <verify>
    grep -l "UGSDEventBusSubsystem" Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventBusSubsystem.h
    grep -l "FOnGSDEvent" Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventBusSubsystem.h
    grep -l "FGSDEventHandle" Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventBusSubsystem.h
  </verify>
  <done>
    Event bus header exists with Subscribe, BroadcastEvent, Unsubscribe methods. FGSDEventHandle struct defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Event Bus Subsystem</name>
  <files>
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/Subsystems/GSDEventBusSubsystem.cpp
  </files>
  <action>
    Implement the event bus subsystem following research patterns.

    1. Create Subsystems/ directory under Private/

    2. Include headers:
       - Subsystems/GSDEventBusSubsystem.h
       - GSDEventLog.h

    3. Implement Subscribe():
       - FindOrAdd delegate in EventDelegates map
       - Add delegate, store handle
       - Log subscription with GSDEVENT_TRACE
       - Return FGSDEventHandle

    4. Implement BroadcastEvent():
       - Log broadcast with GSDEVENT_LOG(Log, ...)
       - Find exact match in EventDelegates, broadcast if found
       - CRITICAL: Also broadcast to parent tags (hierarchical matching)
         - Iterate EventDelegates
         - If EventTag.MatchesTag(Pair.Key) && Pair.Key != EventTag, broadcast
         - This allows Event.Daily listener to receive Event.Daily.Construction events
       - Add to ActiveEvents array

    5. Implement Unsubscribe():
       - Check handle validity
       - Find delegate, remove handle
       - Reset handle
       - Log unsubscription

    6. Implement ShouldCreateSubsystem():
       - Return World->IsGameWorld()
       - Don't create in editor preview worlds

    AVOID: Do not use Tick. Do not store event state in actors. Do not ignore cleanup.
  </action>
  <verify>
    grep -l "BroadcastEvent" Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/Subsystems/GSDEventBusSubsystem.cpp
    grep -l "MatchesTag" Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/Subsystems/GSDEventBusSubsystem.cpp
    grep -l "ShouldCreateSubsystem" Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/Subsystems/GSDEventBusSubsystem.cpp
  </verify>
  <done>
    Event bus implementation complete. Hierarchical tag matching works. Proper logging and cleanup.
  </done>
</task>

</tasks>

<verification>
1. Subsystem compiles without errors
2. ShouldCreateSubsystem returns true only for game worlds
3. Hierarchical matching: Event.Daily listener receives Event.Daily.Construction broadcasts
4. Delegate handles can be used to unsubscribe
</verification>

<success_criteria>
- UGSDEventBusSubsystem exists as world subsystem
- Subscribe returns FGSDEventHandle for cleanup
- BroadcastEvent supports hierarchical tag matching
- Unsubscribe properly removes delegates
- Logging via GSDEVENT_LOG macros
</success_criteria>

<output>
After completion, create `.planning/phases/08-event-system-core/08-02-SUMMARY.md`
</output>
