---
phase: 03-streaming-data-layers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDDataLayerManager.h
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Subsystems/GSDDataLayerManager.cpp
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs
autonomous: true

must_haves:
  truths:
    - "User can toggle Data Layers at runtime via Blueprint or C++"
    - "Code can query which Data Layers are currently activated"
    - "System exposes all available runtime Data Layer names"
  artifacts:
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDDataLayerManager.h"
      provides: "Data Layer management API"
      min_lines: 40
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Subsystems/GSDDataLayerManager.cpp"
      provides: "Data Layer management implementation"
      min_lines: 60
  key_links:
    - from: "GSDDataLayerManager"
      to: "UDataLayerSubsystem"
      via: "GetWorld()->GetSubsystem<UDataLayerSubsystem>()"
      pattern: "GetSubsystem<UDataLayerSubsystem>"
---

<objective>
Create UGSDDataLayerManager world subsystem for runtime Data Layer control.

Purpose: Provides Blueprint-callable API for toggling and querying Data Layer states at runtime, enabling dynamic event content loading.

Output: GSDDataLayerManager subsystem with SetDataLayerState, IsDataLayerActivated, and GetRuntimeDataLayerNames functions.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-streaming-data-layers/03-RESEARCH.md

# Reference existing patterns
@Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Components/GSDStreamingSourceComponent.h
@Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDStreamingSourceTest.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSDDataLayerManager Header</name>
  <files>Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDDataLayerManager.h</files>
  <action>
Create the GSDDataLayerManager header file as a UWorldSubsystem.

Requirements:
1. Class must inherit from UWorldSubsystem
2. Add GSD_CITYSTREAMING_API export macro
3. Include CoreMinimal.h and Engine/DataLayer.h

Public interface (all Blueprint-callable):
- `SetDataLayerState(FName LayerName, bool bActivated)` - Toggle layer on/off
- `IsDataLayerActivated(FName LayerName) const` - Query layer state
- `GetRuntimeDataLayerNames() const` - Get all runtime layer names

Private helper:
- `GetDataLayerSubsystem() const` - Returns UDataLayerSubsystem pointer

Use this structure:
```cpp
#pragma once

#include "CoreMinimal.h"
#include "Subsystems/WorldSubsystem.h"
#include "Engine/DataLayer.h"
#include "GSDDataLayerManager.generated.h"

UCLASS()
class GSD_CITYSTREAMING_API UGSDDataLayerManager : public UWorldSubsystem
{
    GENERATED_BODY()

public:
    UFUNCTION(BlueprintCallable, Category = "GSD|DataLayers")
    void SetDataLayerState(FName LayerName, bool bActivated);

    UFUNCTION(BlueprintPure, Category = "GSD|DataLayers")
    bool IsDataLayerActivated(FName LayerName) const;

    UFUNCTION(BlueprintPure, Category = "GSD|DataLayers")
    TArray<FName> GetRuntimeDataLayerNames() const;

private:
    UDataLayerSubsystem* GetDataLayerSubsystem() const;
};
```
  </action>
  <verify>File exists at Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDDataLayerManager.h with UCLASS and GSD_CITYSTREAMING_API macros</verify>
  <done>Header file created with SetDataLayerState, IsDataLayerActivated, GetRuntimeDataLayerNames functions declared</done>
</task>

<task type="auto">
  <name>Task 2: Implement GSDDataLayerManager</name>
  <files>Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Subsystems/GSDDataLayerManager.cpp</files>
  <action>
Create the GSDDataLayerManager implementation file.

Implementation details:

1. Include headers:
   - "Subsystems/GSDDataLayerManager.h"
   - "Subsystems/DataLayerSubsystem.h"
   - "Engine/World.h"

2. SetDataLayerState implementation:
   - Get UDataLayerSubsystem via GetDataLayerSubsystem()
   - Use GetDataLayerInstanceFromName(LayerName) to get the layer
   - If layer exists, call SetDataLayerInstanceRuntimeState()
   - Map bool to EDataLayerRuntimeState: true = Activated, false = Unloaded

3. IsDataLayerActivated implementation:
   - Get UDataLayerSubsystem
   - Get layer by name
   - Compare state to EDataLayerRuntimeState::Activated
   - Return false if layer not found

4. GetRuntimeDataLayerNames implementation:
   - Get UDataLayerSubsystem
   - Iterate through GetDataLayerInstances()
   - Filter by Layer->IsRuntime()
   - Add Layer->GetFName() to result array

5. GetDataLayerSubsystem implementation:
   - Return GetWorld()->GetSubsystem<UDataLayerSubsystem>()

DO NOT add logging in this subsystem - keep it lean for runtime performance.
  </action>
  <verify>File exists and compiles without errors. Functions correctly delegate to UDataLayerSubsystem.</verify>
  <done>Implementation file created with all three public functions delegating to UDataLayerSubsystem</done>
</task>

<task type="auto">
  <name>Task 3: Update Build.cs Dependencies</name>
  <files>Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs</files>
  <action>
Update the Build.cs to ensure DataLayerSubsystem is available.

The DataLayerSubsystem is in the Engine module, which should already be included. Verify the PrivateDependencyModuleNames includes "Engine" and add any needed includes.

Read the current Build.cs first, then add "Engine" to PrivateDependencyModuleNames if not already present (it likely is since we use other Engine subsystems).
  </action>
  <verify>Build.cs compiles and plugin builds successfully</verify>
  <done>Build.cs updated with correct module dependencies</done>
</task>

</tasks>

<verification>
1. Plugin compiles without errors or warnings
2. GSDDataLayerManager.h exists with correct class declaration
3. GSDDataLayerManager.cpp implements all three public functions
4. All functions are Blueprint-callable (UFUNCTION with BlueprintCallable/BlueprintPure)
5. Code delegates correctly to UDataLayerSubsystem (no hand-rolled layer management)
</verification>

<success_criteria>
- [x] GSDDataLayerManager subsystem compiles and loads
- [x] SetDataLayerState toggles layers via UDataLayerSubsystem
- [x] IsDataLayerActivated queries layer state
- [x] GetRuntimeDataLayerNames returns available layers
- [x] All functions are Blueprint-accessible
</success_criteria>

<output>
After completion, create `.planning/phases/03-streaming-data-layers/03-01-SUMMARY.md`
</output>
