---
phase: 03-streaming-data-layers
plan: 03
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDStreamingTelemetry.h
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Subsystems/GSDStreamingTelemetry.cpp
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs
autonomous: true

must_haves:
  truths:
    - "Streaming cell load times are tracked in telemetry"
    - "Telemetry events include player position context"
    - "Average load time can be queried for performance monitoring"
  artifacts:
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDStreamingTelemetry.h"
      provides: "Streaming telemetry API and event structure"
      min_lines: 60
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Subsystems/GSDStreamingTelemetry.cpp"
      provides: "Telemetry implementation with World Partition hooks"
      min_lines: 80
  key_links:
    - from: "GSDStreamingTelemetry"
      to: "UWorldPartitionSubsystem"
      via: "OnWorldPartitionStreamingProgressUpdated delegate"
      pattern: "OnWorldPartitionStreamingProgressUpdated"
---

<objective>
Create UGSDStreamingTelemetry game instance subsystem to track streaming cell load times.

Purpose: Enables performance monitoring by capturing streaming events with context (player position, active layers). Data feeds into Phase 10 telemetry system.

Output: GSDStreamingTelemetry subsystem with event logging, delegate broadcasting, and average load time calculation.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-streaming-data-layers/03-RESEARCH.md

# Reference existing patterns
@Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Components/GSDStreamingSourceComponent.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSDStreamingTelemetry Header</name>
  <files>Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDStreamingTelemetry.h</files>
  <action>
Create the GSDStreamingTelemetry header file as a UGameInstanceSubsystem.

Requirements:
1. Class inherits from UGameInstanceSubsystem
2. Override Initialize() and Deinitialize()
3. Add GSD_CITYSTREAMING_API export macro

Create FGSDStreamingEvent struct (BlueprintType):
- FString CellName
- float LoadTimeMs
- FVector PlayerPosition
- float Timestamp

Create delegate:
- FOnStreamingEventLogged - broadcasts when events are logged

Public interface:
- OnStreamingEventLogged (delegate property)
- GetRecentEvents() const - returns TArray<FGSDStreamingEvent>
- GetAverageLoadTimeMs() const - calculates average from recent events

Private:
- OnStreamingProgressUpdated() - callback for World Partition events
- ProgressDelegateHandle - to track delegate binding
- RecentEvents - TArray<FGSDStreamingEvent>, max 100 events
- Static constexpr MaxRecentEvents = 100

Use this structure:
```cpp
#pragma once

#include "CoreMinimal.h"
#include "Subsystems/GameInstanceSubsystem.h"
#include "GSDStreamingTelemetry.generated.h"

USTRUCT(BlueprintType)
struct FGSDStreamingEvent
{
    GENERATED_BODY()

    UPROPERTY(BlueprintReadOnly)
    FString CellName;

    UPROPERTY(BlueprintReadOnly)
    float LoadTimeMs = 0.0f;

    UPROPERTY(BlueprintReadOnly)
    FVector PlayerPosition = FVector::ZeroVector;

    UPROPERTY(BlueprintReadOnly)
    float Timestamp = 0.0f;
};

DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnStreamingEventLogged, const FGSDStreamingEvent&, Event);

UCLASS()
class GSD_CITYSTREAMING_API UGSDStreamingTelemetry : public UGameInstanceSubsystem
{
    GENERATED_BODY()

public:
    virtual void Initialize(FSubsystemCollectionBase& Collection) override;
    virtual void Deinitialize() override;

    UPROPERTY(BlueprintAssignable, Category = "GSD|Telemetry")
    FOnStreamingEventLogged OnStreamingEventLogged;

    UFUNCTION(BlueprintPure, Category = "GSD|Telemetry")
    const TArray<FGSDStreamingEvent>& GetRecentEvents() const { return RecentEvents; }

    UFUNCTION(BlueprintPure, Category = "GSD|Telemetry")
    float GetAverageLoadTimeMs() const;

private:
    void OnStreamingProgressUpdated(UWorld* World);

    FDelegateHandle ProgressDelegateHandle;
    TArray<FGSDStreamingEvent> RecentEvents;
    static constexpr int32 MaxRecentEvents = 100;
};
```
  </action>
  <verify>File exists at Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDStreamingTelemetry.h with struct, delegate, and class</verify>
  <done>Header created with FGSDStreamingEvent struct, FOnStreamingEventLogged delegate, and UGSDStreamingTelemetry class</done>
</task>

<task type="auto">
  <name>Task 2: Implement GSDStreamingTelemetry</name>
  <files>Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Subsystems/GSDStreamingTelemetry.cpp</files>
  <action>
Create the GSDStreamingTelemetry implementation file.

Implementation details:

1. Include headers:
   - "Subsystems/GSDStreamingTelemetry.h"
   - "Engine/World.h"
   - "Engine/World.h"
   - "GameFramework/PlayerController.h"
   - "GameFramework/Pawn.h"

2. Initialize() implementation:
   - Call Super::Initialize()
   - Note: World Partition delegate binding is complex and version-dependent
   - For this phase, store a simple timer-based polling approach
   - Log initialization: UE_LOG(LogGSDCityStreaming, Log, TEXT("GSDStreamingTelemetry: Initialized"))

3. Deinitialize() implementation:
   - Clear any timers
   - Call Super::Deinitialize()

4. OnStreamingProgressUpdated() implementation:
   - Create FGSDStreamingEvent
   - Set Timestamp from GetWorld()->GetTimeSeconds()
   - Get player position from first player controller's pawn
   - Add event to RecentEvents
   - Trim array if > MaxRecentEvents (remove from start)
   - Broadcast OnStreamingEventLogged delegate

5. GetAverageLoadTimeMs() implementation:
   - Return 0.0f if RecentEvents empty
   - Sum LoadTimeMs values, divide by count
   - Return average

IMPORTANT: The actual World Partition streaming progress hook varies by UE5 version. For this implementation:
- Create a placeholder that logs events when manually triggered
- The full integration with OnWorldPartitionStreamingProgressUpdated will be refined in Phase 10
- Focus on the data structure and API being correct

Add a public method for testing:
```cpp
// For testing - manually log a streaming event
UFUNCTION(BlueprintCallable, Category = "GSD|Telemetry", meta = (DevelopmentOnly))
void LogStreamingEventForTest(const FString& CellName, float LoadTimeMs);
```

This allows unit tests to verify the telemetry system without requiring actual streaming.
  </action>
  <verify>File exists and compiles. GetAverageLoadTimeMs returns correct average. Events can be logged manually for testing.</verify>
  <done>Implementation complete with Initialize/Deinitialize, event logging, and average calculation</done>
</task>

<task type="auto">
  <name>Task 3: Update Build.cs for Telemetry Dependencies</name>
  <files>Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs</files>
  <action>
Verify the Build.cs has all required dependencies for the telemetry subsystem.

Required modules (should already be present):
- Engine (for World, PlayerController, Pawn)
- Core (for basic types)

Read current Build.cs and ensure PrivateDependencyModuleNames includes "Engine".

No additional modules needed beyond what GSD_CityStreaming already uses.
  </action>
  <verify>Plugin compiles without missing dependency errors</verify>
  <done>Build.cs verified with correct dependencies</done>
</task>

</tasks>

<verification>
1. Plugin compiles without errors
2. GSDStreamingTelemetry.h exists with struct, delegate, and class
3. GSDStreamingTelemetry.cpp implements all required methods
4. GetAverageLoadTimeMs() returns correct values
5. LogStreamingEventForTest() allows unit testing
6. OnStreamingEventLogged delegate can be bound
</verification>

<success_criteria>
- [x] GSDStreamingTelemetry subsystem compiles and loads
- [x] FGSDStreamingEvent struct contains CellName, LoadTimeMs, PlayerPosition, Timestamp
- [x] Events can be logged and retrieved
- [x] Average load time calculated correctly
- [x] Delegate broadcasts when events logged
</success_criteria>

<output>
After completion, create `.planning/phases/03-streaming-data-layers/03-03-SUMMARY.md`
</output>
