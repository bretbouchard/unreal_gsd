---
phase: 05-vehicle-advanced-features
plan: 02
type: execute
wave: 2
depends_on: []
files_modified:
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehiclePoolSubsystem.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehiclePoolSubsystem.cpp
autonomous: true

must_haves:
  truths:
    - "Vehicle pool subsystem can warm up pools with pre-spawned vehicles"
    - "AcquireVehicle returns a vehicle from pool or creates new one"
    - "ReleaseVehicle returns vehicle to pool with proper physics reset"
    - "Pooled vehicles are hidden and have collision disabled until acquired"
  artifacts:
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehiclePoolSubsystem.h"
      provides: "Vehicle pooling world subsystem"
      contains: "class.*GSDVehiclePoolSubsystem"
      exports: ["WarmUpPool", "AcquireVehicle", "ReleaseVehicle", "GetAvailableCount", "ClearAllPools"]
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehiclePoolSubsystem.cpp"
      provides: "Pool management implementation with physics reset"
  key_links:
    - from: "GSDVehiclePoolSubsystem"
      to: "AGSDVehiclePawn"
      via: "pool management"
      pattern: "AGSDVehiclePawn"
    - from: "ReleaseVehicle"
      to: "ResetVehicleForPool"
      via: "physics reset"
      pattern: "ResetVehicleForPool"
    - from: "ResetVehicleForPool"
      to: "RecreatePhysicsState"
      via: "physics body reset"
      pattern: "RecreatePhysicsState"
---

<objective>
Create a world subsystem for vehicle pooling that manages vehicle reuse with proper physics reset.

Purpose: Improve performance for spawn-heavy scenarios (traffic, AI vehicles) by reusing vehicle instances instead of spawning/destroying.
Output: UGSDVehiclePoolSubsystem with WarmUpPool, AcquireVehicle, ReleaseVehicle methods.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vehicle-advanced-features/05-RESEARCH.md

# Reference: Phase 4 subsystem pattern
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSDVehiclePoolSubsystem Header</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehiclePoolSubsystem.h
  </files>
  <action>
Create UGSDVehiclePoolSubsystem extending UWorldSubsystem with the following:

**Public Methods:**
- `WarmUpPool(UGSDVehicleConfig* Config, int32 PoolSize)` - Pre-spawn vehicles into pool
- `AcquireVehicle(UGSDVehicleConfig* Config, FVector Location, FRotator Rotation)` - Get vehicle from pool (creates new if empty)
- `ReleaseVehicle(AGSDVehiclePawn* Vehicle)` - Return vehicle to pool with reset
- `GetAvailableCount(UGSDVehicleConfig* Config) const` - Get count of available pooled vehicles
- `ClearAllPools()` - Clear all pooled vehicles
- `GetPoolStatistics(int32& OutTotalPooled, int32& OutTotalActive) const` - Get pool statistics for debugging

**Delegates:**
```cpp
/** Delegate for pool warmup completion */
DECLARE_DYNAMIC_DELEGATE_TwoParams(FOnPoolWarmupComplete, UGSDVehicleConfig*, Config, int32, PoolSize);
```

**Protected Overrides:**
- `ShouldCreateSubsystem(UWorld* World) const` - Return true for game worlds only (not PIE, not preview)

**Private Members:**
- `AvailablePools` - TMap<TObjectPtr<UGSDVehicleConfig>, TArray<TObjectPtr<AGSDVehiclePawn>>> for pool storage
- `ActiveVehicles` - TArray<TObjectPtr<AGSDVehiclePawn>> tracking currently in-use vehicles

**Private Helpers:**
- `ResetVehicleForPool(AGSDVehiclePawn* Vehicle)` - Reset physics state for pooling
- `CreateNewPooledVehicle(UGSDVehicleConfig* Config)` - Create and hide a new vehicle for pool

Include proper forward declarations and follow the exact structure from GSDVehicleSpawnerSubsystem.
  </action>
  <verify>
    grep -q "class.*GSDVehiclePoolSubsystem" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehiclePoolSubsystem.h
    grep -q "WarmUpPool" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehiclePoolSubsystem.h
    grep -q "AcquireVehicle" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehiclePoolSubsystem.h
    grep -q "ReleaseVehicle" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehiclePoolSubsystem.h
  </verify>
  <done>UGSDVehiclePoolSubsystem header exists with pool management methods and proper storage</done>
</task>

<task type="auto">
  <name>Task 2: Create GSDVehiclePoolSubsystem Implementation</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehiclePoolSubsystem.cpp
  </files>
  <action>
Implement UGSDVehiclePoolSubsystem with the following behaviors:

**WarmUpPool:**
1. Validate Config is not null
2. Get or create pool array from AvailablePools map
3. Calculate how many more vehicles needed: `int32 Needed = PoolSize - Pool.Num()`
4. If Needed <= 0, log and return (pool already has enough)
5. Call CreateNewPooledVehicle() for Needed iterations
6. Add each created vehicle to pool array

**AcquireVehicle:**
1. Validate Config is not null
2. Try to get from AvailablePools (Pop from array if available)
3. If pool empty, call CreateNewPooledVehicle()
4. If vehicle is null, return nullptr
5. Set actor location and rotation via SetActorLocationAndRotation()
6. SetActorHiddenInGame(false), SetActorEnableCollision(true)
7. Re-enable physics on mesh: SetSimulatePhysics(true), WakeAllRigidBodies()
8. Add to ActiveVehicles array
9. Return vehicle pointer

**ReleaseVehicle:**
1. Validate Vehicle is not null and has valid config via GetSpawnConfig()
2. Remove from ActiveVehicles array: `ActiveVehicles.Remove(Vehicle)`
3. Call ResetVehicleForPool(Vehicle)
4. Cast config: `UGSDVehicleConfig* Config = Cast<UGSDVehicleConfig>(Vehicle->GetSpawnConfig())`
5. If Config is valid:
   - Get pool array: `TArray<TObjectPtr<AGSDVehiclePawn>>& Pool = AvailablePools.FindOrAdd(Config)`
   - Add to pool: `Pool.Add(Vehicle)`
   - Log release

**ResetVehicleForPool (CRITICAL - follow research pattern exactly):**
1. Get mesh from vehicle (GetMesh())
2. SetSimulatePhysics(false) on mesh
3. SetAllPhysicsLinearVelocity(FVector::ZeroVector)
4. SetAllPhysicsAngularVelocityInDegrees(FVector::ZeroVector)
5. Reset vehicle movement component state (SetThrottleInput(0), SetSteeringInput(0), SetBrakeInput(1), SetHandbrakeInput(true))
6. Reset mesh relative transform:
```cpp
// Reset to standard vehicle mesh offset
// AWheeledVehiclePawn typically has mesh at (0, 0, 0) with rotation (0, -90, 0)
Mesh->SetRelativeLocation(FVector::ZeroVector);
Mesh->SetRelativeRotation(FRotator(0.f, -90.f, 0.f));
```
7. ResetAllBodiesSimulatePhysics() on mesh
8. **RecreatePhysicsState() on mesh** - This is critical for proper physics reset
9. SetActorHiddenInGame(true), SetActorEnableCollision(false)
10. Call Vehicle->ResetSpawnState()

**CreateNewPooledVehicle:**
1. Spawn AGSDVehiclePawn at zero location with SpawnParameters
2. Call SpawnFromConfig() with Config
3. Check if spawn succeeded - if not, destroy actor and return nullptr
4. Call ResetVehicleForPool() immediately to prepare for pooling
5. Return vehicle (or nullptr on failure)

**ClearAllPools:**
1. For each pool in AvailablePools:
   - For each vehicle in pool:
     - Vehicle->Destroy()
2. Empty AvailablePools map
3. For each vehicle in ActiveVehicles:
   - Vehicle->Destroy()
4. Empty ActiveVehicles array
5. Log clear count

**ShouldCreateSubsystem:**
Return true only for worlds that are game worlds (not editor preview, not PIE in certain cases). Check World->IsGameWorld().

Use LOG_GSDVEHICLES macro for logging. Log pool operations at Log level.
  </action>
  <verify>
    grep -q "RecreatePhysicsState" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehiclePoolSubsystem.cpp
    grep -q "ResetAllBodiesSimulatePhysics" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehiclePoolSubsystem.cpp
    grep -q "SetAllPhysicsLinearVelocity" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehiclePoolSubsystem.cpp
  </verify>
  <done>UGSDVehiclePoolSubsystem implementation with complete physics reset, pool warmup, acquire/release methods</done>
</task>

</tasks>

<verification>
- Plugin compiles with new subsystem
- WarmUpPool creates vehicles and stores in AvailablePools
- AcquireVehicle returns from pool or creates new
- ReleaseVehicle properly resets physics and returns to pool
- ResetVehicleForPool follows research pattern with RecreatePhysicsState()
- ShouldCreateSubsystem returns true only for game worlds
</verification>

<success_criteria>
- UGSDVehiclePoolSubsystem world subsystem exists
- Pool warmup creates hidden, collision-disabled vehicles
- Acquire activates vehicles with proper transform and physics
- Release resets physics completely (velocities, body states, transform)
- RecreatePhysicsState() called after reset for proper physics body sync
</success_criteria>

<output>
After completion, create `.planning/phases/05-vehicle-advanced-features/05-02-SUMMARY.md`
</output>
