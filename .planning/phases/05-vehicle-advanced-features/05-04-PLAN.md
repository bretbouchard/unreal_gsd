---
phase: 05-vehicle-advanced-features
plan: 04
type: execute
wave: 4
depends_on: ["05-01"]
files_modified:
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDAttachmentComponent.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDAttachmentComponent.cpp
autonomous: true

must_haves:
  truths:
    - "Attachment component can attach accessories to vehicle sockets"
    - "Attached accessories follow vehicle mesh via socket attachment"
    - "Attachments can be removed individually or all at once"
    - "Socket existence is validated before attachment"
  artifacts:
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDAttachmentComponent.h"
      provides: "Attachment management actor component"
      contains: "class.*GSDAttachmentComponent"
      exports: ["AttachAccessory", "RemoveAccessory", "GetAttachedAccessories", "RemoveAllAttachments"]
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDAttachmentComponent.cpp"
      provides: "Socket-based attachment implementation"
  key_links:
    - from: "GSDAttachmentComponent"
      to: "AGSDVehiclePawn"
      via: "vehicle owner"
      pattern: "AGSDVehiclePawn"
    - from: "AttachAccessory"
      to: "USkeletalMeshSocket"
      via: "socket attachment"
      pattern: "DoesSocketExist"
    - from: "AttachAccessory"
      to: "AttachToComponent"
      via: "attachment"
      pattern: "AttachToComponent"
---

<objective>
Create an attachment component that manages vehicle accessories via socket-based attachment.

Purpose: Enable vehicles to have attachable accessories (bumpers, plows, racks) that attach to skeletal mesh sockets.
Output: UGSDAttachmentComponent with socket-based attach/detach functionality.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vehicle-advanced-features/05-RESEARCH.md

# Reference: Data Asset from this phase
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDAttachmentConfig.h

# Reference: Vehicle pawn for mesh access
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Attachment Component Header</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDAttachmentComponent.h
  </files>
  <action>
Create UGSDAttachmentComponent extending UActorComponent with:

**Class Specifiers:**
- ClassGroup=(GSD)
- meta=(BlueprintSpawnableComponent)

**Public Methods:**
- `AttachAccessory(UGSDAttachmentConfig* Config)` - Attach an accessory, returns spawned actor or nullptr on failure
- `RemoveAccessory(UGSDAttachmentConfig* Config)` - Remove a specific attachment by config
- `GetAttachedAccessories() const` - Return const reference to attached accessories array
- `RemoveAllAttachments()` - Remove all attachments from vehicle

**Delegates:**
```cpp
/** Delegate for attachment added */
DECLARE_DYNAMIC_DELEGATE_TwoParams(FOnAttachmentAdded, AStaticMeshActor*, Attachment, UGSDAttachmentConfig*, Config);

/** Delegate for attachment removed */
DECLARE_DYNAMIC_DELEGATE_OneParam(FOnAttachmentRemoved, AStaticMeshActor*, Attachment);
```

**Private Members:**
- `AttachedAccessories` (TArray<TObjectPtr<AStaticMeshActor>>) - Track spawned attachment actors
- `AttachmentConfigMap` (TMap<TObjectPtr<AStaticMeshActor>, TObjectPtr<UGSDAttachmentConfig>>) - Map from actor to config for removal lookup
- `TotalAddedMass` (float, default 0.0f) - Track total mass added by attachments

**Private Helper:**
- `FindAccessoryByConfig(UGSDAttachmentConfig* Config)` - Find attachment actor by config (returns actor or nullptr)

Include forward declarations for UGSDAttachmentConfig and AStaticMeshActor.
  </action>
  <verify>
    grep -q "class.*GSDAttachmentComponent" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDAttachmentComponent.h
    grep -q "AttachAccessory" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDAttachmentComponent.h
    grep -q "RemoveAllAttachments" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDAttachmentComponent.h
  </verify>
  <done>UGSDAttachmentComponent header exists with attach/remove methods</done>
</task>

<task type="auto">
  <name>Task 2: Create Attachment Component Implementation</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDAttachmentComponent.cpp
  </files>
  <action>
Implement UGSDAttachmentComponent:

**AttachAccessory:**
1. Validate Config and GetOwner() are not null
2. Cast owner to AGSDVehiclePawn (return nullptr if fails)
3. Get vehicle mesh via VehicleOwner->GetMesh() (return nullptr if null)
4. Check socket exists via VehicleMesh->DoesSocketExist(Config->SocketName)
   - If not found, log error via GSD_VEHICLE_ERROR and return nullptr
5. Load attachment mesh via Config->AttachmentMesh.LoadSynchronous()
   - If fails, log error and return nullptr
6. Spawn AStaticMeshActor with FActorSpawnParameters (Owner = GetOwner())
7. Set mesh on spawned actor via GetStaticMeshComponent()->SetStaticMesh(Mesh)
8. Attach to socket: AttachmentActor->AttachToComponent(VehicleMesh, FAttachmentTransformRules::SnapToTargetNotIncludingScale, Config->SocketName)
9. Set collision based on Config->bHasCollision:
   - If true:
     - SetCollisionEnabled(ECollisionEnabled::QueryAndPhysics)
     - **Set collision to ignore vehicle and pawn channels**:
     ```cpp
     AttachmentActor->GetStaticMeshComponent()->SetCollisionResponseToChannel(ECC_Vehicle, ECR_Ignore);
     AttachmentActor->GetStaticMeshComponent()->SetCollisionResponseToChannel(ECC_Pawn, ECR_Ignore);
     ```
   - If false: SetCollisionEnabled(ECollisionEnabled::NoCollision)
10. If Config->AdditionalMass > 0:
    - Apply additional mass to vehicle root component:
    ```cpp
    if (UPrimitiveComponent* RootPrim = Cast<UPrimitiveComponent>(VehicleOwner->GetRootComponent()))
    {
        float CurrentMass = RootPrim->GetMass();
        RootPrim->SetMassOverrideInKg(NAME_None, CurrentMass + Config->AdditionalMass);
        TotalAddedMass += Config->AdditionalMass;
    }
    ```
11. Add to AttachedAccessories array
12. Add to AttachmentConfigMap: `AttachmentConfigMap.Add(AttachmentActor, Config)`
13. Log success via GSD_VEHICLE_LOG
14. Return attachment actor

**RemoveAccessory:**
1. Find actor via FindAccessoryByConfig(Config)
2. If found:
   - Get config from AttachmentConfigMap
   - If config has AdditionalMass > 0, subtract from vehicle mass:
     ```cpp
     if (Config->AdditionalMass > 0 && TotalAddedMass >= Config->AdditionalMass)
     {
         if (UPrimitiveComponent* RootPrim = Cast<UPrimitiveComponent>(VehicleOwner->GetRootComponent()))
         {
             float CurrentMass = RootPrim->GetMass();
             RootPrim->SetMassOverrideInKg(NAME_None, CurrentMass - Config->AdditionalMass);
             TotalAddedMass -= Config->AdditionalMass;
         }
     }
     ```
   - Remove from AttachmentConfigMap
   - Remove from AttachedAccessories
   - Destroy actor
   - Log removal

**RemoveAllAttachments:**
1. For each actor in AttachedAccessories:
   - Get config from AttachmentConfigMap
   - If config has AdditionalMass > 0, subtract from vehicle mass
   - Destroy actor
2. Empty AttachedAccessories array
3. Empty AttachmentConfigMap
4. Reset TotalAddedMass = 0.0f
5. Log removal count

**FindAccessoryByConfig:**
- Iterate AttachmentConfigMap
- Return actor if config matches
- Return nullptr if not found

IMPORTANT:
- Use FAttachmentTransformRules::SnapToTargetNotIncludingScale for proper socket attachment
- Validate socket exists BEFORE spawning actor (avoid orphaned actors)
- Log errors via GSD_VEHICLE_ERROR macro for debugging
  </action>
  <verify>
    grep -q "DoesSocketExist" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDAttachmentComponent.cpp
    grep -q "AttachToComponent" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDAttachmentComponent.cpp
    grep -q "SnapToTargetNotIncludingScale" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDAttachmentComponent.cpp
  </verify>
  <done>UGSDAttachmentComponent with socket validation, mesh attachment, and collision configuration</done>
</task>

</tasks>

<verification>
- Plugin compiles with new component
- AttachAccessory validates socket exists before spawning
- Attachments use SnapToTargetNotIncludingScale for proper socket alignment
- Collision is set based on config
- RemoveAccessory and RemoveAllAttachments destroy actors properly
- Error logging via GSD_VEHICLE_ERROR for missing sockets/meshes
</verification>

<success_criteria>
- UGSDAttachmentComponent is Blueprint-spawnable
- AttachAccessory spawns actor, attaches to socket, returns actor
- Socket validation prevents invalid attachments
- Collision settings applied from config
- RemoveAccessory destroys specific attachment
- RemoveAllAttachments destroys all attachments
</success_criteria>

<output>
After completion, create `.planning/phases/05-vehicle-advanced-features/05-04-SUMMARY.md`
</output>
