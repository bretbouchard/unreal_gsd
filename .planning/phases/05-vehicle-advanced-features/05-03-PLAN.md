---
phase: 05-vehicle-advanced-features
plan: 03
type: execute
wave: 3
depends_on: ["05-01"]
files_modified:
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDLaunchControlComponent.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDLaunchControlComponent.cpp
autonomous: true

must_haves:
  truths:
    - "Launch control component can be activated on a vehicle"
    - "Throttle ramps smoothly from initial limit to full over configured time"
    - "Traction control reduces torque when wheel slip exceeds threshold"
    - "Launch control can be deactivated to return to normal driving"
  artifacts:
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDLaunchControlComponent.h"
      provides: "Launch control actor component"
      contains: "class.*GSDLaunchControlComponent"
      exports: ["ActivateLaunchControl", "DeactivateLaunchControl", "IsLaunchControlActive"]
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDLaunchControlComponent.cpp"
      provides: "Launch control implementation with throttle ramp and traction control"
  key_links:
    - from: "GSDLaunchControlComponent"
      to: "UChaosWheeledVehicleMovementComponent"
      via: "vehicle physics control"
      pattern: "ChaosWheeledVehicleMovementComponent"
    - from: "ApplyTractionControl"
      to: "GetWheelStates"
      via: "wheel slip detection"
      pattern: "GetWheelStates"
    - from: "TickComponent"
      to: "ApplyThrottleRamp"
      via: "throttle interpolation"
      pattern: "ApplyThrottleRamp"
---

<objective>
Create a launch control component that provides throttle ramping and traction control for vehicle launches.

Purpose: Enable consistent, controlled vehicle launches for performance scenarios with torque curve ramping and wheel slip detection.
Output: UGSDLaunchControlComponent with throttle ramp and traction control implementation.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vehicle-advanced-features/05-RESEARCH.md

# Reference: Data Asset from this phase
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDLaunchControlConfig.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Launch Control Component Header</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDLaunchControlComponent.h
  </files>
  <action>
Create UGSDLaunchControlComponent extending UActorComponent with:

**Class Specifiers:**
- ClassGroup=(GSD)
- meta=(BlueprintSpawnableComponent)

**Constructor requirements:**
- Set PrimaryComponentTick.bCanEverTick = true
- Set PrimaryComponentTick.bStartWithTickEnabled = false (only tick when active)

**Public Methods:**
- `Initialize(UGSDLaunchControlConfig* InConfig, UChaosWheeledVehicleMovementComponent* InMovement)` - Set up config and movement reference
- `ActivateLaunchControl()` - Begin launch control sequence
- `DeactivateLaunchControl()` - End launch control, return to normal
- `IsLaunchControlActive() const` - Returns bLaunchControlActive

**Delegates:**
```cpp
/** Delegate for launch control completion */
DECLARE_DYNAMIC_DELEGATE(FOnLaunchControlComplete);

UPROPERTY(BlueprintAssignable, Category = "GSD|Launch Control")
FOnLaunchControlComplete OnLaunchControlComplete;
```

**Protected Overrides:**
- `TickComponent(float DeltaTime, ELevelTick TickType, FActorComponentTickFunction* ThisTickFunction)` - Process launch control each frame

**Protected Methods:**
- `ApplyThrottleRamp(float DeltaTime)` - Interpolate throttle from initial to full
- `ApplyTractionControl()` - Check wheel slip and reduce torque if needed
- `CalculateWheelSlip(int32 WheelIndex)` - Calculate slip ratio for a wheel

**Private Members:**
- `LaunchConfig` (TObjectPtr<UGSDLaunchControlConfig>)
- `VehicleMovement` (TObjectPtr<UChaosWheeledVehicleMovementComponent>)
- `bLaunchControlActive` (bool, default false)
- `CurrentThrottleTarget` (float, default 0.0f)
- `RampProgress` (float, default 0.0f)

Use proper forward declarations for config and movement component classes.
  </action>
  <verify>
    grep -q "class.*GSDLaunchControlComponent" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDLaunchControlComponent.h
    grep -q "ActivateLaunchControl" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDLaunchControlComponent.h
    grep -q "ApplyTractionControl" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDLaunchControlComponent.h
  </verify>
  <done>UGSDLaunchControlComponent header exists with activate/deactivate methods and tick-based control</done>
</task>

<task type="auto">
  <name>Task 2: Create Launch Control Component Implementation</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDLaunchControlComponent.cpp
  </files>
  <action>
Implement UGSDLaunchControlComponent:

**Initialize:**
- Store LaunchConfig and VehicleMovement pointers
- If VehicleMovement is null, log error and return early
- Log initialization via LOG_GSDVEHICLES

**ActivateLaunchControl:**
- Check LaunchConfig and VehicleMovement are valid
- Set bLaunchControlActive = true
- Reset RampProgress = 0.0f
- Set CurrentThrottleTarget = LaunchConfig->InitialThrottleLimit
- **SetComponentTickEnabled(true)** to start processing
- Log activation

**DeactivateLaunchControl:**
- Set bLaunchControlActive = false
- Reset CurrentThrottleTarget = 0.0f
- **SetComponentTickEnabled(false)** to stop processing
- Log deactivation

**TickComponent:**
1. Call Super::TickComponent
2. If not bLaunchControlActive or missing config/movement, return early
3. Call ApplyThrottleRamp(DeltaTime)
4. If LaunchConfig->bEnableTractionControl, call ApplyTractionControl()

**ApplyThrottleRamp:**
1. Increment RampProgress by DeltaTime / LaunchConfig->ThrottleRampTime
2. Clamp RampProgress to [0, 1]
3. Lerp from InitialThrottleLimit to 1.0 using RampProgress as alpha
4. Store in CurrentThrottleTarget
5. Call VehicleMovement->SetThrottleInput(CurrentThrottleTarget)

**ApplyTractionControl:**
1. Get wheel states array from VehicleMovement->GetWheelStates()
2. For each valid index (0 to WheelStates.Num() - 1):
   - Calculate slip via CalculateWheelSlip(i)
   - If slip > LaunchConfig->WheelSlipThreshold:
     - Calculate reduced torque: GetEngineTorque() * (1.0 - TorqueReductionFactor)
     - Call SetDriveTorque(i, ReducedTorque)

**CalculateWheelSlip(int32 WheelIndex):**
1. Get wheel state from GetWheelStates()[WheelIndex]
2. Get VehicleSpeed = VehicleMovement->GetForwardSpeed()
3. Get WheelSpeed = WheelState.AngularVelocity * WheelState.Radius
4. If VehicleSpeed is near zero (< 100.0f = 1 m/s threshold for meaningful slip):
   - Return FMath::Abs(WheelSpeed) > 100.0f ? 1.0f : 0.0f
5. Return FMath::Abs((WheelSpeed - VehicleSpeed) / VehicleSpeed)

IMPORTANT: Do NOT poll wheel states every tick if not active - only when launch control is active. The TickComponent early-return handles this.
  </action>
  <verify>
    grep -q "ApplyThrottleRamp" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDLaunchControlComponent.cpp
    grep -q "GetWheelStates" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDLaunchControlComponent.cpp
    grep -q "SetThrottleInput" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDLaunchControlComponent.cpp
  </verify>
  <done>UGSDLaunchControlComponent with throttle ramp interpolation and wheel slip-based traction control</done>
</task>

</tasks>

<verification>
- Plugin compiles with new component
- Initialize sets up config and movement references
- Activate/Deactivate toggle launch control state
- TickComponent applies throttle ramp and optional traction control
- ApplyThrottleRamp lerps from initial limit to full throttle
- ApplyTractionControl detects wheel slip and reduces torque
- CalculateWheelSlip computes slip ratio correctly
</verification>

<success_criteria>
- UGSDLaunchControlComponent is Blueprint-spawnable
- Throttle ramps from InitialThrottleLimit to 1.0 over ThrottleRampTime
- Traction control reduces torque when slip exceeds threshold
- Component only processes when launch control is active (no wasted cycles)
</success_criteria>

<output>
After completion, create `.planning/phases/05-vehicle-advanced-features/05-03-SUMMARY.md`
</output>
