---
phase: 05-vehicle-advanced-features
plan: 05
type: execute
wave: 5
depends_on: ["05-01", "05-02", "05-03", "05-04"]
files_modified:
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDVehicleConfig.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/DataAssets/GSDVehicleConfig.cpp
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
autonomous: true

must_haves:
  truths:
    - "GSDVehicleConfig can reference launch control, tuning presets, and attachments"
    - "GSDVehiclePawn has launch control and attachment components"
    - "Vehicle pawn can apply tuning presets at runtime"
    - "Vehicle spawner can use pooling for vehicle acquisition"
  artifacts:
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDVehicleConfig.h"
      provides: "Extended vehicle config with advanced features"
      contains: "LaunchControlConfig|TuningPresets|AvailableAttachments"
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h"
      provides: "Extended vehicle pawn with components and preset methods"
      contains: "LaunchControlComponent|AttachmentComponent|ApplyTuningPreset"
  key_links:
    - from: "GSDVehicleConfig"
      to: "GSDLaunchControlConfig"
      via: "config reference"
      pattern: "LaunchControlConfig"
    - from: "GSDVehiclePawn"
      to: "GSDLaunchControlComponent"
      via: "component ownership"
      pattern: "LaunchControlComponent"
    - from: "ApplyTuningPreset"
      to: "UChaosWheeledVehicleMovementComponent"
      via: "runtime tuning"
      pattern: "SteeringRatio|DragCoefficient"
    - from: "GSDVehicleSpawnerSubsystem"
      to: "GSDVehiclePoolSubsystem"
      via: "pool integration"
      pattern: "PoolSubsystem|SpawnVehicleFromPool"
---

<objective>
Extend GSDVehicleConfig with new config references and GSDVehiclePawn with launch control, attachment components, and tuning preset switching. Add pooling support to spawner subsystem.

Purpose: Integrate all Phase 5 components into the vehicle system, enabling launch control, pooling, presets, and attachments on vehicles.
Output: Extended GSDVehicleConfig, GSDVehiclePawn with new components and methods, spawner with pooling integration.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vehicle-advanced-features/05-RESEARCH.md

# Phase 5 components
@.planning/phases/05-vehicle-advanced-features/05-01-PLAN.md
@.planning/phases/05-vehicle-advanced-features/05-02-PLAN.md
@.planning/phases/05-vehicle-advanced-features/05-03-PLAN.md
@.planning/phases/05-vehicle-advanced-features/05-04-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend GSDVehicleConfig with New Config References</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDVehicleConfig.h
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/DataAssets/GSDVehicleConfig.cpp
  </files>
  <action>
Extend UGSDVehicleConfig with new properties (add after existing properties, before GENERATED_BODY comment closes):

**Add forward declarations before class:**
```cpp
class UGSDLaunchControlConfig;
class UGSDTuningPreset;
class UGSDAttachmentConfig;
```

**Add new category "Advanced Features" with:**
```cpp
//-- Advanced Features (Phase 5) --

/** Launch control configuration (optional) */
UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Advanced Features")
TObjectPtr<UGSDLaunchControlConfig> LaunchControlConfig;

/** Available tuning presets for this vehicle */
UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Advanced Features")
TArray<TObjectPtr<UGSDTuningPreset>> TuningPresets;

/** Available attachment points for this vehicle */
UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Advanced Features")
TArray<TSoftObjectPtr<UGSDAttachmentConfig>> AvailableAttachments;

/** Default attachments to spawn with vehicle */
UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Advanced Features")
TArray<TSoftObjectPtr<UGSDAttachmentConfig>> DefaultAttachments;
```

**Update ValidateConfig() in .cpp:**
- No additional validation needed (these are optional features)
- Existing validation for mesh/wheels remains unchanged

Include the new Data Asset headers in the .cpp file.
  </action>
  <verify>
    grep -q "LaunchControlConfig" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDVehicleConfig.h
    grep -q "TuningPresets" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDVehicleConfig.h
    grep -q "AvailableAttachments" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDVehicleConfig.h
  </verify>
  <done>GSDVehicleConfig extended with launch control, tuning presets, and attachment references</done>
</task>

<task type="auto">
  <name>Task 2: Extend GSDVehiclePawn with Components and Methods</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp
  </files>
  <action>
Extend AGSDVehiclePawn:

**Header additions:**

Add forward declarations:
```cpp
class UGSDLaunchControlComponent;
class UGSDAttachmentComponent;
class UGSDTuningPreset;
```

Add visible components after StreamingSource:
```cpp
/** Launch control component for throttle ramping and traction control */
UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "GSD|Vehicles")
TObjectPtr<UGSDLaunchControlComponent> LaunchControlComponent;

/** Attachment component for accessories */
UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "GSD|Vehicles")
TObjectPtr<UGSDAttachmentComponent> AttachmentComponent;
```

Add new public methods:
```cpp
//-- Tuning Presets --

/** Apply tuning preset at runtime */
UFUNCTION(BlueprintCallable, Category = "GSD|Vehicles")
void ApplyTuningPreset(UGSDTuningPreset* Preset);

/** Get currently active tuning preset */
UFUNCTION(BlueprintPure, Category = "GSD|Vehicles")
UGSDTuningPreset* GetActiveTuningPreset() const;

//-- Launch Control --

/** Activate launch control with config from VehicleConfig */
UFUNCTION(BlueprintCallable, Category = "GSD|Vehicles")
void ActivateLaunchControl();

/** Deactivate launch control */
UFUNCTION(BlueprintCallable, Category = "GSD|Vehicles")
void DeactivateLaunchControl();
```

Add private member:
```cpp
UPROPERTY()
TObjectPtr<UGSDTuningPreset> ActiveTuningPreset;
```

**Implementation additions:**

In constructor, create components:
```cpp
LaunchControlComponent = CreateDefaultSubobject<UGSDLaunchControlComponent>(TEXT("LaunchControlComponent"));
AttachmentComponent = CreateDefaultSubobject<UGSDAttachmentComponent>(TEXT("AttachmentComponent"));
```

In SpawnFromConfig(), after existing code, initialize launch control:
```cpp
// Initialize launch control from config
if (VehicleConfig && VehicleConfig->LaunchControlConfig && LaunchControlComponent)
{
    LaunchControlComponent->Initialize(VehicleConfig->LaunchControlConfig, GetVehicleMovement());
}

// Attach default attachments
if (VehicleConfig && AttachmentComponent)
{
    for (const auto& AttachmentPtr : VehicleConfig->DefaultAttachments)
    {
        if (UGSDAttachmentConfig* AttachmentConfig = AttachmentPtr.LoadSynchronous())
        {
            AttachmentComponent->AttachAccessory(AttachmentConfig);
        }
    }
}
```

Implement ApplyTuningPreset:
```cpp
void AGSDVehiclePawn::ApplyTuningPreset(UGSDTuningPreset* Preset)
{
    if (!Preset)
    {
        return;
    }

    UChaosWheeledVehicleMovementComponent* Movement = GetVehicleMovement();
    if (!Movement)
    {
        return;
    }

    // Apply steering ratio
    Movement->SteeringSetup.SteeringRatio = Preset->SteeringRatio;

    // Apply engine settings
    Movement->EngineSetup.MaxRPM = Preset->MaxRPM;

    // Apply drag
    Movement->DragCoefficient = Preset->DragCoefficient;

    // Apply mass multiplier
    if (UPrimitiveComponent* RootPrim = Cast<UPrimitiveComponent>(GetRootComponent()))
    {
        float BaseMass = VehicleConfig ? VehicleConfig->Mass : 1500.0f;
        RootPrim->SetMassOverrideInKg(NAME_None, BaseMass * Preset->MassMultiplier);
    }

    // Note: Suspension settings (Stiffness, Damping) and tire friction require
    // direct wheel instance access which is not exposed through WheelSetups.
    // These would require iterating wheel instances via GetWheel(i) if available,
    // or recreating the vehicle movement component. For now, only apply
    // movement-level settings (SteeringRatio, MaxRPM, DragCoefficient, Mass).

    ActiveTuningPreset = Preset;

    GSD_VEHICLE_LOG(Log, TEXT("Applied tuning preset '%s' to vehicle"), *Preset->GetName());
}
```

Implement GetActiveTuningPreset:
```cpp
UGSDTuningPreset* AGSDVehiclePawn::GetActiveTuningPreset() const
{
    return ActiveTuningPreset;
}
```

Implement ActivateLaunchControl/DeactivateLaunchControl (forward to LaunchControlComponent).
  </action>
  <verify>
    grep -q "LaunchControlComponent" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
    grep -q "AttachmentComponent" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
    grep -q "ApplyTuningPreset" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
  </verify>
  <done>GSDVehiclePawn extended with launch control, attachment components, and tuning preset methods</done>
</task>

<task type="auto">
  <name>Task 3: Add Pooling Support to GSDVehicleSpawnerSubsystem</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
  </files>
  <action>
Extend UGSDVehicleSpawnerSubsystem with pooling integration:

**Header additions:**

Add forward declaration:
```cpp
class UGSDVehiclePoolSubsystem;
```

Add new public methods after existing methods:
```cpp
//-- Pooling Support --

/** Spawn vehicle using pool if available, falls back to regular spawn */
UFUNCTION(BlueprintCallable, Category = "GSD|Vehicles")
AGSDVehiclePawn* SpawnVehicleFromPool(UGSDVehicleConfig* Config, FVector Location, FRotator Rotation);

/** Return vehicle to pool instead of destroying */
UFUNCTION(BlueprintCallable, Category = "GSD|Vehicles")
void ReturnVehicleToPool(AGSDVehiclePawn* Vehicle);
```

Add private member:
```cpp
UPROPERTY()
TObjectPtr<UGSDVehiclePoolSubsystem> PoolSubsystem;
```

**Implementation additions:**

In Initialize(), pool subsystem reference is obtained lazily (not guaranteed to be initialized yet):
```cpp
void UGSDVehicleSpawnerSubsystem::Initialize(FSubsystemCollectionBase& Collection)
{
    Super::Initialize(Collection);

    // Pool subsystem may not be initialized yet, get it lazily
    // PoolSubsystem will be retrieved on first use via GetPoolSubsystem()
}
```

Add private helper method to .h:
```cpp
/** Get pool subsystem lazily (handles initialization order) */
UGSDVehiclePoolSubsystem* GetPoolSubsystem();
```

Implement helper in .cpp:
```cpp
UGSDVehiclePoolSubsystem* UGSDVehicleSpawnerSubsystem::GetPoolSubsystem()
{
    if (!PoolSubsystem && GetWorld())
    {
        PoolSubsystem = GetWorld()->GetSubsystem<UGSDVehiclePoolSubsystem>();
    }
    return PoolSubsystem;
}
```

Implement SpawnVehicleFromPool:
```cpp
AGSDVehiclePawn* UGSDVehicleSpawnerSubsystem::SpawnVehicleFromPool(UGSDVehicleConfig* Config, FVector Location, FRotator Rotation)
{
    UGSDVehiclePoolSubsystem* Pool = GetPoolSubsystem();

    if (Pool)
    {
        AGSDVehiclePawn* Vehicle = Pool->AcquireVehicle(Config, Location, Rotation);
        if (Vehicle)
        {
            SpawnedVehicles.Add(Vehicle);
            return Vehicle;
        }
    }

    // Fallback to regular spawn if pool not available or failed
    return SpawnVehicle(Config, Location, Rotation);
}
```

Implement ReturnVehicleToPool:
```cpp
void UGSDVehicleSpawnerSubsystem::ReturnVehicleToPool(AGSDVehiclePawn* Vehicle)
{
    if (!Vehicle)
    {
        return;
    }

    // Remove from tracked vehicles
    SpawnedVehicles.Remove(Vehicle);

    UGSDVehiclePoolSubsystem* Pool = GetPoolSubsystem();

    if (Pool)
    {
        Pool->ReleaseVehicle(Vehicle);
    }
    else
    {
        // Fallback to despawn if pool not available
        DespawnVehicle(Vehicle);
    }
}
```

Include GSDVehiclePoolSubsystem.h in the .cpp file.
  </action>
  <verify>
    grep -q "SpawnVehicleFromPool" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
    grep -q "ReturnVehicleToPool" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
    grep -q "PoolSubsystem" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
  </verify>
  <done>GSDVehicleSpawnerSubsystem has pooling methods with fallback to regular spawn/despawn</done>
</task>

</tasks>

<verification>
- Plugin compiles with all extensions
- GSDVehicleConfig has new config references for launch control, presets, attachments
- GSDVehiclePawn creates launch control and attachment components in constructor
- ApplyTuningPreset modifies movement component settings
- SpawnFromConfig initializes launch control and attaches default attachments
- GSDVehicleSpawnerSubsystem can use pool for spawning and returning vehicles
- Fallback to regular spawn/despawn when pool unavailable
</verification>

<success_criteria>
- GSDVehicleConfig extended with LaunchControlConfig, TuningPresets, AvailableAttachments, DefaultAttachments
- GSDVehiclePawn has LaunchControlComponent and AttachmentComponent
- ApplyTuningPreset modifies steering ratio, drag, mass, max RPM
- ActivateLaunchControl/DeactivateLaunchControl forward to component
- GSDVehicleSpawnerSubsystem has SpawnVehicleFromPool and ReturnVehicleToPool
- Pool integration with fallback when pool subsystem unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/05-vehicle-advanced-features/05-05-SUMMARY.md`
</output>
