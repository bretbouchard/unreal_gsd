---
phase: 05-vehicle-advanced-features
plan: 06
type: execute
wave: 6
depends_on: ["05-01", "05-02", "05-05"]
files_modified:
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehicleTestbedActor.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehicleTestbedActor.cpp
autonomous: true

must_haves:
  truths:
    - "Testbed actor can spawn 50 randomized vehicles in a grid"
    - "Testbed tracks FPS and vehicle count for performance validation"
    - "Vehicles can be spawned using pooling for performance testing"
    - "Testbed provides respawn functionality for repeated testing"
  artifacts:
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehicleTestbedActor.h"
      provides: "Vehicle testbed actor for validation"
      contains: "class.*GSDVehicleTestbedActor"
      exports: ["SpawnTestVehicles", "DespawnTestVehicles", "RespawnTestVehicles", "GetCurrentFPS", "GetSpawnedVehicleCount"]
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehicleTestbedActor.cpp"
      provides: "Testbed implementation with pooling and FPS tracking"
  key_links:
    - from: "GSDVehicleTestbedActor"
      to: "GSDVehiclePoolSubsystem"
      via: "pool-based spawning"
      pattern: "AcquireVehicle"
    - from: "SpawnTestVehicles"
      to: "GSDVehicleConfig"
      via: "random config selection"
      pattern: "VehicleConfigs"
    - from: "Tick"
      to: "FPS calculation"
      via: "DeltaTime"
      pattern: "1.0f / DeltaTime"
---

<objective>
Create a vehicle testbed actor that spawns 50 randomized vehicles for validation and performance testing.

Purpose: Provide a dedicated test environment for vehicle system validation with performance metrics.
Output: AGSDVehicleTestbedActor with spawn/despawn/respawn functionality and FPS tracking.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vehicle-advanced-features/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vehicle Testbed Actor Header</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehicleTestbedActor.h
  </files>
  <action>
Create AGSDVehicleTestbedActor extending AActor with:

**Class Specifiers:**
- BlueprintType
- Blueprintable

**Configuration Properties (EditAnywhere, BlueprintReadWrite, Category = "Testbed"):**
- `VehicleConfigs` (TArray<TSoftObjectPtr<UGSDVehicleConfig>>) - Vehicle configs to randomly select from
- `NumVehiclesToSpawn` (int32, default 50, meta ClampMin=1, ClampMax=200) - Number of vehicles
- `SpawnAreaSize` (FVector, default 10000, 10000, 0) - Spawn area dimensions
- `bUsePooling` (bool, default true) - Whether to use vehicle pooling
- `PoolSizePerConfig` (int32, default 20) - Pool warmup size per config
- `bAutoSpawnOnBeginPlay` (bool, default false) - Auto-spawn on BeginPlay

**Action Methods (BlueprintCallable, Category = "Testbed"):**
- `SpawnTestVehicles()` - Spawn all test vehicles
- `DespawnTestVehicles()` - Despawn all test vehicles
- `RespawnTestVehicles()` - Respawn with new random positions

**Statistics Methods (BlueprintPure, Category = "Testbed"):**
- `GetCurrentFPS() const` - Get current FPS
- `GetSpawnedVehicleCount() const` - Get spawned vehicle count
- `GetAverageFrameTime() const` - Get average frame time over last 60 frames

**Protected Overrides:**
- `BeginPlay()` - Optional auto-spawn
- `Tick(float DeltaTime)` - FPS tracking

**Private Members:**
- `SpawnedVehicles` (TArray<TObjectPtr<AGSDVehiclePawn>>) - Track spawned vehicles
- `CurrentFPS` (float, default 0.0f)
- `FrameTimeHistory` (TArray<float>) - For averaging
- `MaxFrameTimeHistory` (int32, default 60) - Frames to average

Include proper forward declarations.
  </action>
  <verify>
    grep -q "class.*GSDVehicleTestbedActor" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehicleTestbedActor.h
    grep -q "SpawnTestVehicles" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehicleTestbedActor.h
    grep -q "GetCurrentFPS" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehicleTestbedActor.h
  </verify>
  <done>AGSDVehicleTestbedActor header exists with spawn/despawn methods and FPS tracking</done>
</task>

<task type="auto">
  <name>Task 2: Create Vehicle Testbed Actor Implementation</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehicleTestbedActor.cpp
  </files>
  <action>
Implement AGSDVehicleTestbedActor:

**Constructor:**
- PrimaryActorTick.bCanEverTick = true
- Set RootComponent to a USceneComponent

**BeginPlay:**
- Call Super::BeginPlay()
- If bAutoSpawnOnBeginPlay, call SpawnTestVehicles()

**Tick:**
1. Call Super::Tick(DeltaTime)
2. If DeltaTime > 0, calculate CurrentFPS = 1.0f / DeltaTime
3. Add DeltaTime to FrameTimeHistory
4. If history exceeds MaxFrameTimeHistory, remove oldest entry

**SpawnTestVehicles:**
1. If VehicleConfigs.Num() == 0, log error via GSD_VEHICLE_ERROR and return
2. Get PoolSubsystem from GetWorld()->GetSubsystem<UGSDVehiclePoolSubsystem>()
3. Get SpawnerSubsystem from GetWorld()->GetSubsystem<UGSDVehicleSpawnerSubsystem>()
4. If bUsePooling and PoolSubsystem:
   - For each config in VehicleConfigs:
     - Load config synchronously
     - Call PoolSubsystem->WarmUpPool(Config, PoolSizePerConfig)
5. For i from 0 to NumVehiclesToSpawn:
   - Random config index: FMath::RandRange(0, VehicleConfigs.Num() - 1)
   - Load config synchronously
   - Random position within SpawnAreaSize (centered on actor location)
   - Random rotation Yaw: FMath::RandRange(0.0f, 360.0f)
   - If bUsePooling and PoolSubsystem: AcquireVehicle()
   - Else if SpawnerSubsystem: SpawnVehicle()
   - If vehicle spawned, add to SpawnedVehicles
6. Log spawn count via GSD_VEHICLE_LOG

**DespawnTestVehicles:**
1. For each vehicle in SpawnedVehicles:
   - If PoolSubsystem and bUsePooling: ReleaseVehicle()
   - Else if SpawnerSubsystem: DespawnVehicle()
2. Empty SpawnedVehicles array
3. Log despawn count

**RespawnTestVehicles:**
1. Call DespawnTestVehicles()
2. Call SpawnTestVehicles()

**GetCurrentFPS:** return CurrentFPS

**GetSpawnedVehicleCount:** return SpawnedVehicles.Num()

**GetAverageFrameTime:**
1. If FrameTimeHistory empty, return 0.0f
2. Sum all entries in FrameTimeHistory
3. Return sum / count

Include headers for GSDVehiclePoolSubsystem, GSDVehicleSpawnerSubsystem, GSDVehicleConfig, GSDVehiclePawn.
  </action>
  <verify>
    grep -q "WarmUpPool" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehicleTestbedActor.cpp
    grep -q "AcquireVehicle" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehicleTestbedActor.cpp
    grep -q "1.0f / DeltaTime" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehicleTestbedActor.cpp
  </verify>
  <done>AGSDVehicleTestbedActor with pooling-based spawning, FPS tracking, and average frame time calculation</done>
</task>

</tasks>

<verification>
- Plugin compiles with new actor
- SpawnTestVehicles creates vehicles from random configs
- Pooling used when bUsePooling is true with pool warmup
- FPS calculated each tick from delta time
- Frame time history tracks last 60 frames for averaging
- DespawnTestVehicles returns vehicles to pool or despawns
- RespawnTestVehicles clears and respawns
</verification>

<success_criteria>
- AGSDVehicleTestbedActor is Blueprint-placeable
- Spawns 50 (configurable) vehicles in random positions
- Uses pooling when enabled for performance testing
- Tracks current FPS and average frame time
- Provides spawn/despawn/respawn for repeated testing
- Logs operations for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/05-vehicle-advanced-features/05-06-SUMMARY.md`
</output>
