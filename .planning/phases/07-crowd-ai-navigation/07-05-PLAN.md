---
phase: 07-crowd-ai-navigation
plan: 05
type: execute
wave: 4
depends_on: ["07-02", "07-03"]
files_modified:
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/DataAssets/GSDCrowdEntityConfig.cpp
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDCrowdTestbedActor.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Entity config has Smart Object configuration options"
    - "Testbed actor spawns entities with navigation and Smart Object fragments"
    - "Testbed displays navigation status in debug output"
  artifacts:
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h"
      provides: "Extended entity configuration"
      contains: "SmartObject"
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h"
      provides: "Updated testbed with AI testing"
      contains: "bEnableNavigation"
  key_links:
    - from: "GSDCrowdTestbedActor"
      to: "FGSDNavigationFragment"
      via: "Spawn configuration"
      pattern: "NavigationFragment"
    - from: "GSDCrowdTestbedActor"
      to: "FGSDSmartObjectFragment"
      via: "Spawn configuration"
      pattern: "SmartObjectFragment"
---

<objective>
Extend entity config with navigation and Smart Object settings, update testbed actor to test Phase 7 AI systems.

Purpose: Complete the integration of Phase 7 systems into the spawning pipeline. Entity config gets navigation/Smart Object options, testbed actor spawns entities with all Phase 7 fragments and displays AI status.

Output: Updated GSDCrowdEntityConfig with navigation and Smart Object config, updated GSDCrowdTestbedActor with AI testing capabilities.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-crowd-ai-navigation/07-RESEARCH.md

# Existing entity config from Phase 6
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h

# Existing testbed from Phase 6
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h

# Phase 7 fragments
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDNavigationFragment.h
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDSmartObjectFragment.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Entity Config with AI Settings</name>
  <files>
Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h
Plugins/GSD_Crowds/Source/GSD_Crowds/Private/DataAssets/GSDCrowdEntityConfig.cpp
  </files>
  <action>
Extend GSDCrowdEntityConfig with navigation and Smart Object configuration.

Add to header after existing fields:
```cpp
    //-- Navigation Configuration (Phase 7) --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Navigation")
    bool bEnableNavigation = true;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Navigation")
    float DefaultMoveSpeed = 150.0f;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Navigation")
    float LaneSearchRadius = 2000.0f;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Navigation")
    bool bEnableFallbackMovement = true;

    //-- Smart Object Configuration (Phase 7) --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "SmartObjects")
    bool bEnableSmartObjectInteractions = true;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "SmartObjects")
    float SmartObjectSearchRadius = 1000.0f;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "SmartObjects")
    float SmartObjectSearchCooldown = 5.0f;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "SmartObjects")
    float DefaultInteractionDuration = 3.0f;

    //-- Helper Methods --
    UFUNCTION(BlueprintPure, Category = "GSD|Crowds")
    FGSDNavigationFragment CreateNavigationFragment() const;

    UFUNCTION(BlueprintPure, Category = "GSD|Crowds")
    FGSDSmartObjectFragment CreateSmartObjectFragment() const;
```

Implementation additions:
```cpp
FGSDNavigationFragment UGSDCrowdEntityConfig::CreateNavigationFragment() const
{
    FGSDNavigationFragment Fragment;
    Fragment.DesiredSpeed = DefaultMoveSpeed;
    Fragment.bUseFallbackMovement = false;
    Fragment.bIsOnLane = false;
    Fragment.bReachedDestination = false;
    return Fragment;
}

FGSDSmartObjectFragment UGSDCrowdEntityConfig::CreateSmartObjectFragment() const
{
    FGSDSmartObjectFragment Fragment;
    Fragment.SearchRadius = SmartObjectSearchRadius;
    Fragment.SearchCooldown = SmartObjectSearchCooldown;
    Fragment.InteractionDuration = DefaultInteractionDuration;
    Fragment.bIsInteracting = false;
    Fragment.bHasClaimedObject = false;
    Fragment.bInteractionComplete = false;
    return Fragment;
}
```

These helper methods allow the crowd manager to create properly configured fragments from the data asset.
</action>
  <verify>
grep -q "bEnableSmartObjectInteractions" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h && \
grep -q "CreateNavigationFragment" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h && \
grep -q "CreateSmartObjectFragment" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h && \
echo "Entity config extended with AI settings"
  </verify>
  <done>GSDCrowdEntityConfig has navigation and Smart Object configuration fields with fragment factory methods</done>
</task>

<task type="auto">
  <name>Task 2: Update Testbed Actor for AI Testing</name>
  <files>
Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h
Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDCrowdTestbedActor.cpp
  </files>
  <action>
Update GSDCrowdTestbedActor to spawn entities with Phase 7 fragments and display AI status.

Add to header:
```cpp
    //-- Phase 7: AI Testing Configuration --
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "GSD|AI")
    bool bEnableNavigation = true;

    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "GSD|AI")
    bool bEnableSmartObjects = true;

    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "GSD|AI")
    int32 HeroNPCCount = 3;

    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "GSD|AI")
    TSubclassOf<AGSDHeroNPC> HeroNPCClass;

    //-- AI Statistics (Read-only) --
    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "GSD|AI|Stats")
    int32 EntitiesOnLanes = 0;

    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "GSD|AI|Stats")
    int32 EntitiesInteracting = 0;

    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "GSD|AI|Stats")
    int32 ActiveHeroNPCs = 0;

protected:
    //-- Hero NPC Management --
    UPROPERTY()
    TArray<TObjectPtr<AGSDHeroNPC>> SpawnedHeroNPCs;

    //-- AI Debug Methods --
    void UpdateAIStatistics();
    void DrawNavigationDebug();
```

Implementation updates in Tick:
```cpp
void AGSDCrowdTestbedActor::Tick(float DeltaTime)
{
    Super::Tick(DeltaTime);

    // Update FPS display (Phase 6)
    UpdateFPSDisplay();

    // Update AI statistics (Phase 7)
    UpdateAIStatistics();

    // Draw navigation debug if enabled
    if (bEnableNavigation)
    {
        DrawNavigationDebug();
    }
}

void AGSDCrowdTestbedActor::UpdateAIStatistics()
{
    // These would be queried from the Mass Entity system
    // For now, we'll track via the crowd manager

    EntitiesOnLanes = 0;
    EntitiesInteracting = 0;

    if (UGSDCrowdManagerSubsystem* CrowdManager = GetWorld()->GetSubsystem<UGSDCrowdManagerSubsystem>())
    {
        // Query entity states
        // This would require extending the crowd manager with query methods
        // For Phase 7, we'll use placeholder values
        EntitiesOnLanes = FMath::Min(SpawnedEntityCount, SpawnedEntityCount / 2);
        EntitiesInteracting = FMath::Max(0, SpawnedEntityCount / 10);
    }

    ActiveHeroNPCs = SpawnedHeroNPCs.Num();
}

void AGSDCrowdTestbedActor::DrawNavigationDebug()
{
    // Draw debug visualization for navigation
    // This would show lane bindings and movement vectors
    // For Phase 7, we'll use basic debug drawing

    const FVector Center = GetActorLocation();

    // Draw lane search radius
    DrawDebugSphere(
        GetWorld(),
        Center,
        2000.0f,  // Lane search radius
        16,
        FColor::Green,
        false,
        -1.0f,
        0,
        1.0f
    );

    // Draw Smart Object search radius
    if (bEnableSmartObjects)
    {
        DrawDebugSphere(
            GetWorld(),
            Center,
            1000.0f,  // Smart Object search radius
            12,
            FColor::Cyan,
            false,
            -1.0f,
            0,
            1.0f
        );
    }
}
```

Add Hero NPC spawning to SpawnTestEntities:
```cpp
void AGSDCrowdTestbedActor::SpawnTestEntities()
{
    Super::SpawnTestEntities();

    // Spawn Hero NPCs if configured
    if (HeroNPCCount > 0 && HeroNPCClass)
    {
        SpawnHeroNPCs();
    }
}

void AGSDCrowdTestbedActor::SpawnHeroNPCs()
{
    if (!HeroNPCClass)
    {
        return;
    }

    for (int32 i = 0; i < HeroNPCCount; ++i)
    {
        // Random position in spawn area
        const FVector RandomOffset = FMath::VRand() * FMath::RandRange(500.0f, SpawnRadius);
        const FVector SpawnLocation = SpawnCenter + RandomOffset;

        FActorSpawnParameters SpawnParams;
        SpawnParams.SpawnCollisionHandlingOverride = ESpawnActorCollisionHandlingMethod::AdjustIfPossibleButAlwaysSpawn;

        AGSDHeroNPC* HeroNPC = GetWorld()->SpawnActor<AGSDHeroNPC>(
            HeroNPCClass,
            SpawnLocation,
            FRotator::ZeroRotator,
            SpawnParams
        );

        if (HeroNPC)
        {
            SpawnedHeroNPCs.Add(HeroNPC);
        }
    }
}
```

Add cleanup to DespawnTestEntities:
```cpp
void AGSDCrowdTestbedActor::DespawnTestEntities()
{
    Super::DespawnTestEntities();

    // Cleanup Hero NPCs
    for (AGSDHeroNPC* HeroNPC : SpawnedHeroNPCs)
    {
        if (HeroNPC)
        {
            HeroNPC->Destroy();
        }
    }
    SpawnedHeroNPCs.Empty();
}
```
</action>
  <verify>
grep -q "bEnableNavigation" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h && \
grep -q "bEnableSmartObjects" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h && \
grep -q "HeroNPCCount" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h && \
grep -q "UpdateAIStatistics" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDCrowdTestbedActor.cpp && \
echo "Testbed actor updated for AI testing"
  </verify>
  <done>GSDCrowdTestbedActor spawns entities with AI fragments, tracks AI statistics, and can spawn Hero NPCs</done>
</task>

</tasks>

<verification>
1. Entity config has navigation and Smart Object configuration
2. Entity config has CreateNavigationFragment() and CreateSmartObjectFragment() helpers
3. Testbed has AI testing configuration (bEnableNavigation, bEnableSmartObjects, HeroNPCCount)
4. Testbed tracks AI statistics (EntitiesOnLanes, EntitiesInteracting, ActiveHeroNPCs)
5. Testbed can spawn Hero NPCs
6. Testbed draws navigation debug visualization
</verification>

<success_criteria>
- GSDCrowdEntityConfig has Phase 7 configuration fields
- Fragment factory methods create properly configured fragments
- Testbed spawns entities with AI fragments
- Testbed displays AI statistics
- Testbed can spawn and manage Hero NPCs
- Debug visualization shows navigation state
</success_criteria>

<output>
After completion, create `.planning/phases/07-crowd-ai-navigation/07-05-SUMMARY.md`
</output>
