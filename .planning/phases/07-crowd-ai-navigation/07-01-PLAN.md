---
phase: 07-crowd-ai-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/GSD_Crowds/Source/GSD_Crowds/GSD_Crowds.Build.cs
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDNavigationFragment.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Fragments/GSDNavigationFragment.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Build.cs includes all required AI module dependencies"
    - "Navigation fragment stores ZoneGraph lane reference and progress"
    - "Fragment compiles without errors"
  artifacts:
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/GSD_Crowds.Build.cs"
      provides: "Module dependencies for Phase 7"
      contains: "ZoneGraph"
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDNavigationFragment.h"
      provides: "ZoneGraph lane navigation data"
      exports: ["FGSDNavigationFragment"]
  key_links:
    - from: "GSDNavigationFragment.h"
      to: "ZoneGraph"
      via: "FZoneGraphLaneHandle"
      pattern: "FZoneGraphLaneHandle"
---

<objective>
Extend GSD_Crowds Build.cs with AI module dependencies and create navigation fragment for ZoneGraph-based crowd navigation.

Purpose: Establish foundation for intelligent crowd navigation using ZoneGraph lanes. The navigation fragment stores lane references and progress data that processors use to move entities along defined paths.

Output: Updated Build.cs with MassAI, ZoneGraph, MassMovement, StateTreeModule, SmartObjectsModule, AIModule, NavigationSystem dependencies; FGSDNavigationFragment for lane-based navigation.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-crowd-ai-navigation/07-RESEARCH.md
@.planning/phases/06-crowd-core-systems/06-02-SUMMARY.md

# Existing fragment pattern from Phase 6
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDZombieStateFragment.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Build.cs with AI Module Dependencies</name>
  <files>Plugins/GSD_Crowds/Source/GSD_Crowds/GSD_Crowds.Build.cs</files>
  <action>
Update GSD_Crowds.Build.cs to include all Phase 7 dependencies.

Move MassAI from PrivateDependencyModuleNames to PublicDependencyModuleNames and add:
- ZoneGraph (navigation lanes)
- MassMovement (movement along lanes)
- StateTreeModule (behavior control)
- SmartObjectsModule (interaction points)
- AIModule (Behavior Trees, AI Perception)
- NavigationSystem (NavMesh for hero NPCs)

Final PublicDependencyModuleNames should be:
```csharp
PublicDependencyModuleNames.AddRange(new string[] {
    "Core",
    "CoreUObject",
    "Engine",
    "GSD_Core",
    "GSD_CityStreaming",
    "MassEntity",
    "MassRepresentation",
    "MassSpawner",
    "MassLOD",
    "MassCommon",
    "MassAI",           // Moved from Private
    "ZoneGraph",        // NEW
    "MassMovement",     // NEW
    "StateTreeModule",  // NEW
    "SmartObjectsModule", // NEW
    "AIModule",         // NEW
    "NavigationSystem"  // NEW
});
```

Remove MassAI from PrivateDependencyModuleNames (no longer needed there).
  </action>
  <verify>
grep -q "ZoneGraph" Plugins/GSD_Crowds/Source/GSD_Crowds/GSD_Crowds.Build.cs && \
grep -q "SmartObjectsModule" Plugins/GSD_Crowds/Source/GSD_Crowds/GSD_Crowds.Build.cs && \
grep -q "AIModule" Plugins/GSD_Crowds/Source/GSD_Crowds/GSD_Crowds.Build.cs && \
echo "Build.cs updated correctly"
  </verify>
  <done>Build.cs contains all 7 new AI module dependencies in PublicDependencyModuleNames</done>
</task>

<task type="auto">
  <name>Task 2: Create Navigation Fragment for ZoneGraph</name>
  <files>
Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDNavigationFragment.h
Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Fragments/GSDNavigationFragment.cpp
  </files>
  <action>
Create FGSDNavigationFragment following the Phase 6 fragment pattern (GSDZombieStateFragment).

Header (Public/Fragments/GSDNavigationFragment.h):
```cpp
#pragma once

#include "CoreMinimal.h"
#include "MassEntity/Types/MassEntityTypes.h"
#include "ZoneGraph/ZoneGraphTypes.h"
#include "GSDNavigationFragment.generated.h"

/**
 * Navigation fragment storing ZoneGraph lane reference and progress.
 * Used by navigation processor to move entities along defined lanes.
 */
USTRUCT()
struct GSD_CROWDS_API FGSDNavigationFragment : public FMassFragment
{
    GENERATED_BODY()

    //-- Lane Reference --
    UPROPERTY()
    FZoneGraphLaneHandle CurrentLane;

    UPROPERTY()
    float LanePosition = 0.0f;  // Distance along lane

    UPROPERTY()
    uint8 bIsOnLane : 1;

    UPROPERTY()
    uint8 bReachedDestination : 1;

    //-- Target --
    UPROPERTY()
    FZoneGraphLaneHandle TargetLane;

    UPROPERTY()
    float TargetLanePosition = -1.0f;

    //-- Movement Config --
    UPROPERTY()
    float DesiredSpeed = 150.0f;

    //-- Fallback (when ZoneGraph unavailable) --
    UPROPERTY()
    FVector FallbackTargetLocation = FVector::ZeroVector;

    UPROPERTY()
    uint8 bUseFallbackMovement : 1;

    FGSDNavigationFragment()
        : bIsOnLane(false)
        , bReachedDestination(false)
        , bUseFallbackMovement(false)
    {}
};
```

Implementation (Private/Fragments/GSDNavigationFragment.cpp):
```cpp
#include "Fragments/GSDNavigationFragment.h"
// Header-only struct - no implementation needed
```

Include required headers:
- MassEntity/Types/MassEntityTypes.h for FMassFragment
- ZoneGraph/ZoneGraphTypes.h for FZoneGraphLaneHandle

Follow Phase 6 pattern: no UObject pointers, use bitfields for booleans, raw data only.
  </action>
  <verify>
test -f Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDNavigationFragment.h && \
test -f Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Fragments/GSDNavigationFragment.cpp && \
grep -q "FGSDNavigationFragment" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDNavigationFragment.h && \
grep -q "FZoneGraphLaneHandle" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Fragments/GSDNavigationFragment.h && \
echo "Navigation fragment created"
  </verify>
  <done>FGSDNavigationFragment struct exists with CurrentLane, LanePosition, TargetLane, DesiredSpeed, and fallback fields</done>
</task>

</tasks>

<verification>
1. Build.cs contains all 7 new module dependencies
2. Navigation fragment header exists and compiles
3. Fragment follows Phase 6 pattern (no UObject pointers, bitfields)
4. Includes FZoneGraphLaneHandle for lane reference
5. Has fallback movement fields for when ZoneGraph unavailable
</verification>

<success_criteria>
- Build.cs updated with ZoneGraph, MassMovement, StateTreeModule, SmartObjectsModule, AIModule, NavigationSystem
- FGSDNavigationFragment struct created with lane reference, position, target, and fallback fields
- Fragment follows established patterns from Phase 6
- Plugin compiles with new dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/07-crowd-ai-navigation/07-01-SUMMARY.md`
</output>
