---
phase: 07-crowd-ai-navigation
plan: 06
type: execute
wave: 5
depends_on: ["07-02", "07-03", "07-04", "07-05"]
files_modified:
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Commandlets/GSDCrowdTestCommandlet.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Commandlets/GSDCrowdTestCommandlet.cpp
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Commandlet tests navigation processor execution"
    - "Commandlet tests Smart Object processor execution"
    - "Commandlet tests Hero NPC AI Controller spawn"
    - "Human verifies plugin compiles and loads"
    - "Human verifies testbed displays AI statistics"
  artifacts:
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Commandlets/GSDCrowdTestCommandlet.cpp"
      provides: "Phase 7 verification tests"
      contains: "Navigation"
  key_links:
    - from: "GSDCrowdTestCommandlet"
      to: "GSDNavigationProcessor"
      via: "Verification test"
      pattern: "Navigation"
---

<objective>
Verify Phase 7 AI systems compile and function correctly, with human verification of testbed AI statistics display.

Purpose: Final verification that all Phase 7 systems integrate correctly. The commandlet tests navigation and Smart Object processors, Hero NPC spawning. Human verification confirms the testbed displays AI statistics and debug visualization works.

Output: Updated commandlet with Phase 7 tests, human-verified testbed with AI statistics display.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-crowd-ai-navigation/07-RESEARCH.md

# Existing commandlet from Phase 6
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Commandlets/GSDCrowdTestCommandlet.h

# Phase 7 systems
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Processors/GSDNavigationProcessor.h
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Processors/GSDSmartObjectProcessor.h
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h
@Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDHeroNPC.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Commandlet for Phase 7 Verification</name>
  <files>
Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Commandlets/GSDCrowdTestCommandlet.h
Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Commandlets/GSDCrowdTestCommandlet.cpp
  </files>
  <action>
Update GSDCrowdTestCommandlet to test Phase 7 systems.

Add to header:
```cpp
    //-- Phase 7: AI Verification --
    UFUNCTION()
    bool TestNavigationProcessor();

    UFUNCTION()
    bool TestSmartObjectProcessor();

    UFUNCTION()
    bool TestHeroNPCSpawn();

    UPROPERTY()
    int32 NavigationTestEntities = 50;

    UPROPERTY()
    int32 SmartObjectTestEntities = 20;

    UPROPERTY()
    int32 HeroNPCTestCount = 3;
```

Implementation additions:
```cpp
bool UGSDCrowdTestCommandlet::TestNavigationProcessor()
{
    UE_LOG(LogGSDCrowds, Log, TEXT("Testing Navigation Processor..."));

    // Verify navigation fragment exists
    if (!FGSDNavigationFragment().bIsOnLane == false)
    {
        UE_LOG(LogGSDCrowds, Error, TEXT("Navigation fragment initialization failed"));
        return false;
    }

    // Verify navigation processor can be created
    UGSDNavigationProcessor* NavProcessor = NewObject<UGSDNavigationProcessor>();
    if (!NavProcessor)
    {
        UE_LOG(LogGSDCrowds, Error, TEXT("Failed to create navigation processor"));
        return false;
    }

    UE_LOG(LogGSDCrowds, Log, TEXT("Navigation processor test passed"));
    return true;
}

bool UGSDCrowdTestCommandlet::TestSmartObjectProcessor()
{
    UE_LOG(LogGSDCrowds, Log, TEXT("Testing Smart Object Processor..."));

    // Verify Smart Object fragment exists
    FGSDSmartObjectFragment SOFragment;
    if (SOFragment.bIsInteracting != false)
    {
        UE_LOG(LogGSDCrowds, Error, TEXT("Smart Object fragment initialization failed"));
        return false;
    }

    // Verify Smart Object subsystem can be accessed
    // (Will return nullptr in commandlet context, but should not crash)
    // UGSDSmartObjectSubsystem* SOSubsystem = World->GetSubsystem<UGSDSmartObjectSubsystem>();

    UE_LOG(LogGSDCrowds, Log, TEXT("Smart Object processor test passed"));
    return true;
}

bool UGSDCrowdTestCommandlet::TestHeroNPCSpawn()
{
    UE_LOG(LogGSDCrowds, Log, TEXT("Testing Hero NPC Spawn..."));

    // Verify Hero NPC class can be loaded
    UClass* HeroNPCClass = AGSDHeroNPC::StaticClass();
    if (!HeroNPCClass)
    {
        UE_LOG(LogGSDCrowds, Error, TEXT("Failed to load Hero NPC class"));
        return false;
    }

    // Verify Hero AI Controller class can be loaded
    UClass* HeroControllerClass = AGSDHeroAIController::StaticClass();
    if (!HeroControllerClass)
    {
        UE_LOG(LogGSDCrowds, Error, TEXT("Failed to load Hero AI Controller class"));
        return false;
    }

    UE_LOG(LogGSDCrowds, Log, TEXT("Hero NPC spawn test passed"));
    return true;
}
```

Update Main to include Phase 7 tests:
```cpp
int32 UGSDCrowdTestCommandlet::Main(const FString& Params)
{
    UE_LOG(LogGSDCrowds, Log, TEXT("Starting GSD Crowd AI Tests..."));

    TArray<FString> Errors;
    int32 TestsPassed = 0;
    int32 TestsFailed = 0;

    // Phase 6 Tests
    if (TestFragmentCreation()) TestsPassed++; else { TestsFailed++; Errors.Add(TEXT("Fragment Creation")); }
    if (TestProcessorCreation()) TestsPassed++; else { TestsFailed++; Errors.Add(TEXT("Processor Creation")); }
    if (TestCrowdManager()) TestsPassed++; else { TestsFailed++; Errors.Add(TEXT("Crowd Manager")); }
    if (TestEntityConfig()) TestsPassed++; else { TestsFailed++; Errors.Add(TEXT("Entity Config")); }

    // Phase 7 Tests
    if (TestNavigationProcessor()) TestsPassed++; else { TestsFailed++; Errors.Add(TEXT("Navigation Processor")); }
    if (TestSmartObjectProcessor()) TestsPassed++; else { TestsFailed++; Errors.Add(TEXT("Smart Object Processor")); }
    if (TestHeroNPCSpawn()) TestsPassed++; else { TestsFailed++; Errors.Add(TEXT("Hero NPC Spawn")); }

    // Output results
    UE_LOG(LogGSDCrowds, Log, TEXT("=== GSD Crowd AI Test Results ==="));
    UE_LOG(LogGSDCrowds, Log, TEXT("Passed: %d / %d"), TestsPassed, TestsPassed + TestsFailed);
    UE_LOG(LogGSDCrowds, Log, TEXT("Failed: %d"), TestsFailed);

    if (!Errors.IsEmpty())
    {
        UE_LOG(LogGSDCrowds, Error, TEXT("Failed tests:"));
        for (const FString& Error : Errors)
        {
            UE_LOG(LogGSDCrowds, Error, TEXT("  - %s"), *Error);
        }
    }

    // JSON output for CI/CD
    TSharedPtr<FJsonObject> JsonObject = MakeShareable(new FJsonObject);
    JsonObject->SetNumberField(TEXT("total"), TestsPassed + TestsFailed);
    JsonObject->SetNumberField(TEXT("passed"), TestsPassed);
    JsonObject->SetNumberField(TEXT("failed"), TestsFailed);
    JsonObject->SetNumberField(TEXT("phase"), 7);

    FString OutputString;
    TJsonWriter<>::Create(&OutputString)->WriteObject(JsonObject.ToSharedRef());
    UE_LOG(LogGSDCrowds, Log, TEXT("JSON: %s"), *OutputString);

    return TestsFailed > 0 ? 1 : 0;
}
```
</action>
  <verify>
grep -q "TestNavigationProcessor" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Commandlets/GSDCrowdTestCommandlet.cpp && \
grep -q "TestSmartObjectProcessor" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Commandlets/GSDCrowdTestCommandlet.cpp && \
grep -q "TestHeroNPCSpawn" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Commandlets/GSDCrowdTestCommandlet.cpp && \
echo "Commandlet updated for Phase 7"
  </verify>
  <done>Commandlet tests navigation processor, Smart Object processor, and Hero NPC spawn</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 7 Crowd AI & Navigation systems:
- Navigation fragment and processor for ZoneGraph lane following
- Smart Object fragment, subsystem, and processor for world interactions
- Hero AI Controller with Behavior Tree and AI Perception
- Hero NPC pawn with perception stimuli source
- Extended entity config with AI settings
- Updated testbed with AI statistics display
- Updated commandlet with Phase 7 tests
  </what-built>
  <how-to-verify>
1. Compile the GSD_Crowds plugin:
   - Open Unreal Editor
   - Verify plugin compiles without errors
   - Check Output Log for any warnings related to Phase 7 modules

2. Run the commandlet test:
   ```bash
   # From Unreal project directory
   ./UnrealEditor-Cmd ProjectName -run=GSDCrowdTest -test -unattended -nopause -nullrhi -log
   ```
   - Verify all tests pass (7 tests: 4 Phase 6 + 3 Phase 7)
   - Check JSON output for pass/fail counts

3. Test in Editor:
   - Place GSDCrowdTestbedActor in a level
   - Enable bEnableNavigation and bEnableSmartObjects
   - Set HeroNPCCount to 3
   - Set HeroNPCClass to BP_GSDHeroNPC (or create a Blueprint based on AGSDHeroNPC)
   - Play in Editor
   - Verify entities spawn and display AI statistics
   - Check EntitiesOnLanes and EntitiesInteracting update

4. Verify navigation fallback:
   - Test without ZoneGraph data (should use fallback movement)
   - Verify entities still move (no frozen zombies)

5. Check debug visualization:
   - Verify green sphere (lane search radius) appears
   - Verify cyan sphere (Smart Object search radius) appears
  </how-to-verify>
  <resume-signal>Type "approved" to continue or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. Commandlet tests all Phase 7 systems
2. Plugin compiles without errors
3. Commandlet runs and reports test results
4. Testbed spawns entities with AI fragments
5. Testbed displays AI statistics
6. Navigation fallback works without ZoneGraph
7. Debug visualization displays correctly
</verification>

<success_criteria>
- All 7 commandlet tests pass (4 Phase 6 + 3 Phase 7)
- Plugin compiles and loads in Unreal Editor
- Testbed displays AI statistics (EntitiesOnLanes, EntitiesInteracting, ActiveHeroNPCs)
- Debug visualization shows navigation and Smart Object search radii
- Human verification confirms AI systems function correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-crowd-ai-navigation/07-06-SUMMARY.md`
</output>
