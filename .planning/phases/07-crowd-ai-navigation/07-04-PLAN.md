---
phase: 07-crowd-ai-navigation
plan: 04
type: execute
wave: 3
depends_on: ["07-01"]
files_modified:
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDHeroNPC.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDHeroNPC.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Hero NPC AI Controller uses Behavior Trees for decisions"
    - "Hero NPC AI Controller uses AI Perception for sensing"
    - "Hero NPC pawn has perception stimuli source component"
    - "Hero NPC implements IGSDSpawnable interface"
  artifacts:
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h"
      provides: "Hero NPC AI Controller with BT and Perception"
      exports: ["AGSDHeroAIController"]
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDHeroNPC.h"
      provides: "Hero NPC pawn for gameplay-critical NPCs"
      exports: ["AGSDHeroNPC"]
  key_links:
    - from: "GSDHeroAIController"
      to: "UBehaviorTree"
      via: "RunBehaviorTree()"
      pattern: "RunBehaviorTree"
    - from: "GSDHeroAIController"
      to: "UAIPerceptionComponent"
      via: "OnTargetPerceptionUpdated"
      pattern: "OnTargetPerceptionUpdated"
---

<objective>
Create Hero NPC system with Behavior Tree decision making and AI Perception for player detection.

Purpose: Implement gameplay-critical NPCs (quest-givers, bosses, important characters) using traditional AI patterns. Hero NPCs use Behavior Trees for complex decision making and AI Perception for sensing the player. This differs from crowd entities which use StateTree for performance.

Output: AGSDHeroAIController with BT and Perception, AGSDHeroNPC pawn implementing IGSDSpawnable.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-crowd-ai-navigation/07-RESEARCH.md

# IGSDSpawnable interface from Phase 1
@Plugins/GSD_Core/Source/GSD_Core/Public/Interfaces/GSDSpawnable.h

# Research patterns
See RESEARCH.md Pattern 4 for Hero NPC implementation
See RESEARCH.md Pitfall 3 for AI Perception setup
See RESEARCH.md Pitfall 5 for Behavior Tree startup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hero AI Controller</name>
  <files>
Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h
Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp
  </files>
  <action>
Create AGSDHeroAIController with Behavior Tree and AI Perception.

Header (Public/AI/GSDHeroAIController.h):
```cpp
#pragma once

#include "CoreMinimal.h"
#include "AIController.h"
#include "Perception/AIPerceptionComponent.h"
#include "Perception/AISenseConfig_Sight.h"
#include "Perception/AISenseConfig_Hearing.h"
#include "GSDHeroAIController.generated.h"

class UBehaviorTree;
class UBlackboardComponent;

/**
 * Hero NPC AI Controller with Behavior Tree and AI Perception.
 * Used for gameplay-critical NPCs that need complex decision making.
 */
UCLASS()
class GSD_CROWDS_API AGSDHeroAIController : public AAIController
{
    GENERATED_BODY()

public:
    AGSDHeroAIController();

    virtual void BeginPlay() override;
    virtual void OnPossess(APawn* InPawn) override;

    //-- Behavior Tree --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "AI|Behavior")
    TObjectPtr<UBehaviorTree> BehaviorTree;

    //-- AI Perception --
    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "AI|Perception")
    TObjectPtr<UAIPerceptionComponent> AIPerceptionComponent;

    //-- Sight Config --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "AI|Perception")
    TObjectPtr<UAISenseConfig_Sight> SightConfig;

    //-- Hearing Config --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "AI|Perception")
    TObjectPtr<UAISenseConfig_Hearing> HearingConfig;

    //-- Perception Event --
    UFUNCTION()
    void OnTargetPerceptionUpdated(AActor* Actor, FAIStimulus Stimulus);

    //-- Blackboard Key Names --
    static const FName TargetActorKey;
    static const FName TargetLocationKey;
    static const FName CanSeeTargetKey;
    static const FName LastKnownPositionKey;
    static const FName HeardNoiseKey;
    static const FName NoiseLocationKey;

protected:
    //-- Default Perception Settings --
    UPROPERTY(EditDefaultsOnly, Category = "AI|Perception")
    float DefaultSightRadius = 2000.0f;

    UPROPERTY(EditDefaultsOnly, Category = "AI|Perception")
    float DefaultLoseSightRadius = 2500.0f;

    UPROPERTY(EditDefaultsOnly, Category = "AI|Perception")
    float DefaultPeripheralVisionAngle = 90.0f;

    UPROPERTY(EditDefaultsOnly, Category = "AI|Perception")
    float DefaultHearingRange = 1500.0f;

    UPROPERTY(EditDefaultsOnly, Category = "AI|Perception")
    float DefaultStimulusMaxAge = 5.0f;
};
```

Implementation (Private/AI/GSDHeroAIController.cpp):
```cpp
#include "AI/GSDHeroAIController.h"
#include "BehaviorTree/BehaviorTree.h"
#include "BehaviorTree/BlackboardComponent.h"
#include "Perception/AISense_Sight.h"
#include "Perception/AISense_Hearing.h"

// Blackboard key names
const FName AGSDHeroAIController::TargetActorKey = FName("TargetActor");
const FName AGSDHeroAIController::TargetLocationKey = FName("TargetLocation");
const FName AGSDHeroAIController::CanSeeTargetKey = FName("CanSeeTarget");
const FName AGSDHeroAIController::LastKnownPositionKey = FName("LastKnownPosition");
const FName AGSDHeroAIController::HeardNoiseKey = FName("HeardNoise");
const FName AGSDHeroAIController::NoiseLocationKey = FName("NoiseLocation");

AGSDHeroAIController::AGSDHeroAIController()
{
    // Create perception component
    AIPerceptionComponent = CreateDefaultSubobject<UAIPerceptionComponent>(TEXT("AIPerception"));

    // Create sight config
    SightConfig = CreateDefaultSubobject<UAISenseConfig_Sight>(TEXT("SightConfig"));
    SightConfig->SightRadius = DefaultSightRadius;
    SightConfig->LoseSightRadius = DefaultLoseSightRadius;
    SightConfig->PeripheralVisionAngleDegrees = DefaultPeripheralVisionAngle;
    SightConfig->SetMaxAge(DefaultStimulusMaxAge);
    SightConfig->AutoSuccessRangeFromLastSeenLocation = 500.0f;
    SightConfig->DetectionByAffiliation.bDetectEnemies = true;
    SightConfig->DetectionByAffiliation.bDetectNeutrals = true;
    SightConfig->DetectionByAffiliation.bDetectFriendlies = false;

    // Create hearing config
    HearingConfig = CreateDefaultSubobject<UAISenseConfig_Hearing>(TEXT("HearingConfig"));
    HearingConfig->HearingRange = DefaultHearingRange;
    HearingConfig->SetMaxAge(3.0f);

    // Apply configs to perception
    AIPerceptionComponent->ConfigureSense(*SightConfig);
    AIPerceptionComponent->ConfigureSense(*HearingConfig);
    AIPerceptionComponent->SetDominantSense(SightConfig->GetSenseImplementation());

    // Bind perception delegate
    AIPerceptionComponent->OnTargetPerceptionUpdated.AddDynamic(
        this,
        &AGSDHeroAIController::OnTargetPerceptionUpdated
    );
}

void AGSDHeroAIController::BeginPlay()
{
    Super::BeginPlay();
}

void AGSDHeroAIController::OnPossess(APawn* InPawn)
{
    Super::OnPossess(InPawn);

    // CRITICAL: Must start Behavior Tree in OnPossess
    if (BehaviorTree)
    {
        // Use the BT's Blackboard asset
        UBlackboardComponent* BBComponent = nullptr;
        UseBlackboard(BehaviorTree->BlackboardAsset, BBComponent);

        if (BBComponent)
        {
            RunBehaviorTree(BehaviorTree);
        }
    }
}

void AGSDHeroAIController::OnTargetPerceptionUpdated(AActor* Actor, FAIStimulus Stimulus)
{
    if (!Actor)
    {
        return;
    }

    UBlackboardComponent* BB = GetBlackboardComponent();
    if (!BB)
    {
        return;
    }

    if (Stimulus.WasSuccessfullySensed())
    {
        // Actor detected
        if (Stimulus.Type == UAISense::GetSenseID<UAISense_Sight>())
        {
            // Sight detection
            BB->SetValueAsObject(TargetActorKey, Actor);
            BB->SetValueAsVector(TargetLocationKey, Stimulus.StimulusLocation);
            BB->SetValueAsBool(CanSeeTargetKey, true);
            BB->SetValueAsBool(HeardNoiseKey, false);
        }
        else if (Stimulus.Type == UAISense::GetSenseID<UAISense_Hearing>())
        {
            // Hearing detection
            BB->SetValueAsBool(HeardNoiseKey, true);
            BB->SetValueAsVector(NoiseLocationKey, Stimulus.StimulusLocation);
        }
    }
    else
    {
        // Lost perception
        if (Stimulus.Type == UAISense::GetSenseID<UAISense_Sight>())
        {
            BB->SetValueAsBool(CanSeeTargetKey, false);
            BB->SetValueAsVector(LastKnownPositionKey, Stimulus.StimulusLocation);
        }
    }
}
```

Key implementation details:
1. Sight and Hearing configs in constructor
2. RunBehaviorTree() called in OnPossess() (CRITICAL - see Pitfall 5)
3. OnTargetPerceptionUpdated handles sight/hearing stimuli
4. Blackboard keys for target tracking
</action>
  <verify>
test -f Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h && \
test -f Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp && \
grep -q "RunBehaviorTree" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp && \
grep -q "OnTargetPerceptionUpdated" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp && \
echo "Hero AI Controller created"
  </verify>
  <done>AGSDHeroAIController has Behavior Tree support, AI Perception with sight/hearing, and blackboard integration</done>
</task>

<task type="auto">
  <name>Task 2: Create Hero NPC Pawn</name>
  <files>
Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDHeroNPC.h
Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDHeroNPC.cpp
  </files>
  <action>
Create AGSDHeroNPC pawn with perception stimuli source for player detection.

Header (Public/Actors/GSDHeroNPC.h):
```cpp
#pragma once

#include "CoreMinimal.h"
#include "GameFramework/Pawn.h"
#include "Perception/AIPerceptionStimuliSourceComponent.h"
#include "Interfaces/GSDSpawnable.h"
#include "GSDHeroNPC.generated.h"

class UCapsuleComponent;
class USkeletalMeshComponent;
class UCharacterMovementComponent;
class UBehaviorTree;
class AGSDHeroAIController;

/**
 * Hero NPC pawn for gameplay-critical NPCs.
 * Uses Behavior Trees and AI Perception for intelligent behavior.
 * Implements IGSDSpawnable for GSD spawning integration.
 */
UCLASS()
class GSD_CROWDS_API AGSDHeroNPC : public APawn, public IGSDSpawnable
{
    GENERATED_BODY()

public:
    AGSDHeroNPC();

    virtual void BeginPlay() override;

    //-- IGSDSpawnable Interface --
    virtual void ApplySpawnConfig_Implementation(UGSDSpawnConfig* Config) override;
    virtual FTransform GetSpawnTransform_Implementation() override;

    //-- Components --
    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
    TObjectPtr<UCapsuleComponent> CapsuleComponent;

    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
    TObjectPtr<USkeletalMeshComponent> SkeletalMesh;

    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
    TObjectPtr<UCharacterMovementComponent> CharacterMovement;

    //-- AI Perception Stimuli Source --
    // Required for other NPCs to perceive this one
    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "AI")
    TObjectPtr<UAIPerceptionStimuliSourceComponent> PerceptionStimuliSource;

    //-- AI Configuration --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "AI")
    TObjectPtr<UBehaviorTree> BehaviorTree;

    //-- AI Controller Class --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "AI")
    TSubclassOf<AGSDHeroAIController> AIControllerClass;

protected:
    //-- Default Dimensions --
    UPROPERTY(EditDefaultsOnly, Category = "Physics")
    float DefaultCapsuleRadius = 34.0f;

    UPROPERTY(EditDefaultsOnly, Category = "Physics")
    float DefaultCapsuleHalfHeight = 88.0f;
};
```

Implementation (Private/Actors/GSDHeroNPC.cpp):
```cpp
#include "Actors/GSDHeroNPC.h"
#include "Components/CapsuleComponent.h"
#include "GameFramework/CharacterMovementComponent.h"
#include "Components/SkeletalMeshComponent.h"
#include "AI/GSDHeroAIController.h"
#include "Perception/AISense_Sight.h"
#include "Perception/AISense_Hearing.h"

AGSDHeroNPC::AGSDHeroNPC()
{
    // Enable tick
    PrimaryActorTick.bCanEverTick = false;

    // Create capsule component (root)
    CapsuleComponent = CreateDefaultSubobject<UCapsuleComponent>(TEXT("CapsuleComponent"));
    RootComponent = CapsuleComponent;
    CapsuleComponent->InitCapsuleSize(DefaultCapsuleRadius, DefaultCapsuleHalfHeight);
    CapsuleComponent->SetCollisionProfileName(TEXT("Pawn"));

    // Create skeletal mesh
    SkeletalMesh = CreateDefaultSubobject<USkeletalMeshComponent>(TEXT("SkeletalMesh"));
    SkeletalMesh->SetupAttachment(RootComponent);

    // Create character movement
    CharacterMovement = CreateDefaultSubobject<UCharacterMovementComponent>(TEXT("CharacterMovement"));
    CharacterMovement->UpdatedComponent = RootComponent;
    CharacterMovement->MaxWalkSpeed = 400.0f;

    // Create perception stimuli source (CRITICAL for being detected)
    PerceptionStimuliSource = CreateDefaultSubobject<UAIPerceptionStimuliSourceComponent>(
        TEXT("PerceptionStimuliSource")
    );

    // Register for sight and hearing senses
    PerceptionStimuliSource->RegisterForSense(UAISense_Sight::StaticClass());
    PerceptionStimuliSource->RegisterForSense(UAISense_Hearing::StaticClass());
    PerceptionStimuliSource->RegisterWithPerceptionSystem();

    // Set default AI controller
    AIControllerClass = AGSDHeroAIController::StaticClass();
    AutoPossessAI = EAutoPossessAI::PlacedInWorldOrSpawned;
}

void AGSDHeroNPC::BeginPlay()
{
    Super::BeginPlay();

    // Ensure stimuli source is registered
    if (PerceptionStimuliSource)
    {
        PerceptionStimuliSource->RegisterWithPerceptionSystem();
    }
}

void AGSDHeroNPC::ApplySpawnConfig_Implementation(UGSDSpawnConfig* Config)
{
    // Apply spawn config if provided
    // Hero NPCs may have custom spawn configs for behavior, appearance, etc.
    if (!Config)
    {
        return;
    }

    // Config application logic here
    // Example: SetBehaviorTree, SetAppearance, etc.
}

FTransform AGSDHeroNPC::GetSpawnTransform_Implementation()
{
    return GetActorTransform();
}
```

Key implementation details:
1. UAIPerceptionStimuliSourceComponent for being detected (CRITICAL - see Pitfall 3)
2. RegisterForSense for sight and hearing
3. AutoPossessAI set to spawn AI controller automatically
4. IGSDSpawnable implementation for GSD spawning integration
5. Capsule + SkeletalMesh + CharacterMovement for pawn physics
</action>
  <verify>
test -f Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDHeroNPC.h && \
test -f Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDHeroNPC.cpp && \
grep -q "UAIPerceptionStimuliSourceComponent" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDHeroNPC.h && \
grep -q "IGSDSpawnable" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDHeroNPC.h && \
grep -q "RegisterWithPerceptionSystem" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDHeroNPC.cpp && \
echo "Hero NPC pawn created"
  </verify>
  <done>AGSDHeroNPC has perception stimuli source, implements IGSDSpawnable, and auto-possesses AI controller</done>
</task>

</tasks>

<verification>
1. Hero AI Controller has Behavior Tree support
2. Hero AI Controller has AI Perception with sight and hearing
3. RunBehaviorTree called in OnPossess
4. Hero NPC has perception stimuli source component
5. Hero NPC implements IGSDSpawnable interface
6. Hero NPC auto-possesses AI controller
</verification>

<success_criteria>
- AGSDHeroAIController with BT and Perception
- AGSDHeroNPC with stimuli source and IGSDSpawnable
- Sight/hearing configs properly set up
- Blackboard keys defined for target tracking
- OnTargetPerceptionUpdated updates blackboard
</success_criteria>

<output>
After completion, create `.planning/phases/07-crowd-ai-navigation/07-04-SUMMARY.md`
</output>
