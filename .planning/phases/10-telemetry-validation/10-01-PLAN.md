---
phase: 10-telemetry-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/GSD_Telemetry/GSD_Telemetry.uplugin
  - Plugins/GSD_Telemetry/Resources/Icon128.png
  - Plugins/GSD_Telemetry/Source/GSD_Telemetry/GSD_Telemetry.Build.cs
  - Plugins/GSD_Telemetry/Source/GSD_Telemetry/Private/GSD_Telemetry.cpp
  - Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSD_Telemetry.h
  - Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSDTelemetryLog.h
  - Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSDTelemetryStats.h
  - Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/Types/GSDTelemetryTypes.h
autonomous: true
must_haves:
  truths:
    - "GSD_Telemetry plugin compiles and loads in Unreal Editor"
    - "Log category LogGSDTelemetry is accessible for logging"
    - "Stats group STATGROUP_GSDTelemetry is declared"
    - "Telemetry types (FGSDFrameTimeHistory) are defined"
  artifacts:
    - path: "Plugins/GSD_Telemetry/GSD_Telemetry.uplugin"
      provides: "Plugin manifest"
      contains: "Name=GSD_Telemetry"
    - path: "Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSDTelemetryLog.h"
      provides: "Log category declaration"
      contains: "DECLARE_LOG_CATEGORY_EXTERN"
    - path: "Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSDTelemetryStats.h"
      provides: "Stats declarations"
      contains: "DECLARE_STATS_GROUP"
    - path: "Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/Types/GSDTelemetryTypes.h"
      provides: "Telemetry data structures"
      contains: "USTRUCT(BlueprintType)"
  key_links:
    - from: "GSDTelemetryLog.h"
      to: "GSD_Telemetry.cpp"
      via: "DEFINE_LOG_CATEGORY"
      pattern: "DEFINE_LOG_CATEGORY\\(LogGSDTelemetry\\)"
---

<objective>
Create GSD_Telemetry plugin foundation with logging infrastructure and telemetry types.

Purpose: Establish the telemetry plugin that provides performance monitoring, metrics collection, and observability for all GSD systems.
Output: Compiled plugin with log category, stats declarations, and telemetry data structures.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-telemetry-validation/10-RESEARCH.md

# Reference existing plugin patterns
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/GSD_Vehicles.Build.cs
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/GSDVehiclesLog.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSD_Telemetry Plugin Structure</name>
  <files>
    Plugins/GSD_Telemetry/GSD_Telemetry.uplugin
    Plugins/GSD_Telemetry/Resources/Icon128.png
    Plugins/GSD_Telemetry/Source/GSD_Telemetry/GSD_Telemetry.Build.cs
    Plugins/GSD_Telemetry/Source/GSD_Telemetry/Private/GSD_Telemetry.cpp
    Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSD_Telemetry.h
  </files>
  <action>
Create the GSD_Telemetry plugin structure following the established pattern from GSD_Vehicles and GSD_Crowds plugins.

**Plugin Manifest (GSD_Telemetry.uplugin):**
```json
{
  "FileVersion": 3,
  "Version": 1,
  "VersionName": "1.0",
  "FriendlyName": "GSD Telemetry",
  "Description": "Performance monitoring, metrics collection, and observability for GSD Platform",
  "Category": "GSD",
  "CreatedBy": "Bret Bouchard",
  "CreatedByURL": "",
  "DocsURL": "",
  "MarketplaceURL": "",
  "SupportURL": "",
  "CanContainContent": false,
  "IsBetaVersion": false,
  "IsExperimentalVersion": false,
  "Installed": false,
  "Modules": [
    {
      "Name": "GSD_Telemetry",
      "Type": "Runtime",
      "LoadingPhase": "Default"
    }
  ]
}
```

**Build.cs Dependencies:**
```csharp
PublicDependencyModuleNames.AddRange(new string[] {
    "Core", "CoreUObject", "Engine", "Json", "JsonUtilities"
});

PrivateDependencyModuleNames.AddRange(new string[] {
    "GSD_Core"
});
```

**Module Class (GSD_Telemetry.h):**
```cpp
class GSD_TELEMETRY_API FGSD_TelemetryModule : public IModuleInterface
{
public:
    virtual void StartupModule() override;
    virtual void ShutdownModule() override;
};
```

**Module Implementation (GSD_Telemetry.cpp):**
```cpp
#include "GSD_Telemetry.h"
#include "GSDTelemetryLog.h"

#define LOCTEXT_NAMESPACE "FGSD_TelemetryModule"

void FGSD_TelemetryModule::StartupModule()
{
    GSDTELEMETRY_LOG(Log, TEXT("GSD_Telemetry module starting up..."));
}

void FGSD_TelemetryModule::ShutdownModule()
{
    GSDTELEMETRY_LOG(Log, TEXT("GSD_Telemetry module shutting down..."));
}

#undef LOCTEXT_NAMESPACE

IMPLEMENT_MODULE(FGSD_TelemetryModule, GSD_Telemetry)
```

**Important:**
- Use "GSD_Telemetry" as module name (not "GSDTelemetry")
- Include GSD_Core in PrivateDependencyModuleNames for interface access
- Set LoadingPhase to "Default" (telemetry loads after core systems)
- Create empty 128x128 PNG for Icon128.png (placeholder)
</action>
  <verify>
    ```bash
    # Verify plugin structure exists
    test -f Plugins/GSD_Telemetry/GSD_Telemetry.uplugin && echo "Plugin manifest exists" || echo "ERROR: Plugin manifest missing"

    # Verify Build.cs
    test -f Plugins/GSD_Telemetry/Source/GSD_Telemetry/GSD_Telemetry.Build.cs && echo "Build.cs exists" || echo "ERROR: Build.cs missing"

    # Verify module files
    test -f Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSD_Telemetry.h && echo "Header exists" || echo "ERROR: Header missing"
    test -f Plugins/GSD_Telemetry/Source/GSD_Telemetry/Private/GSD_Telemetry.cpp && echo "Implementation exists" || echo "ERROR: Implementation missing"
    ```
  </verify>
  <done>
Plugin structure created with:
- GSD_Telemetry.uplugin manifest with correct module configuration
- GSD_Telemetry.Build.cs with Json, JsonUtilities, and GSD_Core dependencies
- Module class FGSD_TelemetryModule with startup/shutdown logging
- All required directories and placeholder icon
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Logging and Stats Infrastructure</name>
  <files>
    Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSDTelemetryLog.h
    Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSDTelemetryStats.h
    Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/Types/GSDTelemetryTypes.h
  </files>
  <action>
Create log category, stats declarations, and telemetry data structures following established patterns.

**GSDTelemetryLog.h:**
```cpp
#pragma once

#include "CoreMinimal.h"

GSD_TELEMETRY_API DECLARE_LOG_CATEGORY_EXTERN(LogGSDTelemetry, Log, All);

// Convenience macros for telemetry logging
#define GSDTELEMETRY_LOG(Verbosity, Format, ...) \
    UE_LOG(LogGSDTelemetry, Verbosity, Format, ##__VA_ARGS__)

#define GSDTELEMETRY_WARN(Format, ...) \
    UE_LOG(LogGSDTelemetry, Warning, Format, ##__VA_ARGS__)

#define GSDTELEMETRY_ERROR(Format, ...) \
    UE_LOG(LogGSDTelemetry, Error, Format, ##__VA_ARGS__)

#define GSDTELEMETRY_VERBOSE(Format, ...) \
    UE_LOG(LogGSDTelemetry, Verbose, Format, ##__VA_ARGS__)
```

**GSDTelemetryStats.h:**
```cpp
#pragma once

#include "CoreMinimal.h"

// Declare stats group for telemetry
DECLARE_STATS_GROUP(TEXT("GSD Telemetry"), STATGROUP_GSDTelemetry, STATCAT_Advanced);

// Performance tracking stats
DECLARE_CYCLE_STAT(TEXT("RecordFrameTime"), STAT_GSDRecordFrameTime, STATGROUP_GSDTelemetry);
DECLARE_CYCLE_STAT(TEXT("RecordHitch"), STAT_GSDRecordHitch, STATGROUP_GSDTelemetry);
DECLARE_CYCLE_STAT(TEXT("CountActors"), STAT_GSDCountActors, STATGROUP_GSDTelemetry);
DECLARE_CYCLE_STAT(TEXT("RecordCellLoadTime"), STAT_GSDRecordCellLoadTime, STATGROUP_GSDTelemetry);

// Counter stats
DECLARE_DWORD_COUNTER_STAT(TEXT("TotalFrameCount"), STAT_GSDTotalFrameCount, STATGROUP_GSDTelemetry);
DECLARE_DWORD_COUNTER_STAT(TEXT("TotalHitchCount"), STAT_GSDTotalHitchCount, STATGROUP_GSDTelemetry);
DECLARE_DWORD_COUNTER_STAT(TEXT("VehicleCount"), STAT_GSDVehicleCount, STATGROUP_GSDTelemetry);
DECLARE_DWORD_COUNTER_STAT(TEXT("ZombieCount"), STAT_GSDZombieCount, STATGROUP_GSDTelemetry);
DECLARE_DWORD_COUNTER_STAT(TEXT("HumanCount"), STAT_GSDHumanCount, STATGROUP_GSDTelemetry);
```

**GSDTelemetryTypes.h:**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "GSDTelemetryTypes.generated.h"

/**
 * Circular buffer for frame time history with O(1) averaging
 * Based on Phase 6 pattern from GSDStreamingTelemetry
 */
USTRUCT(BlueprintType)
struct FGSDFrameTimeHistory
{
    GENERATED_BODY()

    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Telemetry")
    TArray<float> FrameTimes;

    int32 WriteIndex = 0;
    float TotalTime = 0.0f;

    void AddFrameTime(float TimeMs)
    {
        if (FrameTimes.Num() < MaxSize)
        {
            FrameTimes.Add(TimeMs);
            TotalTime += TimeMs;
        }
        else
        {
            // Circular buffer: overwrite oldest
            TotalTime -= FrameTimes[WriteIndex];
            FrameTimes[WriteIndex] = TimeMs;
            TotalTime += TimeMs;
            WriteIndex = (WriteIndex + 1) % MaxSize;
        }
    }

    float GetAverageMs() const
    {
        return FrameTimes.Num() > 0 ? TotalTime / FrameTimes.Num() : 0.0f;
    }

    int32 GetSampleCount() const { return FrameTimes.Num(); }

    void Reset()
    {
        FrameTimes.Empty();
        WriteIndex = 0;
        TotalTime = 0.0f;
    }

    static constexpr int32 MaxSize = 60;  // 60 frame history for 1-second average at 60fps
};

/**
 * Hitch event recorded when frame time exceeds threshold
 */
USTRUCT(BlueprintType)
struct FGSDHitchEvent
{
    GENERATED_BODY()

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    float HitchTimeMs = 0.0f;

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    FName DistrictName;

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    double Timestamp = 0.0;
};

/**
 * Actor count snapshot for periodic logging
 */
USTRUCT(BlueprintType)
struct FGSDActorCountSnapshot
{
    GENERATED_BODY()

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    int32 VehicleCount = 0;

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    int32 ZombieCount = 0;

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    int32 HumanCount = 0;

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    double Timestamp = 0.0;
};

/**
 * Streaming cell load time record
 */
USTRUCT(BlueprintType)
struct FGSDCellLoadTimeRecord
{
    GENERATED_BODY()

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    FName CellName;

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    float LoadTimeMs = 0.0f;

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    FName DistrictName;

    UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = "Telemetry")
    double Timestamp = 0.0;
};
```

**Important:**
- Use DECLARE_LOG_CATEGORY_EXTERN in header, DEFINE_LOG_CATEGORY in cpp
- Stats use STATGROUP_GSDTelemetry for organization
- Circular buffer uses 60-frame history (matches Phase 6 pattern)
- All structs are BlueprintType for editor access
- Timestamp uses double for precision (FPlatformTime::Seconds())
</action>
  <verify>
    ```bash
    # Verify log header exists and contains log category
    grep -q "DECLARE_LOG_CATEGORY_EXTERN.*LogGSDTelemetry" \
      Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSDTelemetryLog.h \
      && echo "Log category declared" || echo "ERROR: Log category not declared"

    # Verify stats header exists and contains stats group
    grep -q "DECLARE_STATS_GROUP.*GSD Telemetry" \
      Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/GSDTelemetryStats.h \
      && echo "Stats group declared" || echo "ERROR: Stats group not declared"

    # Verify types header contains frame time history
    grep -q "USTRUCT.*FGSDFrameTimeHistory" \
      Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/Types/GSDTelemetryTypes.h \
      && echo "Frame time history struct exists" || echo "ERROR: Frame time history struct missing"

    # Verify circular buffer implementation
    grep -q "WriteIndex.*MaxSize" \
      Plugins/GSD_Telemetry/Source/GSD_Telemetry/Public/Types/GSDTelemetryTypes.h \
      && echo "Circular buffer implementation present" || echo "ERROR: Circular buffer incomplete"
    ```
  </verify>
  <done>
Logging and stats infrastructure created with:
- LogGSDTelemetry category with convenience macros (GSDTELEMETRY_LOG, WARN, ERROR, VERBOSE)
- STATGROUP_GSDTelemetry stats group with cycle and counter stats
- FGSDFrameTimeHistory circular buffer for O(1) averaging
- FGSDHitchEvent, FGSDActorCountSnapshot, FGSDCellLoadTimeRecord structs
- All types Blueprint-accessible
  </done>
</task>

</tasks>

<verification>
1. Plugin compiles without errors
2. Log category accessible via UE_LOG(LogGSDTelemetry, ...)
3. Stats visible via console command: `stat GSDTelemetry`
4. Telemetry types usable in C++ and Blueprints
</verification>

<success_criteria>
- GSD_Telemetry plugin structure follows established pattern
- Log category LogGSDTelemetry is functional
- Stats group STATGROUP_GSDTelemetry is declared
- Circular buffer FGSDFrameTimeHistory implements O(1) averaging
- All telemetry structs are BlueprintType
</success_criteria>

<output>
After completion, create `.planning/phases/10-telemetry-validation/10-01-SUMMARY.md`
</output>
