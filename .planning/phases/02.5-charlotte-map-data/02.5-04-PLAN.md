---
phase: 02.5-charlotte-map-data
plan: 04
type: execute
wave: 4
depends_on: ["02.5-01", "02.5-02", "02.5-03"]
files_modified:
  - tools/charlotte_map_acquisition/pipeline.py
  - tools/charlotte_map_acquisition/__main__.py
autonomous: true

must_haves:
  truths:
    - "Pipeline orchestrator runs all acquisition steps in correct order"
    - "Pipeline can run individual steps or full workflow"
    - "Pipeline reports progress and handles errors gracefully"
    - "Pipeline creates output directories as needed"
    - "Running python -m charlotte_map_acquisition executes full pipeline"
  artifacts:
    - path: "tools/charlotte_map_acquisition/pipeline.py"
      provides: "Main orchestration script"
      contains: "class CharlotteMapPipeline"
      min_lines: 100
    - path: "tools/charlotte_map_acquisition/__main__.py"
      provides: "Package entry point"
      contains: "from .pipeline import main"
  key_links:
    - from: "pipeline.py"
      to: "scripts/download_tiles.py"
      via: "import TileDownloader"
      pattern: "from.*download_tiles"
    - from: "pipeline.py"
      to: "scripts/generate_heightmap.py"
      via: "import dem_to_unreal_heightmap"
      pattern: "from.*generate_heightmap"
---

<objective>
Create the main pipeline orchestration script that coordinates all data acquisition and transformation steps into a unified workflow.

Purpose: Provide a single entry point for running the complete Charlotte map data acquisition pipeline with configurable steps and error handling.
Output: A pipeline.py script that orchestrates tiles, DEM, highway extraction, and transformations, plus __main__.py for package execution.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.5-charlotte-map-data/02.5-RESEARCH.md
@.planning/phases/02.5-charlotte-map-data/02.5-01-PLAN.md
@.planning/phases/02.5-charlotte-map-data/02.5-02-PLAN.md
@.planning/phases/02.5-charlotte-map-data/02.5-03-PLAN.md

# Prior plans provide:
# - Plan 01: Package structure, config files, coordinate module
# - Plan 02: Tile downloader, DEM acquisition, highway extraction scripts
# - Plan 03: Heightmap generator, coordinate transform scripts
# - All scripts have __main__ blocks for standalone execution
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pipeline Orchestration Script</name>
  <files>
    tools/charlotte_map_acquisition/pipeline.py
  </files>
  <action>
Create the main pipeline orchestration script at tools/charlotte_map_acquisition/pipeline.py.

This script coordinates all data acquisition and transformation steps:

1. Create CharlotteMapPipeline class with:
   - __init__(config_path=None) - loads configuration
   - setup_directories() - creates data/raw/* and data/processed/* directories
   - step_download_tiles(zoom_levels=None) - runs tile downloader
   - step_download_dem() - runs DEM acquisition
   - step_extract_highway() - runs highway extraction
   - step_generate_heightmap() - runs heightmap generation
   - step_transform_vectors() - runs coordinate transformation
   - run_full_pipeline() - executes all steps in order
   - run_steps(step_names) - executes specific steps

2. Pipeline step order:
   ```
   1. download_tiles    (acquires map imagery)
   2. download_dem      (acquires elevation data)
   3. extract_highway   (acquires road boundaries)
   4. generate_heightmap (transforms DEM -> heightmap)
   5. transform_vectors (transforms vectors -> Unreal coords)
   ```

3. Import scripts as modules:
   ```python
   from .scripts.download_tiles import TileDownloader
   from .scripts.download_dem import query_usgs_3dep
   from .scripts.extract_highway import extract_i485_highway
   from .scripts.generate_heightmap import dem_to_unreal_heightmap
   from .scripts.transform_data import transform_geojson_to_unreal
   from .coordinates import create_coordinate_pipeline
   ```

4. Error handling:
   - Wrap each step in try/except
   - Log step start/success/failure
   - Continue to next step on non-critical failures
   - Return summary of all step results

5. Progress reporting:
   - Print step name at start
   - Print duration after completion
   - Print total pipeline duration at end
   - Color output if terminal supports it (optional)

6. Configuration:
   - Load bounds from config/charlotte_bounds.json
   - Load zoom levels from config/zoom_levels.json
   - Allow override via constructor parameters

7. Directory structure creation:
   ```
   data/
     raw/
       tiles/
       dem/
       osm/
     processed/
       heightmaps/
       vectors/
         unreal/
   ```
  </action>
  <verify>
python3 -c "from tools.charlotte_map_acquisition.pipeline import CharlotteMapPipeline; print('Pipeline class OK')"
python3 -c "from tools.charlotte_map_acquisition.pipeline import CharlotteMapPipeline; p = CharlotteMapPipeline(); print(p.steps)"
  </verify>
  <done>
Pipeline class imports successfully and has step methods. Pipeline orchestrates all acquisition and transformation scripts.
</done>
</task>

<task type="auto">
  <name>Task 2: Create Package Entry Point</name>
  <files>
    tools/charlotte_map_acquisition/__main__.py
  </files>
  <action>
Create the package entry point at tools/charlotte_map_acquisition/__main__.py.

This enables running the pipeline with: python -m tools.charlotte_map_acquisition

1. Create __main__.py with:
   ```python
   """
   Charlotte Map Data Acquisition Pipeline

   Usage:
       python -m tools.charlotte_map_acquisition              # Run full pipeline
       python -m tools.charlotte_map_acquisition --steps tiles,dem  # Run specific steps
       python -m tools.charlotte_map_acquisition --list       # List available steps
       python -m tools.charlotte_map_acquisition --help       # Show help
   """
   import argparse
   import sys
   from .pipeline import CharlotteMapPipeline

   def main():
       parser = argparse.ArgumentParser(
           description='Charlotte Map Data Acquisition Pipeline'
       )
       parser.add_argument(
           '--steps',
           type=str,
           help='Comma-separated list of steps to run (default: all)'
       )
       parser.add_argument(
           '--list',
           action='store_true',
           help='List available steps and exit'
       )
       parser.add_argument(
           '--config',
           type=str,
           help='Path to config directory (default: config/)'
       )
       parser.add_argument(
           '--zoom',
           type=str,
           default='15,16',
           help='Comma-separated zoom levels (default: 15,16)'
       )

       args = parser.parse_args()

       if args.list:
           print("Available steps:")
           print("  1. download_tiles    - Download map tiles")
           print("  2. download_dem      - Query/download DEM data")
           print("  3. extract_highway   - Extract I-485 from OSM")
           print("  4. generate_heightmap - Convert DEM to heightmap")
           print("  5. transform_vectors - Transform to Unreal coords")
           sys.exit(0)

       # Create pipeline
       pipeline = CharlotteMapPipeline(config_path=args.config)

       # Parse zoom levels
       zoom_levels = [int(z) for z in args.zoom.split(',')]

       # Run steps
       if args.steps:
           steps = args.steps.split(',')
           pipeline.run_steps(steps, zoom_levels=zoom_levels)
       else:
           pipeline.run_full_pipeline(zoom_levels=zoom_levels)

   if __name__ == '__main__':
       main()
   ```

2. Update __init__.py to expose main entry point:
   ```python
   """
   Charlotte Map Data Acquisition Package

   Tools for acquiring Charlotte I-485 corridor map data for Unreal Engine.
   """
   __version__ = '0.1.0'

   from .pipeline import CharlotteMapPipeline
   from .coordinates import create_coordinate_pipeline, latlon_to_tile

   __all__ = [
       'CharlotteMapPipeline',
       'create_coordinate_pipeline',
       'latlon_to_tile',
   ]
   ```
  </action>
  <verify>
python3 -m tools.charlotte_map_acquisition --list
python3 -c "from tools.charlotte_map_acquisition import CharlotteMapPipeline; print('Package imports OK')"
  </verify>
  <done>
Package can be run with python -m and --list shows available steps. Package exports main classes and functions.
</done>
</task>

</tasks>

<verification>
1. Pipeline class imports and has step methods
2. Pipeline imports all scripts as modules
3. Package entry point runs with python -m
4. --list flag shows available steps
5. --steps flag allows running specific steps
6. Pipeline creates output directories
7. Error handling prevents cascade failures
</verification>

<success_criteria>
- Pipeline orchestrator coordinates all acquisition scripts
- Pipeline runs steps in correct dependency order
- Package executable via python -m tools.charlotte_map_acquisition
- CLI supports --list, --steps, --zoom, --config flags
- Pipeline reports progress and handles errors
- All files committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-charlotte-map-data/02.5-04-SUMMARY.md`
</output>
