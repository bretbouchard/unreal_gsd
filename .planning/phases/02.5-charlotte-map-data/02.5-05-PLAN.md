---
phase: 02.5-charlotte-map-data
plan: 05
type: execute
wave: 5
depends_on: ["02.5-01", "02.5-02", "02.5-03", "02.5-04"]
files_modified:
  - tools/charlotte_map_acquisition/tests/__init__.py
  - tools/charlotte_map_acquisition/tests/test_coordinates.py
  - tools/charlotte_map_acquisition/tests/test_pipeline.py
autonomous: false

must_haves:
  truths:
    - "Unit tests verify coordinate transformations produce correct values"
    - "Unit tests verify tile coordinate calculations"
    - "Integration test verifies pipeline steps can execute"
    - "All tests pass before phase completion"
    - "Human verifies pipeline can download actual data"
  artifacts:
    - path: "tools/charlotte_map_acquisition/tests/test_coordinates.py"
      provides: "Coordinate module unit tests"
      contains: "def test_latlon_to_tile"
      min_lines: 50
    - path: "tools/charlotte_map_acquisition/tests/test_pipeline.py"
      provides: "Pipeline integration tests"
      contains: "def test_pipeline_setup"
  key_links:
    - from: "tests/test_coordinates.py"
      to: "coordinates.py"
      via: "import and test"
      pattern: "from.*coordinates"
    - from: "tests/test_pipeline.py"
      to: "pipeline.py"
      via: "import and test"
      pattern: "from.*pipeline"
---

<objective>
Create unit tests for the coordinate module and pipeline, then perform human verification that the pipeline can acquire actual Charlotte map data.

Purpose: Ensure the coordinate transformations are mathematically correct and the pipeline can successfully download real data from OSM, USGS, and Mapbox.
Output: Unit tests for coordinates and pipeline, plus human verification of actual data acquisition.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.5-charlotte-map-data/02.5-RESEARCH.md
@.planning/phases/02.5-charlotte-map-data/02.5-01-PLAN.md
@.planning/phases/02.5-charlotte-map-data/02.5-04-PLAN.md

# Prior plans provide:
# - Plan 01: coordinates.py with create_coordinate_pipeline, latlon_to_tile
# - Plan 04: pipeline.py with CharlotteMapPipeline
# - Charlotte bounds: center at 35.227N, -80.843W
# - UTM Zone 17N (EPSG:32617)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Coordinate Module Unit Tests</name>
  <files>
    tools/charlotte_map_acquisition/tests/__init__.py
    tools/charlotte_map_acquisition/tests/test_coordinates.py
  </files>
  <action>
Create unit tests for the coordinate module at tools/charlotte_map_acquisition/tests/test_coordinates.py.

1. Create tests/__init__.py (can be empty)

2. Create test_coordinates.py with pytest tests:

```python
import pytest
import math
from tools.charlotte_map_acquisition.coordinates import (
    create_coordinate_pipeline,
    latlon_to_tile,
    get_tile_bounds,
    validate_coordinates
)

class TestCoordinatePipeline:
    """Tests for coordinate transformation pipeline"""

    def test_origin_transforms_to_zero(self):
        """Center of bounds should transform to (0, 0, 0)"""
        to_unreal = create_coordinate_pipeline(35.227, -80.843)
        x, y, z = to_unreal(-80.843, 35.227, 0)
        assert abs(x) < 1  # Within 1 cm
        assert abs(y) < 1
        assert abs(z) < 1

    def test_north_offset_positive_x(self):
        """Moving north should increase X (Unreal forward)"""
        to_unreal = create_coordinate_pipeline(35.227, -80.843)
        x1, _, _ = to_unreal(-80.843, 35.227, 0)
        x2, _, _ = to_unreal(-80.843, 35.3, 0)  # 0.073 degrees north
        assert x2 > x1

    def test_east_offset_positive_y(self):
        """Moving east should increase Y (Unreal right)"""
        to_unreal = create_coordinate_pipeline(35.227, -80.843)
        _, y1, _ = to_unreal(-80.843, 35.227, 0)
        _, y2, _ = to_unreal(-80.8, 35.227, 0)  # 0.043 degrees east
        assert y2 > y1

    def test_elevation_becomes_z(self):
        """Elevation should map to Z axis in centimeters"""
        to_unreal = create_coordinate_pipeline(35.227, -80.843)
        _, _, z1 = to_unreal(-80.843, 35.227, 0)
        _, _, z2 = to_unreal(-80.843, 35.227, 100)  # 100m elevation
        assert z2 == z1 + 10000  # 100m = 10000cm

    def test_known_distance(self):
        """Verify known distance conversion (1 degree lat ~ 111km)"""
        to_unreal = create_coordinate_pipeline(35.227, -80.843)
        x1, _, _ = to_unreal(-80.843, 35.227, 0)
        x2, _, _ = to_unreal(-80.843, 35.327, 0)  # 0.1 degree north
        distance_cm = x2 - x1
        distance_km = distance_cm / 100000
        # Should be approximately 11.1 km
        assert 10 < distance_km < 12


class TestTileCoordinates:
    """Tests for tile coordinate calculations"""

    def test_latlon_to_tile_zoom_15(self):
        """Verify tile calculation at zoom 15"""
        # Charlotte center
        x, y = latlon_to_tile(35.227, -80.843, 15)
        # These are known values for Charlotte at zoom 15
        assert 9800 < x < 9900
        assert 15700 < y < 15800

    def test_higher_zoom_more_tiles(self):
        """Higher zoom should produce larger tile numbers"""
        x15, y15 = latlon_to_tile(35.227, -80.843, 15)
        x16, y16 = latlon_to_tile(35.227, -80.843, 16)
        assert x16 == x15 * 2 or x16 == x15 * 2 + 1
        assert y16 == y15 * 2 or y16 == y15 * 2 + 1

    def test_tile_bounds_returns_range(self):
        """get_tile_bounds should return valid ranges"""
        bounds = {
            'north': 35.37,
            'south': 35.08,
            'east': -80.65,
            'west': -81.00
        }
        x_min, x_max, y_min, y_max = get_tile_bounds(bounds, 15)
        assert x_min < x_max
        assert y_min < y_max
        # Zoom 15 should have ~400 tiles for Charlotte
        tile_count = (x_max - x_min + 1) * (y_max - y_min + 1)
        assert 300 < tile_count < 500


class TestCoordinateValidation:
    """Tests for coordinate validation"""

    def test_valid_charlotte_coords(self):
        """Coordinates within bounds should validate"""
        assert validate_coordinates(35.227, -80.843) == True

    def test_invalid_north(self):
        """Coordinates too far north should fail"""
        assert validate_coordinates(35.5, -80.843) == False

    def test_invalid_south(self):
        """Coordinates too far south should fail"""
        assert validate_coordinates(35.0, -80.843) == False
```

3. Add pytest configuration (optional pytest.ini in package root)

4. Ensure tests can run with: pytest tools/charlotte_map_acquisition/tests/
  </action>
  <verify>
cd /Users/bretbouchard/apps/unreal_gsd && python3 -m pytest tools/charlotte_map_acquisition/tests/test_coordinates.py -v
  </verify>
  <done>
All coordinate unit tests pass. Tests verify origin transformation, axis conventions, distance calculations, and tile coordinate generation.
</done>
</task>

<task type="auto">
  <name>Task 2: Create Pipeline Integration Tests</name>
  <files>
    tools/charlotte_map_acquisition/tests/test_pipeline.py
  </files>
  <action>
Create integration tests for the pipeline at tools/charlotte_map_acquisition/tests/test_pipeline.py.

1. Create test_pipeline.py with tests that verify pipeline setup and configuration:

```python
import pytest
import os
import tempfile
import shutil
from tools.charlotte_map_acquisition.pipeline import CharlotteMapPipeline

class TestPipelineSetup:
    """Tests for pipeline initialization and setup"""

    def test_pipeline_creates_with_defaults(self):
        """Pipeline should initialize with default config"""
        pipeline = CharlotteMapPipeline()
        assert pipeline.config is not None
        assert 'north' in pipeline.config

    def test_pipeline_loads_bounds(self):
        """Pipeline should load Charlotte bounds from config"""
        pipeline = CharlotteMapPipeline()
        assert pipeline.config['north'] == 35.37
        assert pipeline.config['south'] == 35.08
        assert pipeline.config['east'] == -80.65
        assert pipeline.config['west'] == -81.00

    def test_pipeline_has_all_steps(self):
        """Pipeline should have all required steps"""
        pipeline = CharlotteMapPipeline()
        expected_steps = [
            'download_tiles',
            'download_dem',
            'extract_highway',
            'generate_heightmap',
            'transform_vectors'
        ]
        for step in expected_steps:
            assert hasattr(pipeline, f'step_{step}')

    def test_pipeline_creates_directories(self):
        """Pipeline setup should create data directories"""
        with tempfile.TemporaryDirectory() as tmpdir:
            pipeline = CharlotteMapPipeline()
            pipeline.base_dir = tmpdir
            pipeline.setup_directories()

            expected_dirs = [
                'data/raw/tiles',
                'data/raw/dem',
                'data/raw/osm',
                'data/processed/heightmaps',
                'data/processed/vectors/unreal'
            ]
            for dir_path in expected_dirs:
                full_path = os.path.join(tmpdir, dir_path)
                assert os.path.exists(full_path)


class TestPipelineSteps:
    """Tests for individual pipeline steps (mocked)"""

    def test_list_steps(self):
        """Pipeline should list available steps"""
        pipeline = CharlotteMapPipeline()
        steps = pipeline.get_available_steps()
        assert 'download_tiles' in steps
        assert 'extract_highway' in steps

    def test_step_order(self):
        """Pipeline should define correct step order"""
        pipeline = CharlotteMapPipeline()
        order = pipeline.get_step_order()
        # DEM download must come before heightmap generation
        assert order.index('download_dem') < order.index('generate_heightmap')
        # Highway extraction must come before vector transform
        assert order.index('extract_highway') < order.index('transform_vectors')
```

2. Add helper methods to pipeline if not present:
   - get_available_steps()
   - get_step_order()

3. Tests should pass without requiring network access (mock external calls)
  </action>
  <verify>
cd /Users/bretbouchard/apps/unreal_gsd && python3 -m pytest tools/charlotte_map_acquisition/tests/test_pipeline.py -v
  </verify>
  <done>
All pipeline integration tests pass. Tests verify configuration loading, directory creation, and step ordering.
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Charlotte map data acquisition pipeline with:
- Python package structure under tools/charlotte_map_acquisition/
- Configuration files with Charlotte I-485 bounds
- Coordinate transformation module (WGS84 -> UTM17N -> Unreal cm)
- Tile downloader script (rate-limited, concurrent)
- DEM acquisition script (USGS 3DEP query)
- Highway extraction script (OSMnx for I-485)
- Heightmap generator (DEM to 16-bit PNG)
- Vector transformation script (GeoJSON to Unreal coords)
- Pipeline orchestrator (coordinates all steps)
- Unit tests for coordinates and pipeline
  </what-built>
  <how-to-verify>
**Step 1: Install Dependencies**
```bash
cd /Users/bretbouchard/apps/unreal_gsd
pip install -r tools/charlotte_map_acquisition/requirements.txt
```

**Step 2: Run Unit Tests**
```bash
python3 -m pytest tools/charlotte_map_acquisition/tests/ -v
```
Expected: All tests pass

**Step 3: Test Pipeline Setup**
```bash
python3 -m tools.charlotte_map_acquisition --list
```
Expected: Shows 5 available steps

**Step 4: Test Single Tile Download (Quick Verification)**
```bash
# Download just a few tiles at zoom 15 to verify tile downloader works
python3 -c "
from tools.charlotte_map_acquisition.scripts.download_tiles import TileDownloader
d = TileDownloader()
bounds = {'north': 35.23, 'south': 35.22, 'east': -80.84, 'west': -80.85}
tiles = d.get_tiles_for_bounds(bounds, 15)
print(f'Tiles to download: {len(tiles)}')
"
```
Expected: Shows small number of tiles (4-9)

**Step 5: Test Highway Extraction (requires network)**
```bash
python3 -m tools.charlotte_map_acquisition.scripts.extract_highway
```
Expected: Downloads I-485 geometry from OSM, saves to data/processed/vectors/

**Step 6: Verify Coordinate Transform**
```bash
python3 -c "
from tools.charlotte_map_acquisition import create_coordinate_pipeline
to_unreal = create_coordinate_pipeline(35.227, -80.843)
# Origin should be (0,0,0)
print(f'Origin: {to_unreal(-80.843, 35.227, 0)}')
# Airport (5km west) should have negative Y
print(f'Airport: {to_unreal(-80.95, 35.214, 0)}')
"
```
Expected: Origin is ~(0,0,0), Airport has negative Y value
  </how-to-verify>
  <resume-signal>Type "approved" if pipeline works, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. Unit tests for coordinates pass (origin transform, axis conventions, tile calculations)
2. Unit tests for pipeline pass (config loading, directory creation, step order)
3. Pipeline --list shows available steps
4. Tile downloader can calculate tile coordinates
5. Coordinate transform produces correct values for known points
6. Human verification confirms pipeline can acquire actual data
</verification>

<success_criteria>
- All unit tests pass (pytest exits with 0)
- Pipeline --list displays 5 available steps
- Coordinate origin transforms to ~(0, 0, 0)
- Human verifies tile download and highway extraction work with real data
- All files committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-charlotte-map-data/02.5-05-SUMMARY.md`
</output>
