---
phase: 02.5-charlotte-map-data
plan: 03
type: execute
wave: 3
depends_on: ["02.5-01", "02.5-02"]
files_modified:
  - tools/charlotte_map_acquisition/scripts/generate_heightmap.py
  - tools/charlotte_map_acquisition/scripts/transform_data.py
autonomous: true

must_haves:
  truths:
    - "Heightmap generator converts DEM GeoTIFF to Unreal-compatible 16-bit PNG"
    - "Heightmap normalization preserves elevation range (white=highest, black=lowest)"
    - "Transform script converts vector data to Unreal coordinate space"
    - "Output files are ready for Unreal Engine import"
  artifacts:
    - path: "tools/charlotte_map_acquisition/scripts/generate_heightmap.py"
      provides: "DEM to Unreal heightmap conversion"
      contains: "def dem_to_unreal_heightmap"
      min_lines: 60
    - path: "tools/charlotte_map_acquisition/scripts/transform_data.py"
      provides: "Coordinate transformation for vectors"
      contains: "def transform_geojson_to_unreal"
  key_links:
    - from: "scripts/generate_heightmap.py"
      to: "coordinates.py"
      via: "import coordinate pipeline"
      pattern: "create_coordinate_pipeline"
    - from: "scripts/generate_heightmap.py"
      to: "rasterio/numpy"
      via: "DEM processing"
      pattern: "rasterio.open"
---

<objective>
Create the data transformation scripts that convert raw GIS data (DEM elevation, vector geometry) into Unreal Engine compatible formats.

Purpose: Transform downloaded DEM files to Unreal heightmap format (16-bit PNG) and convert vector coordinates to Unreal world space.
Output: Heightmap generation script and coordinate transformation script for vector data, producing Unreal-ready assets.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.5-charlotte-map-data/02.5-RESEARCH.md
@.planning/phases/02.5-charlotte-map-data/02.5-01-PLAN.md

# Research provides:
# - DEM to heightmap pattern using rasterio + numpy + Pillow
# - Unreal heightmap requirements: 16-bit grayscale PNG, white=highest, black=lowest
# - Resolution should be power-of-2 + 1 (e.g., 1009x1009)
# - Pitfall: 8-bit heightmaps only have 256 elevation values - insufficient
# - Coordinate pipeline from Plan 01 for vector transforms
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Heightmap Generator Script</name>
  <files>
    tools/charlotte_map_acquisition/scripts/generate_heightmap.py
  </files>
  <action>
Create the heightmap generation script at tools/charlotte_map_acquisition/scripts/generate_heightmap.py.

Based on the DEM to Unreal heightmap pattern from research:

1. Create functions for heightmap generation:
   - dem_to_unreal_heightmap(dem_path, output_path, unreal_scale=100.0)
   - normalize_elevation(elevation_array) - normalizes to 0-65535 range
   - get_dem_info(dem_path) - returns metadata (resolution, bounds, crs)

2. Unreal heightmap requirements (from research):
   - 16-bit grayscale PNG (mode='I;16' in Pillow)
   - White (65535) = highest point
   - Black (0) = lowest point
   - Resolution: power-of-2 + 1 (1009, 2017, 4033, etc.) for terrain

3. Processing steps:
   - Open DEM with rasterio
   - Read elevation band
   - Handle nodata values (replace with NaN)
   - Normalize to 0-65535 range
   - Convert to uint16 numpy array
   - Create Pillow Image with mode='I;16'
   - Save as PNG

4. Key implementation details:
   ```python
   with rasterio.open(dem_path) as src:
       elevation = src.read(1)
       nodata = src.nodata
       if nodata is not None:
           elevation = np.where(elevation == nodata, np.nan, elevation)
       min_elev = np.nanmin(elevation)
       max_elev = np.nanmax(elevation)
       normalized = (elevation - min_elev) / (max_elev - min_elev) * 65535
       normalized = np.nan_to_num(normalized, nan=0).astype(np.uint16)
       img = Image.fromarray(normalized, mode='I;16')
   ```

5. Output structure:
   - Save heightmaps to ../data/processed/heightmaps/
   - Include metadata file with min/max elevation and scale
   - Name files with resolution info (e.g., charlotte_1009x1009.png)

6. Include __main__ block:
   - Find DEM files in ../data/raw/dem/
   - Generate heightmap for each
   - Print elevation range and output path
   - Save metadata JSON alongside heightmap

7. Add optional resampling:
   - If DEM resolution not power-of-2 + 1, resample
   - Use rasterio or scipy for resampling
   - Document resampling in metadata
  </action>
  <verify>
python3 -c "from tools.charlotte_map_acquisition.scripts.generate_heightmap import dem_to_unreal_heightmap, normalize_elevation; print('Heightmap functions OK')"
cat tools/charlotte_map_acquisition/scripts/generate_heightmap.py | grep -c "I;16"
  </verify>
  <done>
Heightmap generator imports successfully and uses 16-bit PNG format. Script converts DEM elevation data to Unreal-compatible heightmap.
</done>
</task>

<task type="auto">
  <name>Task 2: Create Coordinate Transform Script</name>
  <files>
    tools/charlotte_map_acquisition/scripts/transform_data.py
  </files>
  <action>
Create the coordinate transformation script at tools/charlotte_map_acquisition/scripts/transform_data.py.

This script transforms vector data (GeoJSON) from WGS84 to Unreal coordinate space:

1. Create functions for vector transformation:
   - transform_geojson_to_unreal(input_path, output_path, origin_lat, origin_lon)
   - transform_point(lon, lat, elevation, coord_pipeline)
   - transform_linestring(coords, coord_pipeline)
   - transform_polygon(coords, coord_pipeline)

2. Use the coordinate pipeline from coordinates.py:
   ```python
   from tools.charlotte_map_acquisition.coordinates import create_coordinate_pipeline

   # Load config for origin
   with open('../config/charlotte_bounds.json') as f:
       config = json.load(f)

   to_unreal = create_coordinate_pipeline(
       config['center_lat'],
       config['center_lon']
   )
   ```

3. Processing steps for GeoJSON:
   - Load GeoJSON file
   - Iterate through features
   - Transform each coordinate using coordinate pipeline
   - Create new GeoJSON with Unreal coordinates
   - Preserve all properties/metadata

4. Output structure:
   - Save transformed vectors to ../data/processed/vectors/unreal/
   - Keep original CRS info in properties
   - Add Unreal coordinate metadata

5. Include __main__ block:
   - Load highway boundary from ../data/processed/vectors/i485_boundary.geojson
   - Transform to Unreal coordinates
   - Save to ../data/processed/vectors/unreal/i485_unreal.geojson
   - Print coordinate range (min/max X, Y, Z)

6. Add validation:
   - Verify origin transforms to (0, 0, 0)
   - Check for coordinate outliers
   - Log transformation statistics

7. Handle GeoJSON geometry types:
   - Point
   - LineString (for road centerlines)
   - Polygon (for buffered areas)
   - MultiLineString, MultiPolygon (dissolved geometries)
  </action>
  <verify>
python3 -c "from tools.charlotte_map_acquisition.scripts.transform_data import transform_geojson_to_unreal, transform_point; print('Transform functions OK')"
python3 -c "from tools.charlotte_map_acquisition.scripts.transform_data import transform_point; from tools.charlotte_map_acquisition.coordinates import create_coordinate_pipeline; p = create_coordinate_pipeline(35.227, -80.843); print(transform_point(-80.843, 35.227, 0, p))"
  </verify>
  <done>
Transform script imports successfully and transforms coordinates. Origin point (center of bounds) transforms to near (0, 0, 0).
</done>
</task>

</tasks>

<verification>
1. Heightmap generator imports and uses 16-bit PNG format
2. Heightmap normalization produces 0-65535 range
3. Transform script imports coordinate pipeline from coordinates.py
4. Transform script handles GeoJSON geometry types
5. Both scripts have __main__ blocks for standalone execution
6. Output directories defined in processed/heightmaps/ and processed/vectors/unreal/
</verification>

<success_criteria>
- Heightmap generator converts DEM to 16-bit grayscale PNG
- Heightmap uses white=highest, black=lowest convention
- Transform script converts GeoJSON coordinates to Unreal space
- Origin (center of I-485) transforms to (0, 0, 0)
- Both scripts reference shared coordinate pipeline
- All files committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/02.5-charlotte-map-data/02.5-03-SUMMARY.md`
</output>
