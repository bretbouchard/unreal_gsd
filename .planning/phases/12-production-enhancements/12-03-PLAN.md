---
phase: 12-production-enhancements
plan: 3
type: execute
wave: 1
depends_on: [12-02]
files_modified:
  - Plugins/GSD_Core/Source/GSD_Core/Public/DataAssets/GSDNetworkBudgetConfig.h
  - Plugins/GSD_Core/Source/GSD_Core/Private/DataAssets/GSDNetworkBudgetConfig.cpp
  - Plugins/GSD_Core/Source/GSD_Core/Public/Subsystems/GSDNetworkBudgetSubsystem.h
  - Plugins/GSD_Core/Source/GSD_Core/Private/Subsystems/GSDNetworkBudgetSubsystem.cpp
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp
autonomous: true
must_haves:
  truths:
    - "Network bandwidth is tracked and budgeted"
    - "Crowd replication respects bandwidth limits"
    - "LOD affects replication frequency"
  artifacts:
    - path: "Plugins/GSD_Core/Source/GSD_Core/Public/Subsystems/GSDNetworkBudgetSubsystem.h"
      provides: "Bandwidth tracking"
      contains: "TrackReplication|CanReplicateThisFrame"
---

<objective>
Implement network bandwidth budget tracking for crowd replication.

Purpose: Council review (unreal-network-rick) identified that crowd replication could saturate network bandwidth with 1000+ entities. This plan implements bandwidth budget tracking and LOD-based replication frequency.

Output: Network bandwidth is tracked, budgeted, and crowd replication respects limits.

Council Issues: unreal-network-rick HIGH #4 - Bandwidth budget tracking
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-production-enhancements/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSDNetworkBudgetConfig DataAsset</name>
  <files>
    Plugins/GSD_Core/Source/GSD_Core/Public/DataAssets/GSDNetworkBudgetConfig.h
    Plugins/GSD_Core/Source/GSD_Core/Private/DataAssets/GSDNetworkBudgetConfig.cpp
  </files>
  <action>
Create configuration data asset for network bandwidth budgets.

**GSDNetworkBudgetConfig.h:**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "Engine/DataAsset.h"
#include "GSDNetworkBudgetConfig.generated.h"

UENUM(BlueprintType)
enum class EGSDBudgetCategory : uint8
{
    Crowd,
    Vehicle,
    Event,
    Player,
    Other
};

USTRUCT(BlueprintType)
struct FGSDLODReplicationConfig
{
    GENERATED_BODY()

    // Update frequency for this LOD level (Hz)
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly)
    float UpdateFrequency = 30.0f;

    // Maximum entities to update per frame at this LOD
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly)
    int32 MaxEntitiesPerFrame = 50;

    // Whether to use delta compression
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly)
    bool bUseDeltaCompression = true;
};

/**
 * Network bandwidth budget configuration.
 * Controls how much bandwidth each system can use.
 */
UCLASS(BlueprintType)
class GSD_CORE_API UGSDNetworkBudgetConfig : public UDataAsset
{
    GENERATED_BODY()

public:
    // Total bandwidth budget (bits per second)
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Budget")
    int32 TotalBitsPerSecond = 100000;  // 100 kbps

    // Per-category bandwidth allocation (percentage of total)
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Budget")
    TMap<EGSDBudgetCategory, float> CategoryAllocations;

    // LOD-based replication configs
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "LOD")
    TArray<FGSDLODReplicationConfig> LODConfigs;

    // Warning threshold (percentage)
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Monitoring")
    float WarningThreshold = 0.8f;

    // Critical threshold (percentage)
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Monitoring")
    float CriticalThreshold = 0.95f;

    // Whether to log bandwidth warnings
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Monitoring")
    bool bLogBandwidthWarnings = true;

    // Get allocated bandwidth for a category
    int32 GetCategoryBudget(EGSDBudgetCategory Category) const;

    // Get LOD config
    const FGSDLODReplicationConfig& GetLODConfig(int32 LODLevel) const;

protected:
    virtual void PostLoad() override;
};
```

**Default Configuration:**
```cpp
void UGSDNetworkBudgetConfig::PostLoad()
{
    Super::PostLoad();

    if (CategoryAllocations.IsEmpty())
    {
        CategoryAllocations.Add(EGSDBudgetCategory::Crowd, 0.30f);    // 30%
        CategoryAllocations.Add(EGSDBudgetCategory::Vehicle, 0.20f);  // 20%
        CategoryAllocations.Add(EGSDBudgetCategory::Event, 0.10f);    // 10%
        CategoryAllocations.Add(EGSDBudgetCategory::Player, 0.35f);   // 35%
        CategoryAllocations.Add(EGSDBudgetCategory::Other, 0.05f);    // 5%
    }

    if (LODConfigs.IsEmpty())
    {
        // LOD 0 - Close, high frequency
        FGSDLODReplicationConfig LOD0;
        LOD0.UpdateFrequency = 60.0f;
        LOD0.MaxEntitiesPerFrame = 100;
        LOD0.bUseDeltaCompression = false;
        LODConfigs.Add(LOD0);

        // LOD 1 - Medium
        FGSDLODReplicationConfig LOD1;
        LOD1.UpdateFrequency = 30.0f;
        LOD1.MaxEntitiesPerFrame = 50;
        LOD1.bUseDeltaCompression = true;
        LODConfigs.Add(LOD1);

        // LOD 2 - Far
        FGSDLODReplicationConfig LOD2;
        LOD2.UpdateFrequency = 10.0f;
        LOD2.MaxEntitiesPerFrame = 20;
        LOD2.bUseDeltaCompression = true;
        LODConfigs.Add(LOD2);

        // LOD 3 - Very far
        FGSDLODReplicationConfig LOD3;
        LOD3.UpdateFrequency = 2.0f;
        LOD3.MaxEntitiesPerFrame = 10;
        LOD3.bUseDeltaCompression = true;
        LODConfigs.Add(LOD3);
    }
}
```
  </action>
  <verify>
    ```bash
    [ -f "Plugins/GSD_Core/Source/GSD_Core/Public/DataAssets/GSDNetworkBudgetConfig.h" ] && echo "✓ GSDNetworkBudgetConfig.h created"
    [ -f "Plugins/GSD_Core/Source/GSD_Core/Private/DataAssets/GSDNetworkBudgetConfig.cpp" ] && echo "✓ GSDNetworkBudgetConfig.cpp created"
    ```
  </verify>
  <done>
    - GSDNetworkBudgetConfig DataAsset created
    - Category allocations defined
    - LOD replication configs defined
    - Default configuration set
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GSDNetworkBudgetSubsystem</name>
  <files>
    Plugins/GSD_Core/Source/GSD_Core/Public/Subsystems/GSDNetworkBudgetSubsystem.h
    Plugins/GSD_Core/Source/GSD_Core/Private/Subsystems/GSDNetworkBudgetSubsystem.cpp
  </files>
  <action>
Create subsystem to track and enforce bandwidth budgets.

**GSDNetworkBudgetSubsystem.h:**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "Subsystems/EngineSubsystem.h"
#include "DataAssets/GSDNetworkBudgetConfig.h"
#include "GSDNetworkBudgetSubsystem.generated.h"

DECLARE_LOG_CATEGORY_EXTERN(LogGSDNetworkBudget, Log, All);

USTRUCT(BlueprintType)
struct FGSDReplicationRecord
{
    GENERATED_BODY()

    UPROPERTY()
    EGSDBudgetCategory Category = EGSDBudgetCategory::Other;

    UPROPERTY()
    int32 BitsReplicated = 0;

    UPROPERTY()
    float Timestamp = 0.0f;
};

/**
 * Network bandwidth budget tracking subsystem.
 * Monitors replication and enforces budget limits.
 */
UCLASS()
class GSD_CORE_API UGSDNetworkBudgetSubsystem : public UEngineSubsystem
{
    GENERATED_BODY()

public:
    virtual void Initialize(FSubsystemCollectionBase& Collection) override;
    virtual void Deinitialize() override;

    // Track replication for a category
    void TrackReplication(EGSDBudgetCategory Category, int32 Bits);

    // Check if replication is allowed this frame for a category/LOD
    bool CanReplicateThisFrame(EGSDBudgetCategory Category, int32 LODLevel = 0);

    // Get current bandwidth usage for a category
    float GetCurrentBandwidthUsage(EGSDBudgetCategory Category) const;

    // Get total bandwidth usage
    float GetTotalBandwidthUsage() const;

    // Get remaining budget for a category
    int32 GetRemainingBudget(EGSDBudgetCategory Category) const;

    // Set configuration
    void SetConfig(UGSDNetworkBudgetConfig* InConfig);

    // Reset frame counters (call at end of frame)
    void ResetFrameCounters();

    // Log current status
    void LogStatus() const;

protected:
    // Configuration
    UPROPERTY()
    UGSDNetworkBudgetConfig* Config = nullptr;

    // Current frame usage per category
    TMap<EGSDBudgetCategory, int32> FrameUsage;

    // Rolling average usage (1 second window)
    TMap<EGSDBudgetCategory, TArray<int32>> UsageHistory;

    // Entity counts per LOD
    TArray<int32> LODReplicationCounts;

    // Last warning time
    float LastWarningTime = 0.0f;

    // Update interval for history
    static constexpr float HistoryInterval = 1.0f;
    static constexpr int32 HistorySize = 60;  // 60 seconds of history
};
```

**Key Implementation:**
```cpp
void UGSDNetworkBudgetSubsystem::TrackReplication(EGSDBudgetCategory Category, int32 Bits)
{
    if (!Config) return;

    FrameUsage.FindOrAdd(Category) += Bits;

    // Check budget
    int32 Budget = Config->GetCategoryBudget(Category);
    int32 Used = FrameUsage[Category];

    if (Config->bLogBandwidthWarnings && Used > Budget * Config->WarningThreshold)
    {
        float Now = GetWorld()->GetTimeSeconds();
        if (Now - LastWarningTime > 5.0f)  // Throttle warnings
        {
            UE_LOG(LogGSDNetworkBudget, Warning,
                TEXT("Category %s at %.1f%% bandwidth budget"),
                *UEnum::GetValueAsString(Category),
                (float)Used / Budget * 100.0f);
            LastWarningTime = Now;
        }
    }
}

bool UGSDNetworkBudgetSubsystem::CanReplicateThisFrame(EGSDBudgetCategory Category, int32 LODLevel)
{
    if (!Config) return true;

    // Check budget
    int32 Remaining = GetRemainingBudget(Category);
    if (Remaining <= 0)
    {
        return false;
    }

    // Check LOD limits
    const FGSDLODReplicationConfig& LODConfig = Config->GetLODConfig(LODLevel);
    int32 CurrentCount = LODReplicationCounts.IsValidIndex(LODLevel) ? LODReplicationCounts[LODLevel] : 0;

    if (CurrentCount >= LODConfig.MaxEntitiesPerFrame)
    {
        return false;
    }

    // Increment count
    if (LODReplicationCounts.Num() <= LODLevel)
    {
        LODReplicationCounts.SetNum(LODLevel + 1);
    }
    LODReplicationCounts[LODLevel]++;

    return true;
}
```
  </action>
  <verify>
    ```bash
    [ -f "Plugins/GSD_Core/Source/GSD_Core/Public/Subsystems/GSDNetworkBudgetSubsystem.h" ] && echo "✓ GSDNetworkBudgetSubsystem.h created"
    grep -q "CanReplicateThisFrame" Plugins/GSD_Core/Source/GSD_Core/Public/Subsystems/GSDNetworkBudgetSubsystem.h && echo "✓ CanReplicateThisFrame method present"
    ```
  </verify>
  <done>
    - GSDNetworkBudgetSubsystem created
    - TrackReplication method implemented
    - CanReplicateThisFrame method implemented
    - Budget enforcement working
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Budget Tracking into Crowd LOD Processor</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp
  </files>
  <action>
Update crowd LOD processor to check bandwidth budget before replicating.

**Changes:**
```cpp
#include "Subsystems/GSDNetworkBudgetSubsystem.h"

void UGSDCrowdLODProcessor::Execute(FMassEntityManager& EntityManager, FMassExecutionContext& Context)
{
    // Get budget subsystem
    UGSDNetworkBudgetSubsystem* BudgetSubsystem = nullptr;
    if (UWorld* World = GetWorld())
    {
        if (UGameInstance* GI = World->GetGameInstance())
        {
            BudgetSubsystem = GI->GetSubsystem<UGSDNetworkBudgetSubsystem>();
        }
    }

    // Process entities
    for (FMassEntityHandle Entity : Context.GetEntities())
    {
        // Get LOD level
        int32 LODLevel = ComputeLODLevel(Entity);

        // Check if we can replicate this frame
        if (BudgetSubsystem && !BudgetSubsystem->CanReplicateThisFrame(EGSDBudgetCategory::Crowd, LODLevel))
        {
            // Skip this entity this frame
            continue;
        }

        // Process entity...
        UpdateEntityLOD(Entity, LODLevel);

        // Track bandwidth
        if (BudgetSubsystem)
        {
            // Estimate bits used (position + state)
            int32 EstimatedBits = 96 + 8;  // FVector + uint8 state
            BudgetSubsystem->TrackReplication(EGSDBudgetCategory::Crowd, EstimatedBits);
        }
    }
}
```
  </action>
  <verify>
    ```bash
    grep -q "GSDNetworkBudgetSubsystem" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp && echo "✓ Budget subsystem integrated"
    ```
  </verify>
  <done>
    - Crowd LOD processor checks budget
    - Replication tracked per entity
    - LOD affects replication frequency
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Bandwidth Budget Test</name>
  <files>
    Plugins/GSD_Tests/Source/GSD_Tests/Private/Tests/GSDNetworkBudgetTests.cpp
  </files>
  <action>
Create tests for bandwidth budget system.

**Test Cases:**
```cpp
IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDNetworkBudgetTrackingTest,
    "GSD.Network.Budget.Tracking",
    EAutomationTestFlags::ProductFilter | EAutomationTestFlags::ContextMask)

bool FGSDNetworkBudgetTrackingTest::RunTest(const FString& Parameters)
{
    UGSDNetworkBudgetSubsystem* Subsystem = GetBudgetSubsystem();

    // Test tracking
    Subsystem->TrackReplication(EGSDBudgetCategory::Crowd, 1000);
    TestEqual("Crowd usage tracked", Subsystem->GetCurrentBandwidthUsage(EGSDBudgetCategory::Crowd), 1000.0f);

    // Test budget check
    TestTrue("Can replicate under budget", Subsystem->CanReplicateThisFrame(EGSDBudgetCategory::Crowd, 0));

    return true;
}

IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDNetworkBudgetEnforcementTest,
    "GSD.Network.Budget.Enforcement",
    EAutomationTestFlags::ProductFilter | EAutomationTestFlags::ContextMask)

bool FGSDNetworkBudgetEnforcementTest::RunTest(const FString& Parameters)
{
    UGSDNetworkBudgetSubsystem* Subsystem = GetBudgetSubsystem();

    // Exhaust budget
    for (int32 i = 0; i < 1000; i++)
    {
        Subsystem->TrackReplication(EGSDBudgetCategory::Crowd, 1000);
    }

    // Should be blocked
    TestFalse("Cannot replicate over budget", Subsystem->CanReplicateThisFrame(EGSDBudgetCategory::Crowd, 0));

    // Reset
    Subsystem->ResetFrameCounters();

    // Should be allowed again
    TestTrue("Can replicate after reset", Subsystem->CanReplicateThisFrame(EGSDBudgetCategory::Crowd, 0));

    return true;
}
```
  </action>
  <verify>
    ```bash
    [ -f "Plugins/GSD_Tests/Source/GSD_Tests/Private/Tests/GSDNetworkBudgetTests.cpp" ] && echo "✓ Network budget tests created"
    ```
  </verify>
  <done>
    - Tracking tests created
    - Enforcement tests created
    - Tests pass
  </done>
</task>

</tasks>

<verification>
1. GSDNetworkBudgetConfig DataAsset exists
2. GSDNetworkBudgetSubsystem tracks bandwidth
3. CanReplicateThisFrame respects budget
4. Crowd processor integrates budget checks
5. Tests pass
</verification>

<success_criteria>
- Bandwidth budget configuration exists
- Budget tracking subsystem functional
- Crowd replication respects budget limits
- LOD affects replication frequency
- Budget warnings logged when threshold exceeded
</success_criteria>

<output>
After completion, create `.planning/phases/12-production-enhancements/12-03-SUMMARY.md`
</output>
