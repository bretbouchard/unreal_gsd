---
phase: 12-production-enhancements
plan: 2
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Subsystems/GSDCrowdManagerSubsystem.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Subsystems/GSDCrowdManagerSubsystem.cpp
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventSpawnRegistry.h
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/Subsystems/GSDEventSpawnRegistry.cpp
autonomous: true
must_haves:
  truths:
    - "All Server RPCs have _Validate functions"
    - "Validation prevents exploitable inputs"
    - "Network security is enforced"
  artifacts:
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Subsystems/GSDCrowdManagerSubsystem.h"
      provides: "Secure crowd RPCs"
      contains: "_Validate|Server_"
---

<objective>
Add _Validate functions to all Server RPCs across GSD plugins for network security.

Purpose: Council review (unreal-network-rick) identified that Server RPCs lack validation functions, creating security vulnerabilities. This plan adds _Validate implementations to all server-authoritative RPCs.

Output: All Server RPCs have _Validate functions that prevent exploitable inputs.

Council Issues: unreal-network-rick CRITICAL #3 - Missing RPC validation
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-production-enhancements/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RPC Validation to GSDCrowdManagerSubsystem</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Subsystems/GSDCrowdManagerSubsystem.h
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Subsystems/GSDCrowdManagerSubsystem.cpp
  </files>
  <action>
Add _Validate functions to all Server RPCs in crowd manager.

**Pattern to Apply:**

1. **Update RPC declarations:**
```cpp
// Header
UFUNCTION(Server, Reliable, WithValidation, Category = "Crowd")
void Server_SpawnCrowd(const FCrowdSpawnParams& Params);

UFUNCTION(Server, Reliable, WithValidation, Category = "Crowd")
void Server_DespawnCrowd(int32 CrowdId);

UFUNCTION(Server, Reliable, WithValidation, Category = "Crowd")
void Server_SetCrowdEnabled(bool bEnabled);
```

2. **Implement _Validate functions:**
```cpp
bool UGSDCrowdManagerSubsystem::Server_SpawnCrowd_Validate(const FCrowdSpawnParams& Params)
{
    // Validate spawn count
    if (Params.Count <= 0 || Params.Count > MaxCrowdSize)
    {
        UE_LOG(LogGSDCrowds, Warning, TEXT("Invalid spawn count: %d"), Params.Count);
        return false;
    }

    // Validate spawn location is in playable area
    if (!IsValidSpawnLocation(Params.Center))
    {
        UE_LOG(LogGSDCrowds, Warning, TEXT("Invalid spawn location: %s"), *Params.Center.ToString());
        return false;
    }

    // Validate radius
    if (Params.Radius <= 0.0f || Params.Radius > 10000.0f)
    {
        UE_LOG(LogGSDCrowds, Warning, TEXT("Invalid spawn radius: %f"), Params.Radius);
        return false;
    }

    return true;
}

bool UGSDCrowdManagerSubsystem::Server_DespawnCrowd_Validate(int32 CrowdId)
{
    // Validate crowd ID exists
    if (CrowdId < 0 || !ActiveCrowds.Contains(CrowdId))
    {
        return false;
    }
    return true;
}

bool UGSDCrowdManagerSubsystem::Server_SetCrowdEnabled_Validate(bool bEnabled)
{
    // Always valid - simple bool toggle
    return true;
}
```

3. **Add helper validation function:**
```cpp
protected:
    bool IsValidSpawnLocation(const FVector& Location) const;

// Implementation
bool UGSDCrowdManagerSubsystem::IsValidSpawnLocation(const FVector& Location) const
{
    // Check world bounds
    if (!GetWorld() || !GetWorld()->GetWorldBounds().IsInside(Location))
    {
        return false;
    }

    // Check navigation area
    if (UNavigationSystemV1* NavSys = FNavigationSystem::GetCurrent<UNavigationSystemV1>(GetWorld()))
    {
        if (!NavSys->GetNavDataForActor(nullptr)->IsPointInNavMesh(Location))
        {
            return false;
        }
    }

    return true;
}
```
  </action>
  <verify>
    ```bash
    # Check for _Validate on Server RPCs
    grep -c "_Validate" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Subsystems/GSDCrowdManagerSubsystem.h && echo "✓ _Validate functions present"

    # Check WithValidation specifier
    grep "Server.*WithValidation" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Subsystems/GSDCrowdManagerSubsystem.h && echo "✓ WithValidation specifier present"
    ```
  </verify>
  <done>
    - All Server RPCs have WithValidation specifier
    - All _Validate functions implemented
    - Validation logic prevents exploits
    - Helper functions for validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add RPC Validation to GSDVehicleSpawnerSubsystem</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
  </files>
  <action>
Add _Validate functions to vehicle spawner RPCs.

**RPCs to Validate:**
- Server_SpawnVehicle
- Server_ReturnVehicleToPool
- Server_SetVehicleEnabled

**Implementation:**
```cpp
bool UGSDVehicleSpawnerSubsystem::Server_SpawnVehicle_Validate(const FGSDVehicleSpawnParams& Params)
{
    // Validate vehicle config exists
    if (!Params.VehicleConfig)
    {
        UE_LOG(LogGSDVehicle, Warning, TEXT("Null vehicle config"));
        return false;
    }

    // Validate spawn location
    if (!IsValidSpawnLocation(Params.Transform.GetLocation()))
    {
        return false;
    }

    // Validate pool has capacity
    if (ActiveVehicles.Num() >= MaxActiveVehicles)
    {
        UE_LOG(LogGSDVehicle, Warning, TEXT("Vehicle pool at capacity"));
        return false;
    }

    return true;
}

bool UGSDVehicleSpawnerSubsystem::Server_ReturnVehicleToPool_Validate(int32 VehicleId)
{
    // Validate vehicle exists and is active
    if (!ActiveVehicles.Contains(VehicleId))
    {
        return false;
    }
    return true;
}
```
  </action>
  <verify>
    ```bash
    grep -c "_Validate" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h && echo "✓ Vehicle _Validate functions present"
    ```
  </verify>
  <done>
    - Vehicle spawn RPCs validated
    - Pool operations validated
    - Invalid configurations rejected
  </done>
</task>

<task type="auto">
  <name>Task 3: Add RPC Validation to GSDEventSpawnRegistry</name>
  <files>
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventSpawnRegistry.h
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/Subsystems/GSDEventSpawnRegistry.cpp
  </files>
  <action>
Add _Validate functions to event spawn registry RPCs.

**RPCs to Validate:**
- Server_RegisterEventSpawn
- Server_UnregisterEventSpawn
- Server_SetEventActive

**Implementation:**
```cpp
bool UGSDEventSpawnRegistry::Server_RegisterEventSpawn_Validate(
    const FGameplayTag& EventTag,
    const FTransform& SpawnTransform)
{
    // Validate event tag is valid
    if (!EventTag.IsValid())
    {
        return false;
    }

    // Validate spawn transform
    if (!SpawnTransform.IsValid())
    {
        return false;
    }

    // Validate event config exists for tag
    if (!GetEventConfigForTag(EventTag))
    {
        UE_LOG(LogGSDEvent, Warning, TEXT("No config for event tag: %s"), *EventTag.ToString());
        return false;
    }

    return true;
}

bool UGSDEventSpawnRegistry::Server_SetEventActive_Validate(
    const FGameplayTag& EventTag,
    bool bActive)
{
    // Validate event is registered
    if (!RegisteredEvents.Contains(EventTag))
    {
        return false;
    }
    return true;
}
```
  </action>
  <verify>
    ```bash
    grep -c "_Validate" Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/Subsystems/GSDEventSpawnRegistry.h && echo "✓ Event _Validate functions present"
    ```
  </verify>
  <done>
    - Event spawn RPCs validated
    - Tag validation implemented
    - Invalid events rejected
  </done>
</task>

<task type="auto">
  <name>Task 4: Create RPC Validation Test</name>
  <files>
    Plugins/GSD_Tests/Source/GSD_Tests/Private/Tests/GSDRPCValidationTests.cpp
  </files>
  <action>
Create automation tests to verify RPC validation logic.

**Test Cases:**
```cpp
IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDCrowdSpawnValidationTest,
    "GSD.Network.Crowd.SpawnValidation",
    EAutomationTestFlags::ProductFilter | EAutomationTestFlags::ContextMask)

bool FGSDCrowdSpawnValidationTest::RunTest(const FString& Parameters)
{
    UGSDCrowdManagerSubsystem* Subsystem = GetCrowdSubsystem();

    // Test 1: Valid spawn
    FCrowdSpawnParams ValidParams;
    ValidParams.Count = 50;
    ValidParams.Center = FVector::ZeroVector;
    ValidParams.Radius = 1000.0f;
    TestTrue("Valid spawn accepted", Subsystem->Server_SpawnCrowd_Validate(ValidParams));

    // Test 2: Invalid count (too high)
    FCrowdSpawnParams InvalidCount;
    InvalidCount.Count = 10000;  // Exceeds max
    InvalidCount.Center = FVector::ZeroVector;
    InvalidCount.Radius = 1000.0f;
    TestFalse("Invalid count rejected", Subsystem->Server_SpawnCrowd_Validate(InvalidCount));

    // Test 3: Invalid count (negative)
    FCrowdSpawnParams NegativeCount;
    NegativeCount.Count = -10;
    NegativeCount.Center = FVector::ZeroVector;
    NegativeCount.Radius = 1000.0f;
    TestFalse("Negative count rejected", Subsystem->Server_SpawnCrowd_Validate(NegativeCount));

    // Test 4: Invalid radius
    FCrowdSpawnParams InvalidRadius;
    InvalidRadius.Count = 50;
    InvalidRadius.Center = FVector::ZeroVector;
    InvalidRadius.Radius = -100.0f;
    TestFalse("Invalid radius rejected", Subsystem->Server_SpawnCrowd_Validate(InvalidRadius));

    return true;
}
```
  </action>
  <verify>
    ```bash
    if [ -f "Plugins/GSD_Tests/Source/GSD_Tests/Private/Tests/GSDRPCValidationTests.cpp" ]; then
      echo "✓ RPC validation tests created"
    fi
    ```
  </verify>
  <done>
    - Crowd RPC validation tests
    - Vehicle RPC validation tests
    - Event RPC validation tests
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. All Server RPCs have WithValidation specifier
2. All _Validate functions implemented
3. Invalid inputs are rejected
4. Valid inputs are accepted
5. Automation tests pass
</verification>

<success_criteria>
- All GSD subsystems have _Validate functions on Server RPCs
- WithValidation specifier on all Server RPCs
- Validation logic prevents:
  - Invalid spawn counts
  - Invalid locations
  - Null configurations
  - Out-of-bounds values
- RPC validation tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-production-enhancements/12-02-SUMMARY.md`
</output>
