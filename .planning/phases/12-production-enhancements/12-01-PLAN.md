---
phase: 12-production-enhancements
plan: 1
type: execute
wave: 1
depends_on: []
files_modified:
  - Plugins/GSD_Core/Source/GSD_Core/Public/Managers/GSDDeterminismManager.h
  - Plugins/GSD_Core/Source/GSD_Core/Private/Managers/GSDDeterminismManager.cpp
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDZombieBehaviorProcessor.cpp
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Subsystems/GSDCrowdManagerSubsystem.cpp
autonomous: true
must_haves:
  truths:
    - "All random calls use seeded FRandomStream"
    - "Same seed produces identical behavior"
    - "Random calls are categorized for debugging"
  artifacts:
    - path: "Plugins/GSD_Core/Source/GSD_Core/Public/Managers/GSDDeterminismManager.h"
      provides: "Seeded random streams"
      contains: "GetCategoryStream|RecordRandomCall"
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDZombieBehaviorProcessor.cpp"
      provides: "Deterministic behavior"
      contains: "GetCategoryStream|FRandomStream"
---

<objective>
Replace all unseeded random calls in crowd system with seeded FRandomStream from GSDDeterminismManager.

Purpose: Council review (unreal-determinism-rick) identified that crowd behavior uses FMath::VRand() and FMath::FRandRange() without seeded streams, causing non-deterministic replays. This plan integrates seeded random throughout the crowd system.

Output: All crowd random calls use seeded streams, enabling deterministic replays and debugging.

Council Issues: unreal-determinism-rick CRITICAL #1-5 - Unseeded random usage
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-production-enhancements/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance GSDDeterminismManager with Category Streams</name>
  <files>
    Plugins/GSD_Core/Source/GSD_Core/Public/Managers/GSDDeterminismManager.h
    Plugins/GSD_Core/Source/GSD_Core/Private/Managers/GSDDeterminismManager.cpp
  </files>
  <action>
Add GetCategoryStream() and RecordRandomCall() methods to GSDDeterminismManager.

**GSDDeterminismManager.h additions:**
```cpp
// Get reproducible random stream for a category
FRandomStream& GetCategoryStream(FName Category);

// Record random call for replay validation
void RecordRandomCall(FName Category, float Value);
void RecordRandomCall(FName Category, FVector Value);

// Get all recorded calls for debugging
const TArray<FRandomCallRecord>& GetRecordedCalls() const;

// Clear recorded calls
void ClearRecordedCalls();

protected:
    // Category-specific streams (seeded from main seed)
    TMap<FName, FRandomStream> CategoryStreams;

    // Recorded calls for validation
    TArray<FRandomCallRecord> RecordedCalls;
    bool bIsRecording = false;
```

**GSDDeterminismManager.cpp implementation:**
```cpp
FRandomStream& UGSDDeterminismManager::GetCategoryStream(FName Category)
{
    if (!CategoryStreams.Contains(Category))
    {
        // Derive category seed from main seed + category hash
        int32 CategorySeed = GlobalSeed + GetTypeHash(Category);
        CategoryStreams.Add(Category, FRandomStream(CategorySeed));
    }
    return CategoryStreams[Category];
}

void UGSDDeterminismManager::RecordRandomCall(FName Category, float Value)
{
    if (bIsRecording)
    {
        FRandomCallRecord Record;
        Record.Category = Category;
        Record.CallIndex = CallCounter++;
        Record.FloatValue = Value;
        RecordedCalls.Add(Record);
    }
}
```
  </action>
  <verify>
    ```bash
    grep -q "GetCategoryStream" Plugins/GSD_Core/Source/GSD_Core/Public/Managers/GSDDeterminismManager.h && echo "✓ GetCategoryStream added"
    grep -q "RecordRandomCall" Plugins/GSD_Core/Source/GSD_Core/Public/Managers/GSDDeterminismManager.h && echo "✓ RecordRandomCall added"
    ```
  </verify>
  <done>
    - GetCategoryStream() method added
    - RecordRandomCall() methods added
    - CategoryStreams map initialized
    - Recording system in place
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GSDZombieBehaviorProcessor to Use Seeded Random</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDZombieBehaviorProcessor.cpp
  </files>
  <action>
Replace all FMath:: random calls with seeded FRandomStream from DeterminismManager.

**Changes required:**

1. **Get DeterminismManager reference:**
```cpp
#include "Managers/GSDDeterminismManager.h"

// In Execute() or Initialize()
UGSDDeterminismManager* DeterminismManager = GetWorld()->GetGameInstance()->GetSubsystem<UGSDDeterminismManager>();
```

2. **Replace FMath::VRand():**
```cpp
// BEFORE:
WanderDirection = FMath::VRand();

// AFTER:
FRandomStream& WanderStream = DeterminismManager->GetCategoryStream("ZombieWander");
WanderDirection = WanderStream.VRand();
DeterminismManager->RecordRandomCall("ZombieWander", WanderDirection);
```

3. **Replace FMath::FRandRange():**
```cpp
// BEFORE:
float Distance = FMath::FRandRange(500.0f, 1500.0f);

// AFTER:
FRandomStream& TargetStream = DeterminismManager->GetCategoryStream("ZombieTarget");
float Distance = TargetStream.FRandRange(500.0f, 1500.0f);
DeterminismManager->RecordRandomCall("ZombieTarget", Distance);
```

**Random Categories to Create:**
- "ZombieWander" - Wander direction randomization
- "ZombieTarget" - Target selection distance
- "ZombieBehavior" - State transition timing
- "ZombieSpeed" - Speed variation
  </action>
  <verify>
    ```bash
    # Check for unseeded random calls
    UNSEEDED=$(grep -c "FMath::VRand\|FMath::FRand\|FMath::RandRange" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDZombieBehaviorProcessor.cpp || echo "0")
    echo "Unseeded random calls remaining: $UNSEEDED"

    # Check for seeded usage
    SEEDED=$(grep -c "GetCategoryStream" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDZombieBehaviorProcessor.cpp || echo "0")
    echo "Seeded stream usages: $SEEDED"
    ```
  </verify>
  <done>
    - All FMath::VRand() replaced with seeded VRand()
    - All FMath::FRandRange() replaced with seeded FRandRange()
    - DeterminismManager reference cached
    - Random calls recorded for debugging
  </done>
</task>

<task type="auto">
  <name>Task 3: Update GSDCrowdManagerSubsystem to Use Seeded Random</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Subsystems/GSDCrowdManagerSubsystem.cpp
    Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Subsystems/GSDCrowdManagerSubsystem.h
  </files>
  <action>
Update crowd spawning to use seeded random for determinism.

**Changes required:**

1. **Replace GetUniqueID() seed:**
```cpp
// BEFORE:
CrowdRandom.Initialize(GetUniqueID());

// AFTER:
void UGSDCrowdManagerSubsystem::Initialize(FSubsystemCollectionBase& Collection)
{
    Super::Initialize(Collection);

    // Get seed from determinism manager
    if (UGameInstance* GI = GetWorld()->GetGameInstance())
    {
        if (UGSDDeterminismManager* DetManager = GI->GetSubsystem<UGSDDeterminismManager>())
        {
            // Derive crowd-specific seed
            int32 CrowdSeed = DetManager->GetSeed() + GetTypeHash(FName("CrowdManager"));
            CrowdRandom.Initialize(CrowdSeed);
        }
    }
}
```

2. **Add seed parameter to SpawnCrowd:**
```cpp
UFUNCTION(BlueprintCallable, Category = "Crowd")
void SpawnCrowd(const FCrowdSpawnParams& Params, int32 OptionalSeed = 0);

// Implementation
void UGSDCrowdManagerSubsystem::SpawnCrowd(const FCrowdSpawnParams& Params, int32 OptionalSeed)
{
    FRandomStream& SpawnStream = DeterminismManager->GetCategoryStream("CrowdSpawn");

    // Use optional seed for specific spawn patterns
    if (OptionalSeed != 0)
    {
        SpawnStream.Initialize(OptionalSeed);
    }

    // Spawn with seeded positions
    for (int32 i = 0; i < Params.Count; i++)
    {
        FVector SpawnPos = Params.Center + SpawnStream.VRand() * Params.Radius;
        // ... spawn entity
    }
}
```

3. **Add random categories:**
- "CrowdSpawn" - Spawn position randomization
- "CrowdLOD" - LOD variation
- "CrowdVelocity" - Velocity randomization
  </action>
  <verify>
    ```bash
    # Check GetUniqueID is not used for seeding
    if grep -q "GetUniqueID()" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Subsystems/GSDCrowdManagerSubsystem.cpp; then
      echo "✗ Still using GetUniqueID() for seeding"
    else
      echo "✓ GetUniqueID() seeding removed"
    fi

    # Check DeterminismManager integration
    grep -q "GetCategoryStream\|GSDDeterminismManager" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Subsystems/GSDCrowdManagerSubsystem.cpp && echo "✓ DeterminismManager integrated"
    ```
  </verify>
  <done>
    - GetUniqueID() seeding removed
    - DeterminismManager integration added
    - SpawnCrowd accepts optional seed
    - All spawn randomization uses seeded streams
  </done>
</task>

<task type="auto">
  <name>Task 4: Update Crowd LOD Processor for Determinism</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp
  </files>
  <action>
Ensure LOD processor uses deterministic calculations.

**Changes required:**

1. **Cache DeterminismManager:**
```cpp
void UGSDCrowdLODProcessor::Initialize(UObject& Owner)
{
    Super::Initialize(Owner);

    if (UWorld* World = Owner.GetWorld())
    {
        if (UGameInstance* GI = World->GetGameInstance())
        {
            DeterminismManager = GI->GetSubsystem<UGSDDeterminismManager>();
        }
    }
}
```

2. **Add LOD variation with seeded random:**
```cpp
// If LOD distance needs variation (not recommended, but if required)
if (DeterminismManager && bUseLODVariation)
{
    FRandomStream& LODStream = DeterminismManager->GetCategoryStream("CrowdLOD");
    float Variation = LODStream.FRandRange(-VariationAmount, VariationAmount);
    EffectiveDistance += Variation;
}
```

**Note:** LOD distances should generally NOT vary - keep deterministic for consistency.
  </action>
  <verify>
    ```bash
    # Check for unseeded random in LOD processor
    UNSEEDED=$(grep -c "FMath::FRand\|FMath::VRand" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp || echo "0")
    echo "Unseeded random in LOD processor: $UNSEEDED"
    ```
  </verify>
  <done>
    - LOD processor reviewed for random usage
    - Any necessary random calls use seeded streams
    - DeterminismManager cached
  </done>
</task>

<task type="auto">
  <name>Task 5: Create Determinism Test</name>
  <files>
    Plugins/GSD_Tests/Source/GSD_Tests/Private/Tests/GSDDeterminismIntegrationTests.cpp
  </files>
  <action>
Create automation tests to verify deterministic behavior.

**Test 1: Same Seed Produces Same Results**
```cpp
IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDSeededCrowdDeterminismTest,
    "GSD.Determinism.Crowd.SameSeed",
    EAutomationTestFlags::ProductFilter | EAutomationTestFlags::ContextMask)

bool FGSDSeededCrowdDeterminismTest::RunTest(const FString& Parameters)
{
    // Seed 1
    DeterminismManager->InitializeWithSeed(12345);
    TArray<FVector> Positions1;
    for (int32 i = 0; i < 100; i++)
    {
        Positions1.Add(DeterminismManager->GetCategoryStream("CrowdSpawn").VRand() * 1000.0f);
    }

    // Seed 2 (same)
    DeterminismManager->InitializeWithSeed(12345);
    TArray<FVector> Positions2;
    for (int32 i = 0; i < 100; i++)
    {
        Positions2.Add(DeterminismManager->GetCategoryStream("CrowdSpawn").VRand() * 1000.0f);
    }

    // Compare
    for (int32 i = 0; i < 100; i++)
    {
        TestEqual("Positions match", Positions1[i], Positions2[i]);
    }

    return true;
}
```

**Test 2: Different Seeds Produce Different Results**
```cpp
IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDSeededCrowdVariationTest,
    "GSD.Determinism.Crowd.DifferentSeeds",
    EAutomationTestFlags::ProductFilter | EAutomationTestFlags::ContextMask)

bool FGSDSeededCrowdVariationTest::RunTest(const FString& Parameters)
{
    // Seed 1
    DeterminismManager->InitializeWithSeed(12345);
    FVector Pos1 = DeterminismManager->GetCategoryStream("CrowdSpawn").VRand();

    // Seed 2 (different)
    DeterminismManager->InitializeWithSeed(54321);
    FVector Pos2 = DeterminismManager->GetCategoryStream("CrowdSpawn").VRand();

    // Should be different
    TestNotEqual("Positions differ", Pos1, Pos2);

    return true;
}
```
  </action>
  <verify>
    ```bash
    # Check test file exists
    if [ -f "Plugins/GSD_Tests/Source/GSD_Tests/Private/Tests/GSDDeterminismIntegrationTests.cpp" ]; then
      echo "✓ Determinism integration tests created"
    else
      echo "✗ Test file not found"
    fi
    ```
  </verify>
  <done>
    - Same-seed determinism test created
    - Different-seed variation test created
    - Tests pass in automation runner
  </done>
</task>

</tasks>

<verification>
1. All crowd random calls use seeded streams
2. Same seed produces identical behavior
3. Different seeds produce different behavior
4. DeterminismManager integration complete
5. Automation tests pass
</verification>

<success_criteria>
- GetCategoryStream() method available in GSDDeterminismManager
- All FMath::VRand() and FMath::FRandRange() replaced in crowd processors
- SpawnCrowd uses seeded random for positions
- Determinism tests pass (same seed = same results)
- No unseeded random calls in crowd code
</success_criteria>

<output>
After completion, create `.planning/phases/12-production-enhancements/12-01-SUMMARY.md`
</output>
