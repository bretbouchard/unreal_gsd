---
phase: 06-crowd-core-systems
plan: 05
type: execute
wave: 5
depends_on: ["06-04"]
files_modified:
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDCrowdTestbedActor.cpp
autonomous: true
must_haves:
  truths:
    - "Testbed actor spawns 200+ entities for validation"
    - "FPS is tracked and averaged over 60 frames"
    - "Deterministic spawning with seeded randomization"
    - "Performance warnings logged when FPS drops below target"
  artifacts:
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h"
      provides: "Crowd testbed actor"
      contains: "AActor"
      min_lines: 80
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDCrowdTestbedActor.cpp"
      provides: "Testbed implementation"
      contains: "SpawnTestEntities"
      min_lines: 150
  key_links:
    - from: "GSDCrowdTestbedActor"
      to: "GSDCrowdManagerSubsystem"
      via: "GetSubsystem"
      pattern: "GetSubsystem.*GSDCrowdManagerSubsystem"
    - from: "GSDCrowdTestbedActor::Tick"
      to: "CurrentFPS"
      via: "DeltaTime tracking"
      pattern: "CurrentFPS.*1.0f.*DeltaTime"
---

<objective>
Create crowd testbed actor for validation and performance testing.

Purpose: Provide a testbed actor (following GSDVehicleTestbedActor pattern) that spawns 200+ crowd entities and tracks FPS to validate performance. This is the primary validation tool for Phase 6 success criteria.

Output: AGSDCrowdTestbedActor that spawns 200+ entities and validates target framerate is maintained.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-crowd-core-systems/06-RESEARCH.md

# Reference: Vehicle testbed pattern
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehicleTestbedActor.h
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehicleTestbedActor.cpp

# Crowd manager subsystem from plan 04
@.planning/phases/06-crowd-core-systems/06-04-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Create crowd testbed actor</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Actors/GSDCrowdTestbedActor.h
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Actors/GSDCrowdTestbedActor.cpp
  </files>
  <action>
    Create AGSDCrowdTestbedActor following the GSDVehicleTestbedActor pattern:

    **Header** (GSDCrowdTestbedActor.h):
    ```cpp
    #pragma once
    #include "CoreMinimal.h"
    #include "GameFramework/Actor.h"
    #include "GSDCrowdTestbedActor.generated.h"

    class UGSDCrowdEntityConfig;
    class UGSDCrowdManagerSubsystem;

    /**
     * Crowd testbed actor for validation and performance testing.
     *
     * Spawns 200+ (configurable) crowd entities in a defined area for testing:
     * - Mass Entity spawning performance
     * - FPS tracking with entity count
     * - LOD representation switching validation
     * - Deterministic spawning with seeded randomization
     *
     * Usage:
     * 1. Place actor in level
     * 2. Configure NumEntitiesToSpawn (default: 200)
     * 3. Call SpawnTestEntities() or enable bAutoSpawnOnBeginPlay
     * 4. Monitor FPS and entity count
     * 5. Verify LOD switching at different camera distances
     */
    UCLASS(BlueprintType, Blueprintable, Category = "GSD|Crowds")
    class GSD_CROWDS_API AGSDCrowdTestbedActor : public AActor
    {
        GENERATED_BODY()

    public:
        AGSDCrowdTestbedActor();

        //-- Configuration --

        /** Entity config to use for spawning (uses default if null) */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed")
        TObjectPtr<UGSDCrowdEntityConfig> EntityConfig;

        /** Number of entities to spawn */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed", meta = (ClampMin = "1", ClampMax = "1000"))
        int32 NumEntitiesToSpawn = 200;

        /** Spawn area radius (entities placed randomly within circle) */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed", meta = (ClampMin = "100.0", ClampMax = "50000.0"))
        float SpawnRadius = 10000.0f;

        /** Auto-spawn on BeginPlay */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed")
        bool bAutoSpawnOnBeginPlay = false;

        /** Seed for reproducible spawns */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed", meta = (EditCondition = "bUseDeterministicSeed"))
        int32 RandomSeed = 42;

        /** Whether to use deterministic seed */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed")
        bool bUseDeterministicSeed = true;

        /** Target FPS for performance validation */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed")
        float TargetFPS = 60.0f;

        /** Log warning if FPS drops below target */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed")
        bool bLogPerformanceWarnings = true;

        /** Performance warning threshold (percentage below target FPS) */
        UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Testbed", meta = (ClampMin = "0.0", ClampMax = "50.0"))
        float PerformanceWarningThreshold = 10.0f;

        //-- Actions --

        /** Spawn all test entities */
        UFUNCTION(BlueprintCallable, Category = "Testbed")
        void SpawnTestEntities();

        /** Despawn all test entities */
        UFUNCTION(BlueprintCallable, Category = "Testbed")
        void DespawnTestEntities();

        /** Respawn with new random positions */
        UFUNCTION(BlueprintCallable, Category = "Testbed")
        void RespawnTestEntities();

        //-- Statistics --

        /** Get current FPS */
        UFUNCTION(BlueprintPure, Category = "Testbed")
        float GetCurrentFPS() const { return CurrentFPS; }

        /** Get spawned entity count */
        UFUNCTION(BlueprintPure, Category = "Testbed")
        int32 GetSpawnedEntityCount() const;

        /** Get average frame time over last 60 frames */
        UFUNCTION(BlueprintPure, Category = "Testbed")
        float GetAverageFrameTime() const;

        /** Get average FPS (1.0 / GetAverageFrameTime()) */
        UFUNCTION(BlueprintPure, Category = "Testbed")
        float GetAverageFPS() const;

        /** Check if performance meets target */
        UFUNCTION(BlueprintPure, Category = "Testbed")
        bool IsPerformanceAcceptable() const;

    protected:
        // ~AActor interface
        virtual void BeginPlay() override;
        virtual void Tick(float DeltaTime) override;
        // ~End of AActor interface

    private:
        /** Cached crowd manager subsystem */
        UPROPERTY()
        TObjectPtr<UGSDCrowdManagerSubsystem> CrowdManager;

        /** Current FPS calculated from delta time */
        float CurrentFPS = 0.0f;

        /** Frame time history for averaging */
        TArray<float> FrameTimeHistory;

        /** Maximum frames to keep in history */
        int32 MaxFrameTimeHistory = 60;

        /** Last performance warning time (for throttling) */
        float LastPerformanceWarningTime = 0.0f;

        /** Performance warning cooldown (seconds) */
        float PerformanceWarningCooldown = 5.0f;

        /**
         * Get crowd manager subsystem (lazy initialization).
         *
         * @return Crowd manager, or nullptr if not available
         */
        UGSDCrowdManagerSubsystem* GetCrowdManager();

        /**
         * Update FPS metrics from delta time.
         *
         * @param DeltaTime Frame delta time
         */
        void UpdateFPSMetrics(float DeltaTime);

        /**
         * Check and log performance warnings.
         */
        void CheckPerformanceWarnings();
    };
    ```

    **Implementation** (GSDCrowdTestbedActor.cpp):
    ```cpp
    #include "Actors/GSDCrowdTestbedActor.h"
    #include "Subsystems/GSDCrowdManagerSubsystem.h"
    #include "DataAssets/GSDCrowdEntityConfig.h"
    #include "GSDCrowdLog.h"

    AGSDCrowdTestbedActor::AGSDCrowdTestbedActor()
    {
        PrimaryActorTick.bCanEverTick = true;

        // Initialize frame time history
        FrameTimeHistory.Reserve(MaxFrameTimeHistory);
    }

    void AGSDCrowdTestbedActor::BeginPlay()
    {
        Super::BeginPlay();

        UE_LOG(LOG_GSDCROWDS, Log, TEXT("GSDCrowdTestbedActor initialized - Target: %d entities, Radius: %.1f, Target FPS: %.1f"),
            NumEntitiesToSpawn, SpawnRadius, TargetFPS);

        if (bAutoSpawnOnBeginPlay)
        {
            SpawnTestEntities();
        }
    }

    void AGSDCrowdTestbedActor::Tick(float DeltaTime)
    {
        Super::Tick(DeltaTime);

        // Update FPS metrics
        UpdateFPSMetrics(DeltaTime);

        // Check performance warnings
        if (bLogPerformanceWarnings)
        {
            CheckPerformanceWarnings();
        }
    }

    void AGSDCrowdTestbedActor::SpawnTestEntities()
    {
        UGSDCrowdManagerSubsystem* Manager = GetCrowdManager();
        if (!Manager)
        {
            UE_LOG(LOG_GSDCROWDS, Error, TEXT("SpawnTestEntities: Crowd manager not available"));
            return;
        }

        // Set random seed if using deterministic spawning
        if (bUseDeterministicSeed)
        {
            FMath::SRandInit(RandomSeed);
            UE_LOG(LOG_GSDCROWDS, Log, TEXT("Using deterministic seed: %d"), RandomSeed);
        }

        // Spawn entities
        const FVector SpawnCenter = GetActorLocation();
        const int32 NumSpawned = Manager->SpawnEntities(NumEntitiesToSpawn, SpawnCenter, SpawnRadius, EntityConfig);

        UE_LOG(LOG_GSDCROWDS, Log, TEXT("Spawned %d/%d entities at center %s"),
            NumSpawned, NumEntitiesToSpawn, *SpawnCenter.ToString());

        // Clear frame time history for fresh FPS measurement
        FrameTimeHistory.Empty();
    }

    void AGSDCrowdTestbedActor::DespawnTestEntities()
    {
        UGSDCrowdManagerSubsystem* Manager = GetCrowdManager();
        if (!Manager)
        {
            return;
        }

        Manager->DespawnAllEntities();

        UE_LOG(LOG_GSDCROWDS, Log, TEXT("Despawned all test entities"));
    }

    void AGSDCrowdTestbedActor::RespawnTestEntities()
    {
        DespawnTestEntities();
        SpawnTestEntities();
    }

    int32 AGSDCrowdTestbedActor::GetSpawnedEntityCount() const
    {
        if (UGSDCrowdManagerSubsystem* Manager = const_cast<AGSDCrowdTestbedActor*>(this)->GetCrowdManager())
        {
            return Manager->GetActiveEntityCount();
        }
        return 0;
    }

    float AGSDCrowdTestbedActor::GetAverageFrameTime() const
    {
        if (FrameTimeHistory.Num() == 0)
        {
            return 0.0f;
        }

        float TotalFrameTime = 0.0f;
        for (float FrameTime : FrameTimeHistory)
        {
            TotalFrameTime += FrameTime;
        }

        return TotalFrameTime / static_cast<float>(FrameTimeHistory.Num());
    }

    float AGSDCrowdTestbedActor::GetAverageFPS() const
    {
        const float AvgFrameTime = GetAverageFrameTime();
        if (AvgFrameTime > 0.0f)
        {
            return 1.0f / AvgFrameTime;
        }
        return 0.0f;
    }

    bool AGSDCrowdTestbedActor::IsPerformanceAcceptable() const
    {
        const float AvgFPS = GetAverageFPS();
        const float MinAcceptableFPS = TargetFPS * (1.0f - PerformanceWarningThreshold / 100.0f);
        return AvgFPS >= MinAcceptableFPS;
    }

    UGSDCrowdManagerSubsystem* AGSDCrowdTestbedActor::GetCrowdManager()
    {
        if (!CrowdManager)
        {
            UWorld* World = GetWorld();
            if (World)
            {
                CrowdManager = World->GetSubsystem<UGSDCrowdManagerSubsystem>();
            }
        }
        return CrowdManager;
    }

    void AGSDCrowdTestbedActor::UpdateFPSMetrics(float DeltaTime)
    {
        // Calculate current FPS
        if (DeltaTime > 0.0f)
        {
            CurrentFPS = 1.0f / DeltaTime;
        }

        // Add to history
        FrameTimeHistory.Add(DeltaTime);

        // Trim history to max size
        if (FrameTimeHistory.Num() > MaxFrameTimeHistory)
        {
            FrameTimeHistory.RemoveAt(0, FrameTimeHistory.Num() - MaxFrameTimeHistory);
        }
    }

    void AGSDCrowdTestbedActor::CheckPerformanceWarnings()
    {
        // Only check after we have enough samples
        if (FrameTimeHistory.Num() < 30)
        {
            return;
        }

        // Throttle warnings
        UWorld* World = GetWorld();
        if (!World)
        {
            return;
        }

        const float CurrentTime = World->GetTimeSeconds();
        if (CurrentTime - LastPerformanceWarningTime < PerformanceWarningCooldown)
        {
            return;
        }

        // Check if FPS is below threshold
        const float AvgFPS = GetAverageFPS();
        const float MinAcceptableFPS = TargetFPS * (1.0f - PerformanceWarningThreshold / 100.0f);

        if (AvgFPS < MinAcceptableFPS)
        {
            const int32 EntityCount = GetSpawnedEntityCount();
            UE_LOG(LOG_GSDCROWDS, Warning,
                TEXT("PERFORMANCE WARNING: Average FPS %.1f below target %.1f (threshold: %.1f) with %d entities"),
                AvgFPS, TargetFPS, MinAcceptableFPS, EntityCount);

            LastPerformanceWarningTime = CurrentTime;
        }
    }
    ```

    **Key patterns from GSDVehicleTestbedActor:**
    - FRandomStream for deterministic spawning (seeded randomization)
    - Frame time history tracking (60 frames for averaging)
    - Performance warning throttling (5 second cooldown)
    - Lazy subsystem initialization (GetCrowdManager)
    - Blueprint-callable actions (SpawnTestEntities, DespawnTestEntities)
    - Blueprint-pure statistics (GetCurrentFPS, GetAverageFPS)

    **Validation Success Criteria:**
    - Spawn 200+ entities
    - Maintain 60 FPS (or configured TargetFPS)
    - Average FPS over 60 frames
    - Log warnings when FPS drops below threshold

    **File structure:**
    - Public/Actors/GSDCrowdTestbedActor.h
    - Private/Actors/GSDCrowdTestbedActor.cpp
  </action>
  <verify>
    # Actor compiles and can be placed in level
    # SpawnTestEntities spawns entities via CrowdManager
    # FPS metrics calculated correctly
    # Performance warnings logged when FPS drops

    # In editor testbed map:
    # 1. Place GSDCrowdTestbedActor in level
    # 2. Set NumEntitiesToSpawn = 200
    # 3. Set bAutoSpawnOnBeginPlay = true
    # 4. Play in editor
    # 5. Check Output Log for spawn count and FPS
    # 6. Verify FPS >= 60 with 200 entities
  </verify>
  <done>
    - AGSDCrowdTestbedActor compiles
    - Spawns 200+ entities on command
    - FPS tracked and averaged over 60 frames
    - Performance warnings logged when FPS drops
    - Deterministic spawning with seeded randomization
    - Follows GSDVehicleTestbedActor pattern
  </done>
</task>

</tasks>

<verification>
1. Actor compiles and is placeable in level
2. SpawnTestEntities spawns entities via crowd manager
3. FPS calculated from delta time correctly
4. Frame time history maintained (60 frames)
5. Performance warnings logged when FPS drops below threshold
6. GetAverageFPS returns correct value
</verification>

<success_criteria>
- AGSDCrowdTestbedActor created following vehicle testbed pattern
- Can spawn 200+ entities in circular spawn area
- FPS tracked and averaged over 60 frames
- Performance warnings logged when FPS drops below target
- Deterministic spawning with seeded randomization
- Blueprint-callable actions and pure statistics
</success_criteria>

<output>
After completion, create `.planning/phases/06-crowd-core-systems/06-05-SUMMARY.md`
</output>
