---
phase: 06-crowd-core-systems
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/DataAssets/GSDCrowdEntityConfig.cpp
autonomous: true
must_haves:
  truths:
    - "Mass Entity Config Asset defines zombie entity composition"
    - "Velocity Randomizer trait prevents synchronized movement"
    - "LOD representation fragments are included in entity definition"
    - "Entity config references all required fragments and processors"
  artifacts:
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h"
      provides: "Entity configuration Data Asset"
      contains: "UMassEntityConfigAsset"
      min_lines: 50
    - path: "Plugins/GSD_Crowds/Content/GSD_Crowds/EntityConfigs/BP_GSDZombieEntityConfig.uasset"
      provides: "Blueprint-configured zombie entity"
      contains: "Mass Entity Config"
  key_links:
    - from: "GSDCrowdEntityConfig"
      to: "FGSDZombieStateFragment"
      via: "GetFragmentTypes"
      pattern: "AddFragment.*FGSDZombieStateFragment"
    - from: "GSDCrowdEntityConfig"
      to: "VelocityRandomizer"
      via: "AddTrait"
      pattern: "Velocity.*Randomizer"
---

<objective>
Create Mass Entity Config Asset that defines zombie entity composition.

Purpose: Configure Mass Entity to understand what fragments and processors make up a zombie entity. This is the blueprint that Mass Entity uses to spawn and manage entities. CRITICAL: Must include Velocity Randomizer to prevent synchronized movement.

Output: Data Asset class and Blueprint-configured zombie entity definition with LOD representation support.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-crowd-core-systems/06-RESEARCH.md

# Fragment types from plan 02
@.planning/phases/06-crowd-core-systems/06-02-PLAN.md

# Reference: Vehicle config pattern
@Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/DataAssets/GSDVehicleConfig.h
</context>

<tasks>

<task type="auto">
  <name>Create crowd entity config Data Asset</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDCrowdEntityConfig.h
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/DataAssets/GSDCrowdEntityConfig.cpp
  </files>
  <action>
    Create UGSDCrowdEntityConfig as a Mass Entity Config Asset:

    **Header** (GSDCrowdEntityConfig.h):
    ```cpp
    #pragma once
    #include "MassEntityConfigAsset.h"
    #include "GSDCrowdEntityConfig.generated.h"

    class UMassEntityConfigAsset;
    class UStaticMesh;

    /**
     * Data Asset defining crowd entity configuration for Mass Entity.
     *
     * This config defines what fragments and processors a crowd entity has.
     * Used by Mass Spawner to create entities with the correct composition.
     *
     * CRITICAL: Always add Velocity Randomizer trait to prevent synchronized movement.
     * See RESEARCH.md Pitfall 1 for details.
     */
    UCLASS(BlueprintType, Category = "GSD|Crowds")
    class GSD_CROWDS_API UGSDCrowdEntityConfig : public UMassEntityConfigAsset
    {
        GENERATED_BODY()

    public:
        UGSDCrowdEntityConfig();

        //-- Fragment Configuration --
        // Fragments are added via C++ or Blueprint in Mass Entity Config

        //-- Velocity Randomization (CRITICAL) --
        UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Movement")
        float BaseVelocity = 150.0f;

        UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Movement")
        float VelocityRandomRange = 0.2f;

        //-- LOD Representation --
        UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "LOD")
        TObjectPtr<UStaticMesh> HighDetailMesh;

        UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "LOD")
        TObjectPtr<UStaticMesh> LowDetailMesh;

        UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "LOD")
        TObjectPtr<UStaticMesh> ISMMesh;

        //-- Default Configuration --
        virtual void PostInitProperties() override;

    protected:
        // ~UMassEntityConfigAsset interface
        virtual void ConfigureFragmentTypes() override;
        // ~End of UMassEntityConfigAsset interface
    };
    ```

    **Implementation** (GSDCrowdEntityConfig.cpp):
    ```cpp
    #include "DataAssets/GSDCrowdEntityConfig.h"
    #include "Fragments/GSDZombieStateFragment.h"
    #include "MassRepresentationFragments.h"
    #include "MassCommonFragments.h"
    #include "GSDCrowdLog.h"

    UGSDCrowdEntityConfig::UGSDCrowdEntityConfig()
    {
        // Set default velocity randomization
        BaseVelocity = 150.0f;
        VelocityRandomRange = 0.2f;
    }

    void UGSDCrowdEntityConfig::PostInitProperties()
    {
        Super::PostInitProperties();

        // Log configuration for debugging
        UE_LOG(LOG_GSDCROWDS, Log, TEXT("GSDCrowdEntityConfig initialized - BaseVelocity: %.1f, RandomRange: %.2f"),
            BaseVelocity, VelocityRandomRange);
    }

    void UGSDCrowdEntityConfig::ConfigureFragmentTypes()
    {
        // Add required fragments for crowd entities

        // Core transform fragment (required by Mass Entity)
        AddFragment<FDataFragment_Transform>();

        // Custom zombie state
        AddFragment<FGSDZombieStateFragment>();

        // LOD representation fragments
        AddFragment<FMassRepresentationFragment>();
        AddFragment<FMassRepresentationLODFragment>();

        // CRITICAL: Add Velocity Randomizer trait
        // This prevents all entities from moving in perfect synchronization
        // See RESEARCH.md Pitfall 1 for details
        // Note: Velocity Randomizer is added as a trait in Blueprint, not C++
        // The BaseVelocity and VelocityRandomRange properties are used by the trait

        UE_LOG(LOG_GSDCROWDS, Log, TEXT("Configured GSDCrowdEntityConfig fragments"));
    }
    ```

    **Key design decisions:**
    - Inherits from UMassEntityConfigAsset (standard UE5 pattern)
    - ConfigureFragmentTypes() defines entity composition
    - BaseVelocity + VelocityRandomRange expose settings for Blueprint trait
    - LOD meshes configured per entity type
    - PostInitProperties logs configuration for debugging

    **CRITICAL Pattern from RESEARCH.md:**
    - Velocity Randomizer is a TRAIT (configured in Blueprint)
    - C++ exposes properties (BaseVelocity, VelocityRandomRange)
    - Blueprint applies trait with these values
    - Without this: All zombies move in perfect sync (unnatural)

    **File structure:**
    - Public/DataAssets/GSDCrowdEntityConfig.h
    - Private/DataAssets/GSDCrowdEntityConfig.cpp
  </action>
  <verify>
    # Data Asset class compiles
    # ConfigureFragmentTypes adds required fragments
    # PostInitProperties logs configuration

    # In Unreal Editor:
    # 1. Create Blueprint based on GSDCrowdEntityConfig
    # 2. Configure Velocity Randomizer trait
    # 3. Assign LOD meshes
    # 4. Verify fragment list shows all required fragments
  </verify>
  <done>
    - UGSDCrowdEntityConfig compiles
    - Fragment types configured (Transform, ZombieState, Representation, LOD)
    - Velocity randomization properties exposed
    - LOD mesh properties exposed
    - PostInitProperties logs configuration
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>
    Created UGSDCrowdEntityConfig Data Asset class for Mass Entity configuration.
    This defines zombie entity composition with fragments, processors, and LOD representation.
  </what-built>
  <how-to-verify>
    1. Open Unreal Editor
    2. Create new Blueprint Class -> select GSDCrowdEntityConfig as parent
    3. Name it "BP_GSDZombieEntityConfig"
    4. Save in: Content/GSD_Crowds/EntityConfigs/

    5. Configure the Blueprint:
       a. In "Details" panel, find "Movement" category:
          - Base Velocity: 150.0
          - Velocity Random Range: 0.2

       b. In "Mass Entity Config" section:
          - Click "Add Trait" button
          - Search for "Velocity Randomizer"
          - Add it
          - Set Base Velocity: 150.0
          - Set Random Range: 0.2

       c. In "LOD" category (after meshes are created):
          - Assign High Detail Mesh (placeholder for now)
          - Assign Low Detail Mesh (placeholder for now)
          - Assign ISM Mesh (placeholder for now)

       d. Verify fragments list shows:
          - DataFragment_Transform
          - GSDZombieStateFragment
          - MassRepresentationFragment
          - MassRepresentationLODFragment

    6. Compile and save the Blueprint
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. UGSDCrowdEntityConfig compiles and is Blueprint-accessible
2. Blueprint entity config created with all required fragments
3. Velocity Randomizer trait added (CRITICAL for natural movement)
4. Fragment list matches ConfigureFragmentTypes()
5. LOD mesh properties configured
</verification>

<success_criteria>
- GSDCrowdEntityConfig Data Asset class created
- Blueprint entity config created: BP_GSDZombieEntityConfig
- All required fragments configured (Transform, State, Representation, LOD)
- Velocity Randomizer trait added to prevent synchronized movement
- Blueprint saved in Content/GSD_Crowds/EntityConfigs/
</success_criteria>

<output>
After completion, create `.planning/phases/06-crowd-core-systems/06-03-SUMMARY.md`
</output>
