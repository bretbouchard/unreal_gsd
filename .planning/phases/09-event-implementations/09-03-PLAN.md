---
phase: 09-event-implementations
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventBonfireConfig.h
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBonfireConfig.cpp
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/GSD_DailyEvents.Build.cs
  - Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_BonfireEvent.uasset
autonomous: true

must_haves:
  truths:
    - "Bonfire event spawns Niagara FX at location"
    - "Zombie density is reduced in area around bonfire"
    - "FX scales with event intensity"
    - "Density modifier is removed when event ends"
    - "Event data asset file exists and is configurable in editor"
  artifacts:
    - path: "Plugins/GSD_DailyEvents/.../Events/GSDEventBonfireConfig.h"
      provides: "Bonfire event definition (EVT-06)"
      exports: ["UGSDEventBonfireConfig"]
      contains: "UNiagaraComponent"
    - path: "Plugins/GSD_DailyEvents/.../Events/GSDEventBonfireConfig.cpp"
      provides: "Bonfire event implementation"
      contains: "SpawnSystemAtLocation"
    - path: "Plugins/GSD_DailyEvents/.../GSD_DailyEvents.Build.cs"
      provides: "Niagara module dependency"
      contains: "Niagara"
    - path: "Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_BonfireEvent.uasset"
      provides: "Configurable event instance for designers"
      contains: "UGSDEventBonfireConfig"
  key_links:
    - from: "GSDEventBonfireConfig::OnEventStart"
      to: "UNiagaraFunctionLibrary::SpawnSystemAtLocation"
      via: "FX spawning"
      pattern: "SpawnSystemAtLocation"
    - from: "GSDEventBonfireConfig::OnEventStart"
      to: "GSDDensityReduceModifier::ApplyModifier"
      via: "Density reduction"
      pattern: "ApplyModifier"
    - from: "GSDEventBonfireConfig::OnEventEnd"
      to: "UNiagaraComponent::Deactivate"
      via: "FX cleanup"
      pattern: "Deactivate\\(\\)"
---

<objective>
Implement Bonfire event (EVT-06) that spawns visual FX and reduces zombie density locally.

Purpose: Bonfire events create temporary safe havens where zombie density is reduced, giving players breathing room.
Output: UGSDEventBonfireConfig that spawns Niagara FX and applies density reduction modifier. Plus data asset instance for editor configuration.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Phase 9 Context (Modifiers)

@.planning/phases/09-event-implementations/09-01-PLAN.md

**DensityReduceModifier available** for reducing zombie density.

## Research Context

@.planning/phases/09-event-implementations/09-RESEARCH.md

**Niagara FX Spawning Pattern:**
```cpp
#include "NiagaraFunctionLibrary.h"
#include "NiagaraComponent.h"

UNiagaraComponent* FXComponent = UNiagaraFunctionLibrary::SpawnSystemAtLocation(
    WorldContext,
    NiagaraSystem,
    Location,
    FRotator::ZeroRotator,
    FVector(Intensity),
    true,  // bAutoDestroy
    true,  // bAutoActivate
    ENCPoolMethod::None,
    true   // bPreCullCheck
);
```

**Pitfall 4 - Niagara Component Lifetime Issues:**
- Choose one: bAutoDestroy=true (no manual cleanup) OR bAutoDestroy=false (manual Deactivate/Destroy)
- Set pointer to nullptr after cleanup
- Check pointer validity before use

**Pitfall 2 - Modifier State Leak:**
- Always pair Apply with Remove
- Remove modifiers even if context is null
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Niagara Dependency to Build.cs</name>
  <files>
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/GSD_DailyEvents.Build.cs
  </files>
  <action>
Add Niagara module to public dependencies for FX spawning.

**Update GSD_DailyEvents.Build.cs:**
```cpp
PublicDependencyModuleNames.AddRange(new string[] {
    "Core",
    "CoreUObject",
    "Engine",
    "GSD_Core",
    "GSD_CityStreaming",
    "GSD_Crowds",
    "GameplayTags",
    "Niagara",           // ADD THIS - for UNiagaraFunctionLibrary
    "AudioMixer",
    "ZoneGraph",
    "MassEntity"
});
```

**Why:** UNiagaraFunctionLibrary requires Niagara module linkage.
</action>
  <verify>
    # Verify Niagara in dependencies
    grep -q '"Niagara"' Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/GSD_DailyEvents.Build.cs
    echo "Niagara dependency added"
  </verify>
  <done>GSD_DailyEvents.Build.cs includes Niagara module dependency</done>
</task>

<task type="auto">
  <name>Task 2: Create Bonfire Event Config</name>
  <files>
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventBonfireConfig.h
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBonfireConfig.cpp
  </files>
  <action>
Create UGSDEventBonfireConfig that implements EVT-06: Bonfire event spawns FX and modifies zombie density locally.

**Header (GSDEventBonfireConfig.h):**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "DataAssets/GSDDailyEventConfig.h"
#include "GSDEventBonfireConfig.generated.h"

class UNiagaraSystem;
class UNiagaraComponent;
class UGSDDensityReduceModifier;

/**
 * Bonfire event configuration.
 * Spawns visual FX and reduces zombie density locally.
 *
 * EVT-06: Bonfire event spawns FX and modifies zombie density locally
 */
UCLASS(BlueprintType, Category = "GSD|Events")
class GSD_DAILYEVENTS_API UGSDEventBonfireConfig : public UGSDDailyEventConfig
{
    GENERATED_BODY()

public:
    UGSDEventBonfireConfig();

    //-- VFX Settings --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "VFX")
    TObjectPtr<UNiagaraSystem> BonfireFX;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "VFX")
    FVector FXScale = FVector(1.0f);

    //-- Density Reduction --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Density")
    TObjectPtr<UGSDDensityReduceModifier> DensityReducer;

    //-- UGSDDailyEventConfig Interface --
    virtual bool ValidateConfig(FString& OutError) const override;
    virtual void OnEventStart_Implementation(UObject* WorldContext, FVector Location, float Intensity) override;
    virtual void OnEventEnd_Implementation(UObject* WorldContext) override;

protected:
    /** Spawned FX component for cleanup */
    UPROPERTY()
    TObjectPtr<UNiagaraComponent> SpawnedFXComponent;

    /** Event center for modifier removal */
    FVector EventCenter;
};
```

**Implementation (GSDEventBonfireConfig.cpp):**
```cpp
#include "DataAssets/Events/GSDEventBonfireConfig.h"
#include "Modifiers/GSDDensityReduceModifier.h"
#include "NiagaraFunctionLibrary.h"
#include "NiagaraComponent.h"

UGSDEventBonfireConfig::UGSDEventBonfireConfig()
{
    EventTag = FGameplayTag::RequestGameplayTag(FName("Event.Daily.Bonfire"));
    DurationMinutes = 30.0f;  // Bonfires last 30 minutes by default
}

bool UGSDEventBonfireConfig::ValidateConfig(FString& OutError) const
{
    if (!Super::ValidateConfig(OutError))
    {
        return false;
    }

    // Specific validation for Bonfire event
    if (!BonfireFX)
    {
        OutError = TEXT("Bonfire event requires BonfireFX (NiagaraSystem) to be set");
        return false;
    }

    if (!DensityReducer)
    {
        OutError = TEXT("Bonfire event requires DensityReducer to be set");
        return false;
    }

    return true;
}

void UGSDEventBonfireConfig::OnEventStart_Implementation(UObject* WorldContext, FVector Location, float Intensity)
{
    EventCenter = Location;

    // Spawn Niagara FX at location
    if (BonfireFX)
    {
        FVector EffectiveScale = FXScale * FMath::Max(0.1f, Intensity);

        SpawnedFXComponent = UNiagaraFunctionLibrary::SpawnSystemAtLocation(
            WorldContext,
            BonfireFX,
            Location,
            FRotator::ZeroRotator,
            EffectiveScale,
            false,  // bAutoDestroy - we manage manually
            true,   // bAutoActivate
            ENCPoolMethod::None,
            true    // bPreCullCheck
        );

        if (SpawnedFXComponent)
        {
            // Set intensity parameter for FX
            SpawnedFXComponent->SetNiagaraVariableFloat(FString("User.Intensity"), Intensity);
        }
    }

    // Apply density reduction modifier
    if (DensityReducer)
    {
        DensityReducer->ApplyModifier(WorldContext, Location, Intensity);
    }

    GSDEVENT_LOG(TEXT("Bonfire event started at %s with intensity %.2f"), *Location.ToString(), Intensity);
}

void UGSDEventBonfireConfig::OnEventEnd_Implementation(UObject* WorldContext)
{
    // Deactivate and cleanup FX
    if (SpawnedFXComponent)
    {
        SpawnedFXComponent->Deactivate();
        SpawnedFXComponent->DestroyComponent();
        SpawnedFXComponent = nullptr;
    }

    // Remove density modifier (always, even if context invalid)
    if (DensityReducer)
    {
        DensityReducer->RemoveModifier(WorldContext);
    }

    GSDEVENT_LOG(TEXT("Bonfire event ended"));
}
```

**Key Design Decisions:**
- bAutoDestroy=false to manage FX lifetime manually (Pitfall 4 prevention)
- FX scale and intensity parameter controlled by Intensity value
- DensityReducer applies density reduction in area
- Always deactivate and null FX component in OnEventEnd
- Always remove modifier even with null context (Pitfall 2 prevention)
- ValidateConfig checks BonfireFX is valid (not just array empty)
- ValidateConfig checks DensityReducer is valid
</action>
  <verify>
    # Verify header exists
    grep -q "class GSD_DAILYEVENTS_API UGSDEventBonfireConfig" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventBonfireConfig.h

    # Verify Niagara includes
    grep -q "NiagaraFunctionLibrary.h" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBonfireConfig.cpp

    # Verify FX spawning
    grep -q "SpawnSystemAtLocation" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBonfireConfig.cpp

    # Verify density modifier integration
    grep -q "DensityReducer" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBonfireConfig.cpp

    # Verify cleanup pattern
    grep -q "Deactivate()" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBonfireConfig.cpp

    # Verify specific validation
    grep -q "!BonfireFX" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBonfireConfig.cpp

    echo "Bonfire event verified"
  </verify>
  <done>Bonfire event spawns Niagara FX, applies density reduction, and cleans up properly on event end. Validates FX and modifier references.</done>
</task>

<task type="auto">
  <name>Task 3: Create Bonfire Event Data Asset</name>
  <files>
    Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_BonfireEvent.uasset
  </files>
  <action>
Create the event data asset file that designers can configure in the Unreal Editor.

**Note:** Data assets (.uasset files) are created through the Unreal Editor UI, not programmatically. This task documents the required steps.

**Editor Steps:**
1. Open Unreal Editor
2. Navigate to Content Browser > Plugins > GSD_DailyEvents Content > DataAssets > Events
3. Right-click > Blueprints > Data Asset > UGSDEventBonfireConfig
4. Name: DA_BonfireEvent
5. Configure properties:
   - EventTag: Event.Daily.Bonfire
   - DurationMinutes: 30.0
   - BonfireFX: (Assign Niagara System asset)
   - FXScale: (1.0, 1.0, 1.0)
   - DensityReducer: (Create and assign UGSDDensityReduceModifier)

**Verification in Editor:**
- Asset appears in Content Browser at specified path
- Double-clicking opens property editor
- All configurable properties visible and editable
</action>
  <verify>
    # Note: .uasset files are binary and created in editor
    # Verify the directory structure exists for data assets
    test -d Plugins/GSD_DailyEvents/Content/DataAssets/Events || mkdir -p Plugins/GSD_DailyEvents/Content/DataAssets/Events

    # Log reminder for editor-based creation
    echo "Note: DA_BonfireEvent.uasset must be created in Unreal Editor"
    echo "Path: Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_BonfireEvent.uasset"
  </verify>
  <done>Bonfire event data asset directory prepared. Actual .uasset file created in Unreal Editor.</done>
</task>

</tasks>

<verification>
## Compilation Check
```bash
# Compile GSD_DailyEvents plugin
# UnrealBuildTool should succeed with Niagara module linked
```

## Pattern Verification
- [ ] UGSDEventBonfireConfig extends UGSDDailyEventConfig
- [ ] OnEventStart_Implementation spawns Niagara FX
- [ ] OnEventStart_Implementation applies DensityReduceModifier
- [ ] OnEventEnd_Implementation deactivates and destroys FX component
- [ ] OnEventEnd_Implementation removes density modifier
- [ ] Intensity affects FX scale and parameters
- [ ] No FX component leaks (proper cleanup)
- [ ] ValidateConfig checks BonfireFX is valid
- [ ] ValidateConfig checks DensityReducer is valid
</verification>

<success_criteria>
- Bonfire event spawns Niagara FX at event location
- FX intensity parameter controlled by event intensity
- Zombie density reduced in area around bonfire
- FX deactivated and destroyed when event ends
- Density modifier removed when event ends
- No memory leaks from FX components
- Event data asset exists for designer configuration
- ValidateConfig provides specific error messages for missing FX/modifier
</success_criteria>

<output>
After completion, create `.planning/phases/09-event-implementations/09-03-SUMMARY.md`
</output>
