---
phase: 09-event-implementations
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventBlockPartyConfig.h
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBlockPartyConfig.cpp
  - Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_BlockPartyEvent.uasset
autonomous: true

must_haves:
  truths:
    - "Block Party event spawns crowd props in area"
    - "Safe zone created with near-zero zombie density"
    - "Props are randomly arranged within event radius"
    - "All props and safe zone cleaned up when event ends"
    - "Event data asset file exists and is configurable in editor"
  artifacts:
    - path: "Plugins/GSD_DailyEvents/.../Events/GSDEventBlockPartyConfig.h"
      provides: "Block Party event definition (EVT-07)"
      exports: ["UGSDEventBlockPartyConfig"]
      contains: "SpawnedProps"
    - path: "Plugins/GSD_DailyEvents/.../Events/GSDEventBlockPartyConfig.cpp"
      provides: "Block Party event implementation"
      contains: "SpawnActor"
    - path: "Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_BlockPartyEvent.uasset"
      provides: "Configurable event instance for designers"
      contains: "UGSDEventBlockPartyConfig"
  key_links:
    - from: "GSDEventBlockPartyConfig::OnEventStart"
      to: "World->SpawnActor"
      via: "Prop spawning"
      pattern: "SpawnActor.*Props"
    - from: "GSDEventBlockPartyConfig::OnEventStart"
      to: "GSDSafeZoneModifier::ApplyModifier"
      via: "Safe zone creation"
      pattern: "ApplyModifier"
    - from: "GSDEventBlockPartyConfig::OnEventEnd"
      to: "Actor::Destroy"
      via: "Prop cleanup"
      pattern: "->Destroy\\(\\)"
---

<objective>
Implement Block Party event (EVT-07) that creates safe zones and spawns crowd props.

Purpose: Block Party events create temporary survivor gatherings where zombies are effectively blocked, giving players social objectives and rewards.
Output: UGSDEventBlockPartyConfig that spawns crowd props and applies safe zone modifier. Plus data asset instance for editor configuration.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Phase 9 Context (Modifiers)

@.planning/phases/09-event-implementations/09-01-PLAN.md

**SafeZoneModifier available** for creating near-zero spawn zones.

## Research Context

@.planning/phases/09-event-implementations/09-RESEARCH.md

**Actor Spawning Pattern:**
```cpp
FActorSpawnParameters SpawnParams;
SpawnParams.SpawnCollisionHandlingOverride = ESpawnActorCollisionHandlingMethod::AdjustIfPossibleButAlwaysSpawn;
AActor* Actor = World->SpawnActor<AActor>(Class, Location, Rotation, SpawnParams);
```

**Random Location Pattern:**
```cpp
FVector RandomOffset = FMath::VRand() * FMath::FRandRange(0.0f, Radius);
FVector SpawnLocation = Center + RandomOffset;
```

**Pitfall 1 - Actor Cleanup Memory Leak:**
- Always store spawned actors in TArray member variable
- Call Destroy() on actors in OnEventEnd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Block Party Event Config</name>
  <files>
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventBlockPartyConfig.h
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBlockPartyConfig.cpp
  </files>
  <action>
Create UGSDEventBlockPartyConfig that implements EVT-07: Block Party event creates safe zones and crowd props.

**Header (GSDEventBlockPartyConfig.h):**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "DataAssets/GSDDailyEventConfig.h"
#include "GSDEventBlockPartyConfig.generated.h"

class UGSDSafeZoneModifier;
class AActor;

/**
 * Block Party event configuration.
 * Creates safe zones and spawns crowd props.
 *
 * EVT-07: Block Party event creates safe zones and crowd props
 */
UCLASS(BlueprintType, Category = "GSD|Events")
class GSD_DAILYEVENTS_API UGSDEventBlockPartyConfig : public UGSDDailyEventConfig
{
    GENERATED_BODY()

public:
    UGSDEventBlockPartyConfig();

    //-- Safe Zone Settings --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "SafeZone")
    TObjectPtr<UGSDSafeZoneModifier> SafeZoneModifier;

    //-- Crowd Props --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Props")
    TArray<TSubclassOf<AActor>> CrowdPropClasses;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Props")
    int32 MinProps = 5;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Props")
    int32 MaxProps = 15;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Props")
    float PropSpawnRadius = 1000.0f;

    //-- Decorative FX --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "VFX")
    TArray<TSubclassOf<AActor>> DecorativeFXClasses;

    //-- UGSDDailyEventConfig Interface --
    virtual bool ValidateConfig(FString& OutError) const override;
    virtual void OnEventStart_Implementation(UObject* WorldContext, FVector Location, float Intensity) override;
    virtual void OnEventEnd_Implementation(UObject* WorldContext) override;

protected:
    /** Track spawned props for cleanup */
    UPROPERTY()
    TArray<TObjectPtr<AActor>> SpawnedProps;

    /** Track spawned FX for cleanup */
    UPROPERTY()
    TArray<TObjectPtr<AActor>> SpawnedFX;

    /** Event center for cleanup */
    FVector EventCenter;

    /** Helper: Spawn props in random positions around center */
    void SpawnCrowdProps(UWorld* World, const FVector& Center, int32 Count);
};
```

**Implementation (GSDEventBlockPartyConfig.cpp):**
```cpp
#include "DataAssets/Events/GSDEventBlockPartyConfig.h"
#include "Modifiers/GSDSafeZoneModifier.h"
#include "Kismet/KismetMathLibrary.h"

UGSDEventBlockPartyConfig::UGSDEventBlockPartyConfig()
{
    EventTag = FGameplayTag::RequestGameplayTag(FName("Event.Daily.BlockParty"));
    DurationMinutes = 45.0f;  // Block parties last 45 minutes by default
}

bool UGSDEventBlockPartyConfig::ValidateConfig(FString& OutError) const
{
    if (!Super::ValidateConfig(OutError))
    {
        return false;
    }

    // Specific validation for Block Party event
    if (CrowdPropClasses.Num() == 0)
    {
        OutError = TEXT("Block Party event requires at least one CrowdPropClass");
        return false;
    }

    if (!SafeZoneModifier)
    {
        OutError = TEXT("Block Party event requires SafeZoneModifier to be set");
        return false;
    }

    // Validate each prop class is valid
    for (int32 i = 0; i < CrowdPropClasses.Num(); ++i)
    {
        if (!CrowdPropClasses[i])
        {
            OutError = FString::Printf(TEXT("CrowdPropClasses[%d] is null"), i);
            return false;
        }
    }

    // Validate decorative FX if specified
    for (int32 i = 0; i < DecorativeFXClasses.Num(); ++i)
    {
        if (!DecorativeFXClasses[i])
        {
            OutError = FString::Printf(TEXT("DecorativeFXClasses[%d] is null"), i);
            return false;
        }
    }

    return true;
}

void UGSDEventBlockPartyConfig::OnEventStart_Implementation(UObject* WorldContext, FVector Location, float Intensity)
{
    UWorld* World = WorldContext ? WorldContext->GetWorld() : nullptr;
    if (!World)
    {
        GSDEVENT_WARN(TEXT("Block Party event: Invalid world"));
        return;
    }

    EventCenter = Location;

    // Apply safe zone modifier
    if (SafeZoneModifier)
    {
        SafeZoneModifier->ApplyModifier(WorldContext, Location, Intensity);
    }

    // Calculate number of props based on intensity
    int32 NumProps = FMath::RoundToInt(FMath::Lerp(float(MinProps), float(MaxProps), Intensity));
    NumProps = FMath::Clamp(NumProps, MinProps, MaxProps);

    // Spawn crowd props
    SpawnCrowdProps(World, Location, NumProps);

    // Spawn decorative FX (string lights, speakers, etc.)
    if (DecorativeFXClasses.Num() > 0)
    {
        FActorSpawnParameters SpawnParams;
        SpawnParams.SpawnCollisionHandlingOverride = ESpawnActorCollisionHandlingMethod::AdjustIfPossibleButAlwaysSpawn;

        int32 NumFX = FMath::CeilToInt(Intensity * 3.0f);
        for (int32 i = 0; i < NumFX; ++i)
        {
            FVector RandomOffset = UKismetMathLibrary::RandomUnitVector() * FMath::FRandRange(200.0f, PropSpawnRadius * 0.8f);
            FVector SpawnLoc = Location + RandomOffset;
            FRotator RandomRotation = UKismetMathLibrary::RandomRotator();

            TSubclassOf<AActor> FXClass = DecorativeFXClasses[FMath::RandRange(0, DecorativeFXClasses.Num() - 1)];
            AActor* FX = World->SpawnActor<AActor>(FXClass, SpawnLoc, RandomRotation, SpawnParams);
            if (FX)
            {
                SpawnedFX.Add(FX);
            }
        }
    }

    GSDEVENT_LOG(TEXT("Block Party event started at %s: %d props, %d FX, intensity %.2f"),
        *Location.ToString(), SpawnedProps.Num(), SpawnedFX.Num(), Intensity);
}

void UGSDEventBlockPartyConfig::SpawnCrowdProps(UWorld* World, const FVector& Center, int32 Count)
{
    if (!World || CrowdPropClasses.Num() == 0) return;

    FActorSpawnParameters SpawnParams;
    SpawnParams.SpawnCollisionHandlingOverride = ESpawnActorCollisionHandlingMethod::AdjustIfPossibleButAlwaysSpawn;

    for (int32 i = 0; i < Count; ++i)
    {
        // Random position within spawn radius
        FVector RandomOffset = UKismetMathLibrary::RandomUnitVector() * FMath::FRandRange(100.0f, PropSpawnRadius);
        FVector SpawnLocation = Center + RandomOffset;

        // Random rotation (mostly upright, some variation)
        FRotator SpawnRotation = FRotator(
            FMath::FRandRange(-5.0f, 5.0f),   // Slight pitch variation
            FMath::FRandRange(0.0f, 360.0f),  // Random yaw
            FMath::FRandRange(-5.0f, 5.0f)    // Slight roll variation
        );

        // Select random prop class
        TSubclassOf<AActor> PropClass = CrowdPropClasses[FMath::RandRange(0, CrowdPropClasses.Num() - 1)];

        AActor* Prop = World->SpawnActor<AActor>(PropClass, SpawnLocation, SpawnRotation, SpawnParams);
        if (Prop)
        {
            SpawnedProps.Add(Prop);
        }
    }
}

void UGSDEventBlockPartyConfig::OnEventEnd_Implementation(UObject* WorldContext)
{
    // Destroy all spawned props
    for (AActor* Prop : SpawnedProps)
    {
        if (Prop)
        {
            Prop->Destroy();
        }
    }
    SpawnedProps.Empty();

    // Destroy all spawned FX
    for (AActor* FX : SpawnedFX)
    {
        if (FX)
        {
            FX->Destroy();
        }
    }
    SpawnedFX.Empty();

    // Remove safe zone modifier
    if (SafeZoneModifier)
    {
        SafeZoneModifier->RemoveModifier(WorldContext);
    }

    GSDEVENT_LOG(TEXT("Block Party event ended: %d props, %d FX destroyed"),
        SpawnedProps.Num(), SpawnedFX.Num());
}
```

**Key Design Decisions:**
- Props spawn in random positions within PropSpawnRadius
- Intensity controls prop count (MinProps to MaxProps range)
- Random rotations with slight pitch/roll variation for natural look
- Decorative FX (lights, speakers) spawn around perimeter
- SafeZoneModifier creates near-zero spawn zone
- All actors tracked in TArray<TObjectPtr<AActor>> for cleanup (Pitfall 1 prevention)
- ValidateConfig checks CrowdPropClasses.Num() > 0 and validates each class
- Always cleanup in OnEventEnd
</action>
  <verify>
    # Verify header exists
    grep -q "class GSD_DAILYEVENTS_API UGSDEventBlockPartyConfig" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventBlockPartyConfig.h

    # Verify prop spawning
    grep -q "SpawnActor" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBlockPartyConfig.cpp

    # Verify safe zone integration
    grep -q "SafeZoneModifier" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBlockPartyConfig.cpp

    # Verify cleanup pattern
    grep -q "->Destroy()" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBlockPartyConfig.cpp

    # Verify specific validation
    grep -q "CrowdPropClasses.Num() == 0" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventBlockPartyConfig.cpp

    echo "Block Party event verified"
  </verify>
  <done>Block Party event spawns crowd props, creates safe zone, and cleans up all actors on event end. Validates prop classes and modifier.</done>
</task>

<task type="auto">
  <name>Task 2: Create Block Party Event Data Asset</name>
  <files>
    Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_BlockPartyEvent.uasset
  </files>
  <action>
Create the event data asset file that designers can configure in the Unreal Editor.

**Note:** Data assets (.uasset files) are created through the Unreal Editor UI, not programmatically. This task documents the required steps.

**Editor Steps:**
1. Open Unreal Editor
2. Navigate to Content Browser > Plugins > GSD_DailyEvents Content > DataAssets > Events
3. Right-click > Blueprints > Data Asset > UGSDEventBlockPartyConfig
4. Name: DA_BlockPartyEvent
5. Configure properties:
   - EventTag: Event.Daily.BlockParty
   - DurationMinutes: 45.0
   - SafeZoneModifier: (Create and assign UGSDSafeZoneModifier)
   - CrowdPropClasses: (Add prop blueprint classes)
   - MinProps: 5
   - MaxProps: 15
   - PropSpawnRadius: 1000.0
   - DecorativeFXClasses: (Add FX blueprint classes)

**Verification in Editor:**
- Asset appears in Content Browser at specified path
- Double-clicking opens property editor
- All configurable properties visible and editable
</action>
  <verify>
    # Note: .uasset files are binary and created in editor
    # Verify the directory structure exists for data assets
    test -d Plugins/GSD_DailyEvents/Content/DataAssets/Events || mkdir -p Plugins/GSD_DailyEvents/Content/DataAssets/Events

    # Log reminder for editor-based creation
    echo "Note: DA_BlockPartyEvent.uasset must be created in Unreal Editor"
    echo "Path: Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_BlockPartyEvent.uasset"
  </verify>
  <done>Block Party event data asset directory prepared. Actual .uasset file created in Unreal Editor.</done>
</task>

</tasks>

<verification>
## Compilation Check
```bash
# Compile GSD_DailyEvents plugin
# UnrealBuildTool should succeed without errors
```

## Pattern Verification
- [ ] UGSDEventBlockPartyConfig extends UGSDDailyEventConfig
- [ ] OnEventStart_Implementation spawns props in random positions
- [ ] OnEventStart_Implementation applies SafeZoneModifier
- [ ] OnEventStart_Implementation spawns decorative FX
- [ ] OnEventEnd_Implementation destroys all spawned actors
- [ ] OnEventEnd_Implementation removes safe zone modifier
- [ ] Intensity affects prop count
- [ ] No memory leaks from spawned actors
- [ ] ValidateConfig checks CrowdPropClasses.Num() > 0
- [ ] ValidateConfig checks SafeZoneModifier is valid
</verification>

<success_criteria>
- Block Party event spawns crowd props in random arrangement
- Safe zone created with near-zero zombie density
- Decorative FX (lights, speakers) spawn around perimeter
- Prop count scales with intensity
- All props and FX destroyed when event ends
- Safe zone removed when event ends
- No memory leaks from spawned actors
- Event data asset exists for designer configuration
- ValidateConfig provides specific error messages for missing props/modifier
</success_criteria>

<output>
After completion, create `.planning/phases/09-event-implementations/09-04-SUMMARY.md`
</output>
