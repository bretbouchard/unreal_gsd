---
phase: 09-event-implementations
plan: 05
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventZombieRaveConfig.h
  - Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventZombieRaveConfig.cpp
  - Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_ZombieRaveEvent.uasset
autonomous: true

must_haves:
  truths:
    - "Zombie Rave event spawns spatial audio at location"
    - "Density is boosted to attractor volumes and audio radius"
    - "Niagara VFX spawns at event location"
    - "All FX and audio cleaned up when event ends"
    - "Event data asset file exists and is configurable in editor"
  artifacts:
    - path: "Plugins/GSD_DailyEvents/.../Events/GSDEventZombieRaveConfig.h"
      provides: "Zombie Rave event definition (EVT-08)"
      exports: ["UGSDEventZombieRaveConfig"]
      contains: "UAudioComponent"
    - path: "Plugins/GSD_DailyEvents/.../Events/GSDEventZombieRaveConfig.cpp"
      provides: "Zombie Rave implementation"
      contains: "SpawnSoundAtLocation"
    - path: "Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_ZombieRaveEvent.uasset"
      provides: "Configurable event instance for designers"
      contains: "UGSDEventZombieRaveConfig"
  key_links:
    - from: "GSDEventZombieRaveConfig::OnEventStart"
      to: "UGameplayStatics::SpawnSoundAtLocation"
      via: "Audio spawning"
      pattern: "SpawnSoundAtLocation"
    - from: "GSDEventZombieRaveConfig::OnEventStart"
      to: "GSDDensityBoostModifier::ApplyModifier"
      via: "Density boost"
      pattern: "ApplyModifier"
    - from: "GSDEventZombieRaveConfig::OnEventStart"
      to: "UNiagaraFunctionLibrary::SpawnSystemAtLocation"
      via: "FX spawning"
      pattern: "SpawnSystemAtLocation"
    - from: "GSDEventZombieRaveConfig::OnEventEnd"
      to: "UAudioComponent::Stop"
      via: "Audio cleanup"
      pattern: "Stop\\(\\)"
---

<objective>
Implement Zombie Rave event (EVT-08) that boosts density with attractor volumes and audio.

Purpose: Zombie Rave events create high-danger zones with loud music that attracts zombies, making these areas more challenging.
Output: UGSDEventZombieRaveConfig that spawns spatial audio, applies density boost, and spawns Niagara VFX. Plus data asset instance for editor configuration.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Phase 8 Context (Density Boost Modifier)

@.planning/phases/08-event-system-core/08-04-SUMMARY.md

**GSDDensityBoostModifier already exists** from Phase 8 - applies density multiplier > 1.0f

## Research Context

@.planning/phases/09-event-implementations/09-RESEARCH.md

**Spatial Audio Pattern:**
```cpp
#include "Kismet/GameplayStatics.h"
#include "Components/AudioComponent.h"

UAudioComponent* AudioComponent = UGameplayStatics::SpawnSoundAtLocation(
    World,
    Sound,
    Location,
    FRotator::ZeroRotator,
    VolumeMultiplier,
    1.0f,   // Pitch
    0.0f,   // StartTime
    nullptr, // AttenuationSettings
    nullptr, // ConcurrencySettings
    true,    // bAutoDestroy
    true     // bPersistAcrossLevelTransition
);
```

**Pitfall 5 - Audio Component Not Stopping:**
- Always call Stop() before DestroyComponent()
- Store reference in member variable
- Handle case where audio already finished naturally

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zombie Rave Event Config</name>
  <files>
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventZombieRaveConfig.h
    Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventZombieRaveConfig.cpp
  </files>
  <action>
Create UGSDEventZombieRaveConfig that implements EVT-08: Zombie Rave event boosts density with attractor volumes and audio.

**Header (GSDEventZombieRaveConfig.h):**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "DataAssets/GSDDailyEventConfig.h"
#include "GSDEventZombieRaveConfig.generated.h"

class USoundBase;
class UNiagaraSystem;
class UNiagaraComponent;
class UAudioComponent;
class UGSDDensityBoostModifier;

/**
 * Zombie Rave event configuration.
 * Boosts density with attractor volumes, audio, and VFX.
 *
 * EVT-08: Zombie Rave event boosts density with attractor volumes and audio
 */
UCLASS(BlueprintType, Category = "GSD|Events")
class GSD_DAILYEVENTS_API UGSDEventZombieRaveConfig : public UGSDDailyEventConfig
{
    GENERATED_BODY()

public:
    UGSDEventZombieRaveConfig();

    //-- Audio Settings --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Audio")
    TObjectPtr<USoundBase> RaveMusic;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Audio")
    float AudioRadius = 3000.0f;

    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Audio")
    float VolumeMultiplier = 1.0f;

    //-- VFX Settings --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "VFX")
    TObjectPtr<UNiagaraSystem> RaveFX;

    //-- Density Boost --
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Density")
    TObjectPtr<UGSDDensityBoostModifier> DensityBooster;

    //-- UGSDDailyEventConfig Interface --
    virtual bool ValidateConfig(FString& OutError) const override;
    virtual void OnEventStart_Implementation(UObject* WorldContext, FVector Location, float Intensity) override;
    virtual void OnEventEnd_Implementation(UObject* WorldContext) override;

protected:
    /** Spawned audio component for cleanup */
    UPROPERTY()
    TObjectPtr<UAudioComponent> SpawnedAudio;

    /** Spawned FX component for cleanup */
    UPROPERTY()
    TObjectPtr<UNiagaraComponent> SpawnedFX;

    /** Event center for cleanup */
    FVector EventCenter;
};
```

**Implementation (GSDEventZombieRaveConfig.cpp):**
```cpp
#include "DataAssets/Events/GSDEventZombieRaveConfig.h"
#include "DataAssets/GSDDensityBoostModifier.h"
#include "NiagaraFunctionLibrary.h"
#include "NiagaraComponent.h"
#include "Kismet/GameplayStatics.h"
#include "Components/AudioComponent.h"

UGSDEventZombieRaveConfig::UGSDEventZombieRaveConfig()
{
    EventTag = FGameplayTag::RequestGameplayTag(FName("Event.Daily.ZombieRave"));
    DurationMinutes = 45.0f;  // Zombie Raves last 45 minutes by default
}

bool UGSDEventZombieRaveConfig::ValidateConfig(FString& OutError) const
{
    if (!Super::ValidateConfig(OutError))
    {
        return false;
    }

    // Specific validation for Zombie Rave event
    if (!RaveMusic)
    {
        OutError = TEXT("Zombie Rave event requires RaveMusic (SoundBase) to be set");
        return false;
    }

    if (!RaveFX)
    {
        OutError = TEXT("Zombie Rave event requires RaveFX (NiagaraSystem) to be set");
        return false;
    }

    if (!DensityBooster)
    {
        OutError = TEXT("Zombie Rave event requires DensityBooster to be set");
        return false;
    }

    return true;
}

void UGSDEventZombieRaveConfig::OnEventStart_Implementation(UObject* WorldContext, FVector Location, float Intensity)
{
    UWorld* World = WorldContext ? WorldContext->GetWorld() : nullptr;
    if (!World)
    {
        GSDEVENT_WARN(TEXT("Zombie Rave event: Invalid world context"));
        return;
    }

    EventCenter = Location;

    // Spawn spatial audio - use SpawnSoundAtLocation for control
    if (RaveMusic)
    {
        SpawnedAudio = UGameplayStatics::SpawnSoundAtLocation(
            World,
            RaveMusic,
            Location,
            FRotator::ZeroRotator,
            VolumeMultiplier * Intensity,
            1.0f,   // Pitch
            0.0f,   // StartTime
            nullptr, // AttenuationSettings (use defaults)
            nullptr, // ConcurrencySettings
            false,    // bAutoDestroy - we manage manually
            true     // bPersistAcrossLevelTransition
        );

        if (SpawnedAudio)
        {
            // Set radius parameter for audio attenuation
            SpawnedAudio->SetFloatParameter(FName("Radius"), AudioRadius * Intensity);
        }
    }

    // Spawn VFX
    if (RaveFX)
    {
        SpawnedFX = UNiagaraFunctionLibrary::SpawnSystemAtLocation(
            WorldContext,
            RaveFX,
            Location,
            FRotator::ZeroRotator,
            FVector(Intensity),
            false,  // bAutoDestroy - we manage manually
            true,   // bAutoActivate
            ENCPoolMethod::None,
            true    // bPreCullCheck
        );

        if (SpawnedFX)
        {
            // Set intensity parameter
            SpawnedFX->SetNiagaraVariableFloat(FString("User.Intensity"), Intensity);
        }
    }

    // Apply density boost - attracts zombies
    if (DensityBooster)
    {
        DensityBooster->ApplyModifier(WorldContext, Location, Intensity);
    }

    GSDEVENT_LOG(TEXT("Zombie Rave event started at %s with intensity %.2f"), *Location.ToString(), Intensity);
}

void UGSDEventZombieRaveConfig::OnEventEnd_Implementation(UObject* WorldContext)
{
    // Stop and cleanup audio
    if (SpawnedAudio)
    {
        SpawnedAudio->Stop();
        SpawnedAudio->DestroyComponent();
        SpawnedAudio = nullptr;
    }

    // Deactivate FX
    if (SpawnedFX)
    {
        SpawnedFX->Deactivate();
        SpawnedFX->DestroyComponent();
        SpawnedFX = nullptr;
    }

    // Remove density boost
    if (DensityBooster)
    {
        DensityBooster->RemoveModifier(WorldContext);
    }

    GSDEVENT_LOG(TEXT("Zombie Rave event ended"));
}
```

**Key Design Decisions:**
- Audio uses bAutoDestroy=false for manual lifetime management (Pitfall 5 prevention)
- FX uses bAutoDestroy=false for manual lifetime management
- Audio radius scaled by intensity
- DensityBooster attracts zombies to the event location
- Always stop audio and deactivate FX in OnEventEnd
- Always remove modifier even with null context (Pitfall 2 prevention)
- ValidateConfig checks RaveMusic, RaveFX, and DensityBooster are valid
</action>
  <verify>
    # Verify header exists
    grep -q "class GSD_DAILYEVENTS_API UGSDEventZombieRaveConfig" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Public/DataAssets/Events/GSDEventZombieRaveConfig.h

    # Verify audio spawning
    grep -q "SpawnSoundAtLocation" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventZombieRaveConfig.cpp

    # Verify FX spawning
    grep -q "SpawnSystemAtLocation" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventZombieRaveConfig.cpp

    # Verify density boost integration
    grep -q "DensityBooster" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventZombieRaveConfig.cpp

    # Verify cleanup patterns
    grep -q "->Stop()" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventZombieRaveConfig.cpp

    grep -q "Deactivate()" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventZombieRaveConfig.cpp

    # Verify specific validation
    grep -q "!RaveMusic" \
      Plugins/GSD_DailyEvents/Source/GSD_DailyEvents/Private/DataAssets/Events/GSDEventZombieRaveConfig.cpp

    echo "Zombie Rave event verified"
  </verify>
  <done>Zombie Rave event spawns spatial audio, FX, applies density boost, and cleans up all components on event end. Validates audio, FX, and modifier references.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zombie Rave Event Data Asset</name>
  <files>
    Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_ZombieRaveEvent.uasset
  </files>
  <action>
Create the event data asset file that designers can configure in the Unreal Editor.

**Note:** Data assets (.uasset files) are created through the Unreal Editor UI, not programmatically. This task documents the required steps.

**Editor Steps:**
1. Open Unreal Editor
2. Navigate to Content Browser > Plugins > GSD_DailyEvents Content > DataAssets > Events
3. Right-click > Blueprints > Data Asset > UGSDEventZombieRaveConfig
4. Name: DA_ZombieRaveEvent
5. Configure properties:
   - EventTag: Event.Daily.ZombieRave
   - DurationMinutes: 45.0
   - RaveMusic: (Assign SoundBase asset)
   - AudioRadius: 3000.0
   - VolumeMultiplier: 1.0
   - RaveFX: (Assign Niagara System asset)
   - DensityBooster: (Create and assign UGSDDensityBoostModifier)

**Verification in Editor:**
- Asset appears in Content Browser at specified path
- Double-clicking opens property editor
- All configurable properties visible and editable
</action>
  <verify>
    # Note: .uasset files are binary and created in editor
    # Verify the directory structure exists for data assets
    test -d Plugins/GSD_DailyEvents/Content/DataAssets/Events || mkdir -p Plugins/GSD_DailyEvents/Content/DataAssets/Events

    # Log reminder for editor-based creation
    echo "Note: DA_ZombieRaveEvent.uasset must be created in Unreal Editor"
    echo "Path: Plugins/GSD_DailyEvents/Content/DataAssets/Events/DA_ZombieRaveEvent.uasset"
  </verify>
  <done>Zombie Rave event data asset directory prepared. Actual .uasset file created in Unreal Editor.</done>
</task>

</tasks>

<verification>
## Compilation Check
```bash
# Compile GSD_DailyEvents plugin
# UnrealBuildTool should succeed with AudioMixer module linked
```

## Pattern Verification
- [ ] UGSDEventZombieRaveConfig extends UGSDDailyEventConfig
- [ ] OnEventStart_Implementation spawns spatial audio
- [ ] OnEventStart_Implementation spawns Niagara FX
- [ ] OnEventStart_Implementation applies DensityBoostModifier
- [ ] OnEventEnd_Implementation stops and destroys audio component
- [ ] OnEventEnd_Implementation deactivates and destroys FX component
- [ ] OnEventEnd_Implementation removes density modifier
- [ ] Intensity affects audio radius and FX scale
- [ ] No audio/FX component leaks (proper cleanup)
- [ ] ValidateConfig checks RaveMusic is valid
- [ ] ValidateConfig checks RaveFX is valid
- [ ] ValidateConfig checks DensityBooster is valid
</verification>

<success_criteria>
- Zombie Rave event spawns spatial audio at event location
- Audio radius controlled by event intensity
- Niagara VFX spawns at event location
- Zombie density boosted in area (attracts zombies)
- Audio stops and component destroyed when event ends
- FX deactivated and component destroyed when event ends
- Density modifier removed when event ends
- No memory leaks from audio/FX components
- Event data asset exists for designer configuration
- ValidateConfig provides specific error messages for missing audio/FX/modifier
</success_criteria>

<output>
After completion, create `.planning/phases/09-event-implementations/09-05-SUMMARY.md`
</output>
