---
phase: 02-world-partition-setup
plan: 06
type: execute
wave: 4
depends_on: ["02-01", "02-02", "02-03", "02-04", "02-05"]
files_modified:
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDCityStreamingTest.cpp
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDHLODTest.cpp
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDStreamingSourceTest.cpp
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Unit tests verify settings class functionality"
    - "Unit tests verify HLOD type configuration"
    - "Unit tests verify streaming source component behavior"
    - "Tests only run in editor builds (not shipped)"
  artifacts:
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDCityStreamingTest.cpp"
      provides: "Unit tests for city streaming settings"
      contains: "IMPLEMENT_SIMPLE_AUTOMATION_TEST"
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs"
      provides: "Build configuration with test dependencies"
      contains: "bBuildEditor"
  key_links:
    - from: "Tests"
      to: "Automation Testing Framework"
      via: "IMPLEMENT_SIMPLE_AUTOMATION_TEST"
      pattern: "Automation"
---

<objective>
Create unit tests and verification for World Partition setup components.

Purpose: Verify all Phase 2 components work correctly through automated testing, following the test patterns established in Phase 1 Plan 07.
Output: Unit tests for settings, HLOD types, and streaming source component.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-world-partition-setup/02-RESEARCH.md

# Prior phase context
@.planning/phases/01-plugin-architecture-foundation/07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Build.cs for Test Dependencies</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs
  </files>
  <action>
    Update Build.cs to include test dependencies for editor builds:

    1. Read current Build.cs and add editor-only test dependencies:

       if (Target.bBuildEditor)
       {
           PrivateDependencyModuleNames.AddRange(new string[] {
               "UnrealEd",
               "EditorScriptingUtilities",
               "AutomationController"
           });
       }

    2. Ensure Tests directory is included in compilation:
       - The Tests/ files should be in Private/Tests/
       - They will be compiled with the module

    This follows the exact pattern from Phase 1 Plan 07 for test dependencies.
  </action>
  <verify>
    Verify Build.cs has editor test dependencies:
    - grep -c "bBuildEditor" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs
    - grep -c "AutomationController" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs
  </verify>
  <done>
    Build.cs includes editor-only test dependencies (UnrealEd, AutomationController).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Settings Unit Tests</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDCityStreamingTest.cpp
  </files>
  <action>
    Create unit tests for city streaming settings following Phase 1 test patterns:

    1. Create Tests/ directory under Private/

    2. In GSDCityStreamingTest.cpp:

       #include "CoreMinimal.h"
       #include "Misc/AutomationTest.h"
       #include "GSDCityStreamingSettings.h"

       #if WITH_DEV_AUTOMATION_TESTS

       IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDCityStreamingSettingsTest,
           "GSD.CityStreaming.Settings.DefaultValues",
           EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)

       bool FGSDCityStreamingSettingsTest::RunTest(const FString& Parameters)
       {
           // Test default grid cell size
           UGSDCityStreamingSettings* Settings = UGSDCityStreamingSettings::Get();
           TestNotNull("Settings should exist", Settings);

           if (Settings)
           {
               // Verify default grid cell size is 25600 (256m)
               TestEqual("Default grid cell size should be 25600",
                   Settings->DefaultGridCellSize, 25600);

               // Verify default loading range is 76800 (768m)
               TestEqual("Default loading range should be 76800",
                   Settings->DefaultLoadingRange, 76800);

               // Verify HLOD tier count
               TestEqual("HLOD tier count should be 3",
                   Settings->HLODTierCount, 3);

               // Verify auto-generate collision
               TestTrue("Auto-generate collision should be true",
                   Settings->bAutoGenerateCollision);

               // Verify import scale
               TestEqual("Import scale should be 1.0",
                   Settings->ImportScale, 1.0f);
           }

           return true;
       }

       IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDCityStreamingSettingsValidationTest,
           "GSD.CityStreaming.Settings.Validation",
           EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)

       bool FGSDCityStreamingSettingsValidationTest::RunTest(const FString& Parameters)
       {
           UGSDCityStreamingSettings* Settings = UGSDCityStreamingSettings::Get();
           TestNotNull("Settings should exist", Settings);

           if (Settings)
           {
               // Test validation: grid cell size within bounds
               TestTrue("Grid cell size should be >= 12800",
                   Settings->DefaultGridCellSize >= 12800);
               TestTrue("Grid cell size should be <= 102400",
                   Settings->DefaultGridCellSize <= 102400);

               // Test validation: loading range >= grid cell size * 2
               TestTrue("Loading range should be >= 51200",
                   Settings->DefaultLoadingRange >= 51200);

               // Test validation: HLOD tier count within bounds
               TestTrue("HLOD tier count should be >= 1",
                   Settings->HLODTierCount >= 1);
               TestTrue("HLOD tier count should be <= 5",
                   Settings->HLODTierCount <= 5);
           }

           return true;
       }

       #endif // WITH_DEV_AUTOMATION_TESTS

    These tests verify default values and validation constraints for city streaming settings.
  </action>
  <verify>
    Verify settings tests exist with correct structure:
    - grep -c "IMPLEMENT_SIMPLE_AUTOMATION_TEST" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDCityStreamingTest.cpp
    - grep -c "DefaultGridCellSize" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDCityStreamingTest.cpp
    - grep -c "25600" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDCityStreamingTest.cpp
  </verify>
  <done>
    Settings unit tests verify default values (25600 cell size, 76800 loading range) and validation constraints.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create HLOD Type Tests</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDHLODTest.cpp
  </files>
  <action>
    Create unit tests for HLOD type configuration:

    1. In GSDHLODTest.cpp:

       #include "CoreMinimal.h"
       #include "Misc/AutomationTest.h"
       #include "Types/GSDHLODTypes.h"

       #if WITH_DEV_AUTOMATION_TESTS

       IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDHLODTypesEnumTest,
           "GSD.CityStreaming.HLOD.Types.EnumValues",
           EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)

       bool FGSDHLODTypesEnumTest::RunTest(const FString& Parameters)
       {
           // Test enum values exist
           TestEqual("Instancing type should be 0",
               static_cast<int32>(EGSDHLODLayerType::Instancing), 0);
           TestEqual("MergedMesh type should be 1",
               static_cast<int32>(EGSDHLODLayerType::MergedMesh), 1);
           TestEqual("SimplifiedMesh type should be 2",
               static_cast<int32>(EGSDHLODLayerType::SimplifiedMesh), 2);

           return true;
       }

       IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDHLODDefaultConfigTest,
           "GSD.CityStreaming.HLOD.Config.DefaultTiers",
           EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)

       bool FGSDHLODDefaultConfigTest::RunTest(const FString& Parameters)
       {
           FGSDHLODSystemConfig Config = CreateDefaultCityHLODConfig();

           // Should have 3 tiers
           TestEqual("Should have 3 HLOD tiers", Config.Layers.Num(), 3);

           if (Config.Layers.Num() >= 3)
           {
               // Tier 1 - Foliage (Instancing)
               TestEqual("Tier 1 should be Instancing",
                   Config.Layers[0].LayerType, EGSDHLODLayerType::Instancing);
               TestEqual("Tier 1 cell size should be 51200",
                   Config.Layers[0].CellSize, 51200);
               TestEqual("Tier 1 loading range should be 30000",
                   Config.Layers[0].LoadingRange, 30000);

               // Tier 2 - Buildings (MergedMesh)
               TestEqual("Tier 2 should be MergedMesh",
                   Config.Layers[1].LayerType, EGSDHLODLayerType::MergedMesh);
               TestEqual("Tier 2 cell size should be 25600",
                   Config.Layers[1].CellSize, 25600);
               TestEqual("Tier 2 loading range should be 50000",
                   Config.Layers[1].LoadingRange, 50000);
               TestTrue("Tier 2 should have Nanite enabled",
                   Config.Layers[1].bGenerateNaniteMesh);

               // Tier 3 - Terrain (SimplifiedMesh)
               TestEqual("Tier 3 should be SimplifiedMesh",
                   Config.Layers[2].LayerType, EGSDHLODLayerType::SimplifiedMesh);
               TestEqual("Tier 3 cell size should be 102400",
                   Config.Layers[2].CellSize, 102400);
               TestEqual("Tier 3 loading range should be 100000",
                   Config.Layers[2].LoadingRange, 100000);
           }

           return true;
       }

       #endif // WITH_DEV_AUTOMATION_TESTS

    These tests verify HLOD enum values and default tier configuration matches RESEARCH.md specifications.
  </action>
  <verify>
    Verify HLOD tests exist with tier verification:
    - grep -c "IMPLEMENT_SIMPLE_AUTOMATION_TEST" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDHLODTest.cpp
    - grep -c "CreateDefaultCityHLODConfig" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDHLODTest.cpp
    - grep -c "51200" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDHLODTest.cpp
  </verify>
  <done>
    HLOD unit tests verify enum values and 3-tier default configuration (51200/25600/102400 cell sizes).
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Streaming Source Component Tests</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDStreamingSourceTest.cpp
  </files>
  <action>
    Create unit tests for streaming source component:

    1. In GSDStreamingSourceTest.cpp:

       #include "CoreMinimal.h"
       #include "Misc/AutomationTest.h"
       #include "Components/GSDStreamingSourceComponent.h"

       #if WITH_DEV_AUTOMATION_TESTS

       IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDStreamingSourceDefaultsTest,
           "GSD.CityStreaming.StreamingSource.Defaults",
           EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)

       bool FGSDStreamingSourceDefaultsTest::RunTest(const FString& Parameters)
       {
           // Create component to test defaults
           UGSDStreamingSourceComponent* Component = NewObject<UGSDStreamingSourceComponent>();
           TestNotNull("Component should be created", Component);

           if (Component)
           {
               // Verify default values
               TestTrue("Streaming should be enabled by default",
                   Component->IsStreamingEnabled());

               TestEqual("Loading range multiplier should be 1.0",
                   Component->GetLoadingRangeMultiplier(), 1.0f);
           }

           return true;
       }

       IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDStreamingSourceEnableDisableTest,
           "GSD.CityStreaming.StreamingSource.EnableDisable",
           EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)

       bool FGSDStreamingSourceEnableDisableTest::RunTest(const FString& Parameters)
       {
           UGSDStreamingSourceComponent* Component = NewObject<UGSDStreamingSourceComponent>();
           TestNotNull("Component should be created", Component);

           if (Component)
           {
               // Test enable/disable
               Component->SetStreamingEnabled(false);
               TestFalse("Streaming should be disabled", Component->IsStreamingEnabled());

               Component->SetStreamingEnabled(true);
               TestTrue("Streaming should be enabled", Component->IsStreamingEnabled());
           }

           return true;
       }

       IMPLEMENT_SIMPLE_AUTOMATION_TEST(FGSDStreamingSourceMultiplierTest,
           "GSD.CityStreaming.StreamingSource.LoadingRangeMultiplier",
           EAutomationTestFlags::ApplicationContextMask | EAutomationTestFlags::ProductFilter)

       bool FGSDStreamingSourceMultiplierTest::RunTest(const FString& Parameters)
       {
           UGSDStreamingSourceComponent* Component = NewObject<UGSDStreamingSourceComponent>();
           TestNotNull("Component should be created", Component);

           if (Component)
           {
               // Test loading range multiplier
               Component->SetLoadingRangeMultiplier(2.0f);
               TestEqual("Loading range multiplier should be 2.0",
                   Component->GetLoadingRangeMultiplier(), 2.0f);

               // Test clamping (should clamp to 5.0 max)
               Component->SetLoadingRangeMultiplier(10.0f);
               TestEqual("Loading range multiplier should be clamped to 5.0",
                   Component->GetLoadingRangeMultiplier(), 5.0f);

               // Test clamping (should clamp to 0.5 min)
               Component->SetLoadingRangeMultiplier(0.1f);
               TestEqual("Loading range multiplier should be clamped to 0.5",
                   Component->GetLoadingRangeMultiplier(), 0.5f);
           }

           return true;
       }

       #endif // WITH_DEV_AUTOMATION_TESTS

    Note: Need to add GetLoadingRangeMultiplier() getter to the component header for these tests.

    These tests verify streaming source defaults and enable/disable/multiplier functionality.
  </action>
  <verify>
    Verify streaming source tests exist:
    - grep -c "IMPLEMENT_SIMPLE_AUTOMATION_TEST" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDStreamingSourceTest.cpp
    - grep -c "SetStreamingEnabled" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDStreamingSourceTest.cpp
    - grep -c "SetLoadingRangeMultiplier" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Tests/GSDStreamingSourceTest.cpp
  </verify>
  <done>
    Streaming source unit tests verify defaults, enable/disable, and loading range multiplier clamping.
  </done>
</task>

</tasks>

<verification>
1. Build.cs includes editor-only test dependencies
2. Settings tests verify default values and validation
3. HLOD tests verify enum values and tier configuration
4. Streaming source tests verify enable/disable and multiplier
5. All tests use IMPLEMENT_SIMPLE_AUTOMATION_TEST pattern
6. Tests only compile for editor builds
</verification>

<success_criteria>
- Test framework follows Phase 1 Plan 07 patterns
- Settings tests verify 25600 cell size, 76800 loading range
- HLOD tests verify 3-tier configuration
- Streaming source tests verify enable/disable and multiplier
- All tests pass in Session Frontend
</success_criteria>

<output>
After completion, create `.planning/phases/02-world-partition-setup/02-06-SUMMARY.md`
</output>
