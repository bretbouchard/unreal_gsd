---
phase: 02-world-partition-setup
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Components/GSDStreamingSourceComponent.h
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Components/GSDStreamingSourceComponent.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Vehicles can have streaming source components attached"
    - "Streaming source enables predictive loading for fast-moving vehicles"
    - "Component extends World Partition streaming source system"
  artifacts:
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Components/GSDStreamingSourceComponent.h"
      provides: "Custom streaming source for GSD entities"
      exports: ["UGSDStreamingSourceComponent"]
  key_links:
    - from: "GSDStreamingSourceComponent"
      to: "World Partition Streaming"
      via: "UWorldPartitionStreamingSourceComponent"
      pattern: "StreamingSource"
---

<objective>
Create custom streaming source component for predictive loading around vehicles and fast-moving entities.

Purpose: Enable vehicles and other fast-moving entities to stream cells ahead of their movement direction, preventing pop-in during high-speed driving gameplay.
Output: GSDStreamingSourceComponent extending World Partition streaming source with GSD-specific features.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-world-partition-setup/02-RESEARCH.md

# Prior phase context
@.planning/phases/01-plugin-architecture-foundation/01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Streaming Source Component Header</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Components/GSDStreamingSourceComponent.h
  </files>
  <action>
    Create GSDStreamingSourceComponent extending UWorldPartitionStreamingSourceComponent:

    1. Create Components/ directory under Public/

    2. In GSDStreamingSourceComponent.h:

       #pragma once

       #include "CoreMinimal.h"
       #include "Components/ActorComponent.h"
       #include "WorldPartition/WorldPartitionStreamingSourceComponent.h"
       #include "GSDStreamingSourceComponent.generated.h"

       /**
        * Custom streaming source for vehicles and predictive loading.
        * Extends base World Partition streaming source with GSD-specific features.
        */
       UCLASS(ClassGroup=(GSD), meta=(BlueprintSpawnableComponent))
       class GSD_CITYSTREAMING_API UGSDStreamingSourceComponent : public UWorldPartitionStreamingSourceComponent
       {
           GENERATED_BODY()

       public:
           UGSDStreamingSourceComponent();

           // Enable/disable streaming (useful for parked vehicles)
           UFUNCTION(BlueprintCallable, Category="GSD|Streaming")
           void SetStreamingEnabled(bool bEnabled);

           // Set custom loading range multiplier (for fast vehicles)
           UFUNCTION(BlueprintCallable, Category="GSD|Streaming")
           void SetLoadingRangeMultiplier(float Multiplier);

           // Get current streaming state
           UFUNCTION(BlueprintPure, Category="GSD|Streaming")
           bool IsStreamingEnabled() const { return bStreamingEnabled; }

       protected:
           virtual void BeginPlay() override;

           // Override to apply custom settings
           virtual void UpdateStreamingSourceState();

       private:
           // Is streaming currently enabled for this source?
           UPROPERTY(EditAnywhere, Category="GSD|Streaming")
           bool bStreamingEnabled = true;

           // Multiplier for loading range (1.0 = default, 2.0 = double range for fast vehicles)
           UPROPERTY(EditAnywhere, Category="GSD|Streaming", meta=(ClampMin="0.5", ClampMax="5.0"))
           float LoadingRangeMultiplier = 1.0f;

           // Should this source load cells ahead of movement direction?
           UPROPERTY(EditAnywhere, Category="GSD|Streaming")
           bool bPredictiveLoading = false;

           // Velocity threshold for predictive loading (in cm/s)
           UPROPERTY(EditAnywhere, Category="GSD|Streaming")
           float PredictiveLoadingVelocityThreshold = 1000.0f;

           // Cached owner velocity for predictive calculations
           FVector CachedVelocity;
       };

    This follows the code example from RESEARCH.md and integrates with the existing World Partition system.
  </action>
  <verify>
    Verify component header exists with correct inheritance:
    - grep -c "UWorldPartitionStreamingSourceComponent" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Components/GSDStreamingSourceComponent.h
    - grep -c "SetStreamingEnabled" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Components/GSDStreamingSourceComponent.h
  </verify>
  <done>
    GSDStreamingSourceComponent header exists with Blueprint-callable methods for streaming control.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Streaming Source Component</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Components/GSDStreamingSourceComponent.cpp
  </files>
  <action>
    Implement the streaming source component methods:

    1. Create Components/ directory under Private/

    2. In GSDStreamingSourceComponent.cpp:

       #include "Components/GSDStreamingSourceComponent.h"
       #include "GameFramework/Pawn.h"
       #include "GameFramework/Actor.h"
       #include "GSDLog.h"

       UGSDStreamingSourceComponent::UGSDStreamingSourceComponent()
       {
           PrimaryComponentTick.bCanEverTick = false;
           SetIsReplicatedByDefault(false);
       }

       void UGSDStreamingSourceComponent::BeginPlay()
       {
           Super::BeginPlay();

           GSD_LOG(TEXT("GSDStreamingSourceComponent: Initialized on %s"), *GetOwner()->GetName());

           // Initial streaming state update
           UpdateStreamingSourceState();
       }

       void UGSDStreamingSourceComponent::SetStreamingEnabled(bool bEnabled)
       {
           if (bStreamingEnabled != bEnabled)
           {
               bStreamingEnabled = bEnabled;
               GSD_LOG(TEXT("GSDStreamingSourceComponent: Streaming %s for %s"),
                   bEnabled ? TEXT("enabled") : TEXT("disabled"),
                   *GetOwner()->GetName());

               UpdateStreamingSourceState();
           }
       }

       void UGSDStreamingSourceComponent::SetLoadingRangeMultiplier(float Multiplier)
       {
           LoadingRangeMultiplier = FMath::Clamp(Multiplier, 0.5f, 5.0f);
           GSD_LOG(TEXT("GSDStreamingSourceComponent: Loading range multiplier set to %.1f"), LoadingRangeMultiplier);

           UpdateStreamingSourceState();
       }

       void UGSDStreamingSourceComponent::UpdateStreamingSourceState()
       {
           // The base class handles actual streaming source registration
           // We just need to update our custom properties

           if (!bStreamingEnabled)
           {
               // Disable streaming by setting this source as inactive
               // The base class will handle unregistering
               SetComponentTickEnabled(false);
               return;
           }

           SetComponentTickEnabled(true);

           // Get owner velocity for predictive loading calculations
           if (AActor* Owner = GetOwner())
           {
               CachedVelocity = Owner->GetVelocity();

               // Check if predictive loading should activate based on velocity
               if (bPredictiveLoading)
               {
                   float Speed = CachedVelocity.Size();
                   if (Speed > PredictiveLoadingVelocityThreshold)
                   {
                       // Predictive loading is active - World Partition will
                       // load cells in movement direction based on our position
                       GSD_VERY_TRACE(TEXT("GSDStreamingSourceComponent: Predictive loading active, speed=%.0f"), Speed);
                   }
               }
           }
       }

    Note: The actual World Partition integration happens through the base UWorldPartitionStreamingSourceComponent.
    Our component provides GSD-specific controls (enable/disable, range multiplier) that integrate with the streaming system.
  </action>
  <verify>
    Verify component implementation exists with all methods:
    - grep -c "SetStreamingEnabled" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Components/GSDStreamingSourceComponent.cpp
    - grep -c "UpdateStreamingSourceState" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Components/GSDStreamingSourceComponent.cpp
    - grep -c "GSD_LOG" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Components/GSDStreamingSourceComponent.cpp
  </verify>
  <done>
    Streaming source component implementation complete with enable/disable and range multiplier functionality.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Build.cs for WorldPartition Dependency</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs
  </files>
  <action>
    Ensure Build.cs includes the WorldPartition module dependency:

    1. Read current Build.cs and verify it has WorldPartition in PublicDependencyModuleNames

    2. If missing, add:
       PublicDependencyModuleNames.AddRange(new string[] {
           "Core",
           "CoreUObject",
           "Engine",
           "InputCore",
           "WorldPartition"  // Required for UWorldPartitionStreamingSourceComponent
       });

    3. Verify GSD_Core is in PrivateDependencyModuleNames for logging macros

    The WorldPartition module is required for UWorldPartitionStreamingSourceComponent inheritance.
  </action>
  <verify>
    Verify Build.cs has WorldPartition dependency:
    - grep -c "WorldPartition" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/GSD_CityStreaming.Build.cs
  </verify>
  <done>
    Build.cs includes WorldPartition module dependency for streaming source component.
  </done>
</task>

</tasks>

<verification>
1. GSDStreamingSourceComponent inherits from UWorldPartitionStreamingSourceComponent
2. SetStreamingEnabled() controls streaming activation
3. SetLoadingRangeMultiplier() adjusts loading range for fast vehicles
4. Component uses GSD_LOG macros for logging
5. Build.cs includes WorldPartition module dependency
</verification>

<success_criteria>
- Streaming source component extends World Partition streaming source
- Blueprint-callable methods for enable/disable and range adjustment
- Predictive loading support for fast-moving vehicles
- Proper logging using GSD_LOG macros from GSD_Core
</success_criteria>

<output>
After completion, create `.planning/phases/02-world-partition-setup/02-03-SUMMARY.md`
</output>
