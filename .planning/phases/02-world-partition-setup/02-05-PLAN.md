---
phase: 02-world-partition-setup
plan: 05
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - Content/Maps/Charlotte_City.umap
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Actors/GSDCityLevelActor.h
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Actors/GSDCityLevelActor.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "World Partition level exists with grid-based cell configuration"
    - "Grid cells are sized at 25,600 UU (256m) for urban density"
    - "Loading range is set to 76,800 UU (768m) for driving gameplay"
    - "One File Per Actor is enabled for team collaboration"
  artifacts:
    - path: "Content/Maps/Charlotte_City.umap"
      provides: "Main World Partition level for Charlotte city"
      contains: "World Partition"
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Actors/GSDCityLevelActor.h"
      provides: "Level setup actor for World Partition configuration"
      exports: ["AGSDCityLevelActor"]
  key_links:
    - from: "GSDCityLevelActor"
      to: "World Settings"
      via: "BeginPlay configuration"
      pattern: "WorldPartition"
---

<objective>
Create Charlotte city level with World Partition configuration and One File Per Actor workflow.

Purpose: Establish the main game level with proper World Partition grid configuration for Charlotte urban environment, enabling streaming and team collaboration via OFPA.
Output: Charlotte_City level with grid-based World Partition and configuration actor.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-world-partition-setup/02-RESEARCH.md

# Prior phase context
@.planning/phases/01-plugin-architecture-foundation/05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create City Level Actor for Configuration</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Actors/GSDCityLevelActor.h
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Actors/GSDCityLevelActor.cpp
  </files>
  <action>
    Create a configuration actor for city level setup following the AGSDActor pattern from Phase 1:

    1. Create Actors/ directory under Public/ and Private/

    2. In GSDCityLevelActor.h:

       #pragma once

       #include "CoreMinimal.h"
       #include "GameFramework/Actor.h"
       #include "GSDCityLevelActor.generated.h"

       /**
        * Configuration actor for city levels with World Partition.
        * Placed in level to apply streaming and HLOD settings.
        */
       UCLASS(BlueprintType, ClassGroup=(GSD))
       class GSD_CITYSTREAMING_API AGSDCityLevelActor : public AActor
       {
           GENERATED_BODY()

       public:
           AGSDCityLevelActor();

           // Grid cell size in Unreal Units (default 25600 = 256m)
           UPROPERTY(EditAnywhere, BlueprintReadWrite, Category="World Partition|Grid", meta=(ClampMin=12800, ClampMax=102400))
           int32 GridCellSize = 25600;

           // Loading range in Unreal Units (default 76800 = 768m)
           UPROPERTY(EditAnywhere, BlueprintReadWrite, Category="World Partition|Grid", meta=(ClampMin=25600))
           int32 LoadingRange = 76800;

           // Enable predictive loading for fast-moving entities
           UPROPERTY(EditAnywhere, BlueprintReadWrite, Category="World Partition|Streaming")
           bool bEnablePredictiveLoading = true;

           // Block on slow streaming (prevents pop-in)
           UPROPERTY(EditAnywhere, BlueprintReadWrite, Category="World Partition|Streaming")
           bool bBlockOnSlowStreaming = true;

           // HLOD configuration reference
           UPROPERTY(EditAnywhere, BlueprintReadWrite, Category="HLOD")
           class UGSDHLODConfigAsset* HLODConfig;

       protected:
           virtual void BeginPlay() override;

       private:
           // Log configuration on startup for debugging
           void LogConfiguration();
       };

    3. In GSDCityLevelActor.cpp:

       #include "Actors/GSDCityLevelActor.h"
       #include "GSDLog.h"
       #include "DataAssets/GSDHLODConfigAsset.h"

       AGSDCityLevelActor::AGSDCityLevelActor()
       {
           PrimaryActorTick.bCanEverTick = false;

           // This actor is purely for configuration, no visual representation
           SetActorHiddenInGame(true);
           SetActorEnableCollision(false);
       }

       void AGSDCityLevelActor::BeginPlay()
       {
           Super::BeginPlay();
           LogConfiguration();
       }

       void AGSDCityLevelActor::LogConfiguration()
       {
           GSD_LOG(TEXT("GSDCityLevelActor: World Partition Configuration"));
           GSD_LOG(TEXT("  Grid Cell Size: %d UU (%.1f m)"), GridCellSize, GridCellSize / 100.0f);
           GSD_LOG(TEXT("  Loading Range: %d UU (%.1f m)"), LoadingRange, LoadingRange / 100.0f);
           GSD_LOG(TEXT("  Predictive Loading: %s"), bEnablePredictiveLoading ? TEXT("Enabled") : TEXT("Disabled"));
           GSD_LOG(TEXT("  Block on Slow Streaming: %s"), bBlockOnSlowStreaming ? TEXT("Yes") : TEXT("No"));

           if (HLODConfig)
           {
               GSD_LOG(TEXT("  HLOD Config: %s"), *HLODConfig->GetName());
           }
           else
           {
               GSD_LOG(TEXT("  HLOD Config: None (using defaults)"));
           }
       }

    This actor provides a centralized place for level configuration and follows the AGSDActor pattern from Phase 1 Plan 05.
  </action>
  <verify>
    Verify city level actor exists with correct configuration:
    - grep -c "AGSDCityLevelActor" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Actors/GSDCityLevelActor.h
    - grep -c "GridCellSize" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Actors/GSDCityLevelActor.h
    - grep -c "25600" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Actors/GSDCityLevelActor.h
  </verify>
  <done>
    City level actor exists with grid cell size (25600), loading range (76800), and HLOD config reference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Level Setup Documentation</name>
  <files>
    Plugins/GSD_CityStreaming/Docs/LevelSetup.md
  </files>
  <action>
    Create documentation for World Partition level setup:

    1. Create Docs/LevelSetup.md:

       # World Partition Level Setup

       ## Creating a New City Level

       1. Create new level using **Open World** template
          - File > New Level > Open World
          - This auto-enables World Partition + OFPA + HLOD

       2. Configure World Settings
          - Window > World Settings
          - World Partition Setup > Runtime Grids
          - Add grid: "MainGrid"
            - Cell Size: 25600 (256m)
            - Loading Range: 76800 (768m)
            - Block on Slow Streaming: Enabled

       3. Place GSDCityLevelActor
          - Drag from Content Browser or use Place Actors
          - Configure in Details panel
          - Actor logs configuration on BeginPlay

       4. Verify OFPA Enabled
          - World Settings > World > Use External Actors: Checked
          - Check for __ExternalActors__ folder in level directory

       ## Grid Configuration for Charlotte

       | Setting | Value | Reason |
       |---------|-------|--------|
       | Cell Size | 25600 UU (256m) | 2.5 city blocks per cell |
       | Loading Range | 76800 UU (768m) | 3x3 grid for smooth driving |
       | Block on Slow Streaming | Yes | Prevents pop-in |

       ## Editor Hash Configuration

       For editor performance with large levels:
       - Cell Size: 51200 UU (512m)
       - Larger cells reduce editor overhead

       ## Console Commands for Verification

       - `wp.Runtime.ToggleDrawRuntimeHash2D` - Show grid overlay
       - `stat streaming` - Streaming performance stats
       - `wp.Runtime.OverrideRuntimeSpatialHashLoadingRange -grid=0 -range=100000` - Test different ranges

       ## Common Issues

       - **OFPA not working:** Check Use External Actors in World Settings
       - **Cells not loading:** Verify streaming source is active
       - **HLOD not visible:** Run Build > Build HLODs

    This documentation follows RESEARCH.md patterns and provides step-by-step level setup guidance.
  </action>
  <verify>
    Verify level setup documentation exists:
    - grep -c "World Partition" Plugins/GSD_CityStreaming/Docs/LevelSetup.md
    - grep -c "25600" Plugins/GSD_CityStreaming/Docs/LevelSetup.md
    - grep -c "Use External Actors" Plugins/GSD_CityStreaming/Docs/LevelSetup.md
  </verify>
  <done>
    Level setup documentation exists with grid configuration and OFPA verification steps.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Level Template Instructions</name>
  <files>
    Plugins/GSD_CityStreaming/Docs/CharlotteCityLevel.md
  </files>
  <action>
    Create specific instructions for the Charlotte_City level:

    1. Create Docs/CharlotteCityLevel.md:

       # Charlotte City Level

       ## Overview
       Main gameplay level for Zombie Taxi, featuring Charlotte urban environment with World Partition streaming.

       ## Level Path
       `/Game/Maps/Charlotte_City.umap`

       ## Setup Checklist

       - [ ] Create level from Open World template
       - [ ] Configure World Partition grid (256m cells, 768m range)
       - [ ] Enable One File Per Actor
       - [ ] Place GSDCityLevelActor with configuration
       - [ ] Create HLOD layers for foliage, buildings, terrain
       - [ ] Import city tiles from blender_gsd
       - [ ] Generate HLODs
       - [ ] Test streaming with player character

       ## Grid Settings

       ```
       World Partition Setup > Runtime Grids:
         [0]:
           Grid Name: "MainGrid"
           Cell Size: 25600
           Loading Range: 76800
           Block on Slow Streaming: true
           Priority: 0
           Debug Color: (R=1, G=0, B=0, A=1)
       ```

       ## Content Organization

       ```
       /Game/
       ├── Maps/
       │   └── Charlotte_City.umap
       ├── CityTiles/
       │   ├── Downtown/
       │   ├── Midtown/
       │   └── Suburbs/
       ├── HLOD/
       │   ├── HLOD_Foliage.uasset
       │   ├── HLOD_Buildings.uasset
       │   └── HLOD_Terrain.uasset
       └── __ExternalActors__/
           └── Maps/
               └── Charlotte_City/
       ```

       ## Next Steps

       After level setup:
       1. Import city tiles (Plan 04 interface)
       2. Generate HLODs (Plan 02 workflow)
       3. Test streaming performance
       4. Configure streaming sources on vehicles

    Note: The actual .umap file must be created in the Unreal Editor.
    This documentation provides the configuration values and workflow.
  </action>
  <verify>
    Verify Charlotte level documentation exists:
    - grep -c "Charlotte_City" Plugins/GSD_CityStreaming/Docs/CharlotteCityLevel.md
    - grep -c "MainGrid" Plugins/GSD_CityStreaming/Docs/CharlotteCityLevel.md
    - grep -c "25600" Plugins/GSD_CityStreaming/Docs/CharlotteCityLevel.md
  </verify>
  <done>
    Charlotte city level documentation exists with setup checklist and content organization.
  </done>
</task>

</tasks>

<verification>
1. AGSDCityLevelActor exists with grid configuration properties
2. Grid cell size defaults to 25600 UU (256m)
3. Loading range defaults to 76800 UU (768m)
4. Level setup documentation covers World Partition configuration
5. Charlotte level documentation provides specific setup instructions
6. OFPA verification steps are documented
</verification>

<success_criteria>
- City level actor provides World Partition configuration
- Grid cell size: 25,600 UU (256m) for Charlotte urban density
- Loading range: 76,800 UU (768m) for driving gameplay
- Documentation covers level setup, grid config, and OFPA workflow
</success_criteria>

<output>
After completion, create `.planning/phases/02-world-partition-setup/02-05-SUMMARY.md`
</output>
