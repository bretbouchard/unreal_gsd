---
phase: 02-world-partition-setup
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Interfaces/IGSDCityTileImporter.h
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Interfaces/IGSDCityTileImporter.cpp
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Types/GSDImportTypes.h
  - Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Types/GSDImportTypes.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "City tiles can be imported from USD files with correct scale"
    - "City tiles can be imported from FBX files as fallback"
    - "Collision is automatically generated for imported geometry"
  artifacts:
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Interfaces/IGSDCityTileImporter.h"
      provides: "Interface for city tile import operations"
      exports: ["IGSDCityTileImporter", "UIGSDCityTileImporter"]
    - path: "Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Types/GSDImportTypes.h"
      provides: "Import configuration types"
      exports: ["FGSDImportConfig"]
  key_links:
    - from: "IGSDCityTileImporter"
      to: "USD/FBX Importer"
      via: "ImportTile method"
      pattern: "ImportTile"
---

<objective>
Create city tile import interface for USD/FBX pipeline from blender_gsd.

Purpose: Establish a standardized import workflow for city tiles exported from Blender, supporting both USD (preferred) and FBX formats with correct scale and collision generation.
Output: Import interface and types for city tile import pipeline.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-world-partition-setup/02-RESEARCH.md

# Prior phase context
@.planning/phases/01-plugin-architecture-foundation/02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Import Types and Configuration</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Types/GSDImportTypes.h
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Types/GSDImportTypes.cpp
  </files>
  <action>
    Create import configuration types for city tile pipeline:

    1. Create Types/GSDImportTypes.h:

       #pragma once

       #include "CoreMinimal.h"
       #include "GSDImportTypes.generated.h"

       // Import format options
       UENUM(BlueprintType)
       enum class EGSDImportFormat : uint8
       {
           USD,    // Preferred - supports layering, better material handling
           FBX     // Fallback - most compatible format
       };

       // Collision generation options
       UENUM(BlueprintType)
       enum class EGSDCollisionType : uint8
       {
           None,           // No collision
           ConvexHull,     // Simple convex collision
           Simple,         // Auto-generated simple collision
           Complex         // Per-triangle collision (expensive)
       };

       // Import configuration for a city tile
       USTRUCT(BlueprintType)
       struct FGSDImportConfig
       {
           GENERATED_BODY()

           // Source file path (relative to project or absolute)
           UPROPERTY(EditAnywhere, BlueprintReadWrite)
           FString SourceFilePath;

           // Import format (auto-detected from extension if not specified)
           UPROPERTY(EditAnywhere, BlueprintReadWrite)
           EGSDImportFormat Format = EGSDImportFormat::USD;

           // Import scale (1.0 = no scale adjustment, USD/FBX should be in cm)
           UPROPERTY(EditAnywhere, BlueprintReadWrite)
           float ImportScale = 1.0f;

           // Collision generation type
           UPROPERTY(EditAnywhere, BlueprintReadWrite)
           EGSDCollisionType CollisionType = EGSDCollisionType::ConvexHull;

           // Auto-generate collision on import
           UPROPERTY(EditAnywhere, BlueprintReadWrite)
           bool bAutoGenerateCollision = true;

           // Combine meshes during import (usually false for city tiles)
           UPROPERTY(EditAnywhere, BlueprintReadWrite)
           bool bCombineMeshes = false;

           // Destination path for imported assets
           UPROPERTY(EditAnywhere, BlueprintReadWrite)
           FString DestinationPath = "/Game/CityTiles";

           // Tile identifier for naming
           UPROPERTY(EditAnywhere, BlueprintReadWrite)
           FString TileName;
       };

       // Result of an import operation
       USTRUCT(BlueprintType)
       struct FGSDImportResult
       {
           GENERATED_BODY()

           UPROPERTY(BlueprintReadOnly)
           bool bSuccess = false;

           UPROPERTY(BlueprintReadOnly)
           FString ErrorMessage;

           UPROPERTY(BlueprintReadOnly)
           TArray<FString> ImportedAssets;

           UPROPERTY(BlueprintReadOnly)
           FString ImportedStaticMeshPath;
       };

    2. Create Types/GSDImportTypes.cpp with helper function:
       - EGSDImportFormat DetectFormatFromExtension(const FString& FilePath)
       - Returns USD for .usd/.usda/.usdc, FBX for .fbx, throws error otherwise
  </action>
  <verify>
    Verify import types exist with correct structure:
    - grep -c "EGSDImportFormat" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Types/GSDImportTypes.h
    - grep -c "FGSDImportConfig" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Types/GSDImportTypes.h
    - grep -c "FGSDImportResult" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Types/GSDImportTypes.h
  </verify>
  <done>
    Import types define format options (USD/FBX), collision types, and import configuration/result structs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create City Tile Importer Interface</name>
  <files>
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Interfaces/IGSDCityTileImporter.h
    Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Interfaces/IGSDCityTileImporter.cpp
  </files>
  <action>
    Create the import interface following the BlueprintNativeEvent pattern from Phase 1:

    1. Create Interfaces/IGSDCityTileImporter.h:

       #pragma once

       #include "CoreMinimal.h"
       #include "UObject/Interface.h"
       #include "Types/GSDImportTypes.h"
       #include "IGSDCityTileImporter.generated.h"

       // Delegate for import completion
       DECLARE_DYNAMIC_MULTICAST_DELEGATE_TwoParams(FGSDOnImportComplete, const FGSDImportResult&, Result, const FString&, TileName);

       /**
        * Interface for importing city tiles from external sources.
        * Supports USD (preferred) and FBX formats from blender_gsd pipeline.
        */
       UINTERFACE(BlueprintType, meta=(CannotImplementInterfaceInBlueprint))
       class GSD_CITYSTREAMING_API UGSDCityTileImporter : public UInterface
       {
           GENERATED_BODY()
       };

       class GSD_CITYSTREAMING_API IGSDCityTileImporter
       {
           GENERATED_BODY()

       public:
           // Import a single city tile with the given configuration
           UFUNCTION(BlueprintCallable, Category="GSD|Import")
           virtual FGSDImportResult ImportTile(const FGSDImportConfig& Config);

           // Import multiple tiles in batch
           UFUNCTION(BlueprintCallable, Category="GSD|Import")
           virtual TArray<FGSDImportResult> ImportTilesBatch(const TArray<FGSDImportConfig>& Configs);

           // Validate import configuration before import
           UFUNCTION(BlueprintCallable, Category="GSD|Import")
           virtual bool ValidateConfig(const FGSDImportConfig& Config, FString& OutErrorMessage);

           // Get supported import formats
           UFUNCTION(BlueprintCallable, Category="GSD|Import")
           virtual TArray<EGSDImportFormat> GetSupportedFormats() const;

           // Async import with callback
           UFUNCTION(BlueprintCallable, Category="GSD|Import")
           virtual void ImportTileAsync(const FGSDImportConfig& Config, FGSDOnImportComplete& OnComplete);

       protected:
           // Internal import implementation for USD format
           virtual FGSDImportResult ImportUSD(const FGSDImportConfig& Config);

           // Internal import implementation for FBX format
           virtual FGSDImportResult ImportFBX(const FGSDImportConfig& Config);
       };

    2. Create Interfaces/IGSDCityTileImporter.cpp with default implementations:
       - ImportTile: Detects format, routes to ImportUSD or ImportFBX
       - ImportTilesBatch: Loops through configs, returns results array
       - ValidateConfig: Checks file exists, valid extension, destination path valid
       - GetSupportedFormats: Returns {USD, FBX}
       - ImportTileAsync: Placeholder for async import (future enhancement)
       - ImportUSD/ImportFBX: Placeholder implementations that return bSuccess=false with message

    Note: Actual import logic requires editor-only functionality. These are interface stubs
    that will be implemented with actual import code in future plans when editor integration is added.
    The interface establishes the contract for the import pipeline.
  </action>
  <verify>
    Verify import interface exists with correct methods:
    - grep -c "IGSDCityTileImporter" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Interfaces/IGSDCityTileImporter.h
    - grep -c "ImportTile" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Interfaces/IGSDCityTileImporter.h
    - grep -c "ImportUSD" Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Private/Interfaces/IGSDCityTileImporter.cpp
  </verify>
  <done>
    City tile importer interface defines ImportTile, ImportTilesBatch, ValidateConfig, and format-specific methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document Import Workflow</name>
  <files>
    Plugins/GSD_CityStreaming/Docs/ImportWorkflow.md
  </files>
  <action>
    Create documentation for the city tile import workflow:

    1. Create Docs/ImportWorkflow.md:

       # City Tile Import Workflow

       ## Overview
       Import city tiles from blender_gsd into Unreal Engine with correct scale and collision.

       ## Supported Formats

       ### USD (Preferred)
       - File extensions: .usd, .usda, .usdc
       - Benefits: Layering support, better material handling, industry standard
       - Use relative texture paths: `./textures/`
       - Convert materials to UsdPreviewSurface standard

       ### FBX (Fallback)
       - File extension: .fbx
       - Benefits: Most compatible, well-supported
       - Export from Blender with Scene Scale: 1.0 (centimeters)

       ## Import Configuration

       | Setting | Default | Description |
       |---------|---------|-------------|
       | ImportScale | 1.0 | Scale multiplier (should be 1.0 for cm export) |
       | CollisionType | ConvexHull | Auto-generated collision type |
       | bAutoGenerateCollision | true | Generate collision on import |
       | bCombineMeshes | false | Keep meshes separate for HLOD |

       ## Collision Types

       | Type | Use Case |
       |------|----------|
       | None | Decorative only |
       | ConvexHull | Simple collision, fast |
       | Simple | Auto-generated, balanced |
       | Complex | Per-triangle, expensive |

       ## Workflow

       1. Export city tiles from blender_gsd
       2. Configure FGSDImportConfig with source path
       3. Call ImportTile or ImportTilesBatch
       4. Verify collision in Editor (Show > Collision)
       5. Test with player character (196 cm reference)

       ## Troubleshooting

       - **Wrong scale:** Check export settings in Blender (should be 1.0)
       - **Missing collision:** Enable bAutoGenerateCollision
       - **Large file size:** Use USD for better compression
       - **Material issues:** Use UsdPreviewSurface in USD files

    This documentation follows RESEARCH.md Pattern 4 and provides guidance for the import pipeline.
  </action>
  <verify>
    Verify documentation exists with import workflow:
    - grep -c "ImportWorkflow" Plugins/GSD_CityStreaming/Docs/ImportWorkflow.md
    - grep -c "USD" Plugins/GSD_CityStreaming/Docs/ImportWorkflow.md
    - grep -c "ConvexHull" Plugins/GSD_CityStreaming/Docs/ImportWorkflow.md
  </verify>
  <done>
    Import workflow documentation exists with format guidance and troubleshooting.
  </done>
</task>

</tasks>

<verification>
1. EGSDImportFormat enum defines USD and FBX options
2. EGSDCollisionType enum defines collision generation options
3. FGSDImportConfig struct contains all import settings
4. FGSDImportResult struct contains import outcome
5. IGSDCityTileImporter interface defines import contract
6. Import workflow documentation exists
</verification>

<success_criteria>
- Import types support USD (preferred) and FBX (fallback) formats
- Collision types include None, ConvexHull, Simple, Complex
- Import interface follows BlueprintNativeEvent pattern from Phase 1
- Documentation covers format selection and collision configuration
</success_criteria>

<output>
After completion, create `.planning/phases/02-world-partition-setup/02-04-SUMMARY.md`
</output>
