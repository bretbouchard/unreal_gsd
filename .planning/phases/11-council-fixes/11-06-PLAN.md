---
phase: 11-council-fixes
plan: 06
type: execute
wave: 3
depends_on: [11-05]
files_modified:
  - Plugins/GSD_Audio/Source/GSD_Audio/Public/Audio/GSDSpatialAudioSettings.h
  - Plugins/GSD_Audio/Source/GSD_Audio/Public/Audio/GSDAttenuationSettings.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Processors/GSDCrowdLODProcessor.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp
autonomous: true
must_haves:
  truths:
    - "Attenuation settings exist for different entity types (crowds, vehicles)"
    - "Audio LOD integrated into crowd processor"
    - "3D audio attenuates correctly with distance"
    - "Occlusion and reverb settings configured"
  artifacts:
    - path: "Plugins/GSD_Audio/Source/GSD_Audio/Public/Audio/GSDAttenuationSettings.h"
      provides: "Attenuation settings constants"
      contains: "AttenuationDistances, CrowdAudioLOD"
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp"
      provides: "Audio LOD in crowd processing"
      contains: "AudioLOD, Attenuation"
  key_links:
    - from: "GSDCrowdLODProcessor"
      to: "GSD_Audio"
      via: "Attenuation settings"
      pattern: "SetAttenuationSettings|AudioLOD"
---

<objective>
Configure spatial audio with attenuation settings for different entity types and integrate audio LOD into crowd processor.

Purpose: Complete the audio infrastructure with proper 3D spatialization. Council review identified missing spatial audio attenuation and audio LOD as high priority issues.

Output: Attenuation settings for crowds/vehicles, audio LOD in crowd processor, occlusion/reverb configuration.

Council Issues: #17, #18 - No spatial audio attenuation, no audio LOD in crowd processor (Audio Rick, P1)
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-council-fixes/11-RESEARCH.md
@.planning/phases/11-council-fixes/11-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Attenuation Settings</name>
  <files>
    Plugins/GSD_Audio/Source/GSD_Audio/Public/Audio/GSDAttenuationSettings.h
  </files>
  <action>
Define attenuation settings constants for different entity types.

**Attenuation Settings Header:**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "Sound/AttenuationSettings.h"
#include "GSDAttenuationSettings.generated.h"

/**
 * Attenuation distances for different entity types.
 * Based on gameplay requirements and audio design guidelines.
 */
namespace GSDAttenuationDistances
{
    // Crowd entities (zombies, NPCs)
    static constexpr float CrowdInnerRadius = 100.0f;   // Full volume
    static constexpr float CrowdFalloffDistance = 1000.0f;  // Begin falloff
    static constexpr float CrowdCutoffDistance = 5000.0f;  // Silent

    // Vehicles
    static constexpr float VehicleInnerRadius = 200.0f;
    static constexpr float VehicleFalloffDistance = 2000.0f;
    static constexpr float VehicleCutoffDistance = 10000.0f;

    // Voice (hero NPCs, dialogue)
    static constexpr float VoiceInnerRadius = 50.0f;
    static constexpr float VoiceFalloffDistance = 500.0f;
    static constexpr float VoiceCutoffDistance = 2000.0f;

    // Ambient sounds (fires, parties)
    static constexpr float AmbienceInnerRadius = 300.0f;
    static constexpr float AmbienceFalloffDistance = 3000.0f;
    static constexpr float AmbienceCutoffDistance = 10000.0f;

    // UI sounds (no attenuation - 2D)
    static constexpr float UIAttenuation = 0.0f;  // No distance attenuation
}

/**
 * Audio LOD distances for crowd processor.
 * Controls when sounds are played, attenuated, or culled.
 */
namespace GSDAudioLOD
{
    // LOD 0: Full audio (close entities)
    static constexpr float LOD0_Distance = 500.0f;

    // LOD 1: Reduced audio (mid-distance entities)
    static constexpr float LOD1_Distance = 2000.0f;
    static constexpr float LOD1_VolumeMultiplier = 0.5f;

    // LOD 2: Minimal audio (far entities)
    static constexpr float LOD2_Distance = 4000.0f;
    static constexpr float LOD2_VolumeMultiplier = 0.25f;

    // LOD 3: Culled (no audio)
    static constexpr float CullDistance = 5000.0f;
}

/**
 * Attenuation asset paths for loading.
 */
namespace GSDAttenuationPaths
{
    static const FString CrowdAttenuation = TEXT("/GSD_Audio/Audio/Attenuation/CrowdAttenuation.CrowdAttenuation");
    static const FString VehicleAttenuation = TEXT("/GSD_Audio/Audio/Attenuation/VehicleAttenuation.VehicleAttenuation");
    static const FString VoiceAttenuation = TEXT("/GSD_Audio/Audio/Attenuation/VoiceAttenuation.VoiceAttenuation");
    static const FString AmbienceAttenuation = TEXT("/GSD_Audio/Audio/Attenuation/AmbienceAttenuation.AmbienceAttenuation");
}

/**
 * Occlusion and reverb settings.
 */
namespace GSDSpatialAudioSettings
{
    // Enable occlusion for these sound types
    static const TArray<FName> OcclusionEnabled = {
        FName("Voice"),
        FName("Crowd"),
        FName("Vehicle")
    };

    // Enable reverb for these sound types
    static const TArray<FName> ReverbEnabled = {
        FName("Ambience"),
        FName("Voice"),
        FName("Crowd")
    };

    // Occlusion interpolation time (smooth occlusion changes)
    static constexpr float OcclusionInterpolationTime = 0.3f;

    // Reverb wet level multiplier
    static constexpr float ReverbWetLevel = 0.4f;
}
```

**Asset Creation Note:**
Create USoundAttenuation assets in Unreal Editor:
- Content Browser -> Add -> Sounds -> Sound Attenuation Settings
- Configure Falloff Distance, Attenuation Shape (Sphere)
- Enable Occlusion/Reverb as needed
- Save to: /GSD_Audio/Audio/Attenuation/

**Important:**
- Define distance thresholds for all entity types
- Audio LOD distances match visual LOD for consistency
- Document which sound types use occlusion/reverb
- Provide asset paths for loading
  </action>
  <verify>
    ```bash
    # Verify Attenuation Settings header
    test -f Plugins/GSD_Audio/Source/GSD_Audio/Public/Audio/GSDAttenuationSettings.h && echo "✓ Attenuation Settings header exists" || echo "✗ Attenuation Settings header missing"

    # Check for required settings
    grep -q "CrowdInnerRadius" Plugins/GSD_Audio/Source/GSD_Audio/Public/Audio/GSDAttenuationSettings.h && echo "✓ Crowd attenuation defined" || echo "✗ Crowd attenuation missing"
    grep -q "GSDAudioLOD" Plugins/GSD_Audio/Source/GSD_Audio/Public/Audio/GSDAttenuationSettings.h && echo "✓ Audio LOD defined" || echo "✗ Audio LOD missing"
    grep -q "OcclusionEnabled" Plugins/GSD_Audio/Source/GSD_Audio/Public/Audio/GSDAttenuationSettings.h && echo "✓ Occlusion settings defined" || echo "✗ Occlusion settings missing"

    echo "Attenuation Settings verification complete"
    ```
  </verify>
  <done>
    - Attenuation distances defined for all entity types
    - Audio LOD distances and volume multipliers specified
    - Occlusion and reverb settings configured
    - Asset paths documented for editor creation
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Audio LOD into Crowd Processor</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Processors/GSDCrowdLODProcessor.h
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp
  </files>
  <action>
Add audio LOD logic to GSDCrowdLODProcessor to control audio based on distance.

**Update GSDCrowdLODProcessor.h:**
```cpp
// Add to existing includes
#include "Audio/GSDAttenuationSettings.h"

// Add to UGSDCrowdLODProcessor class declaration (if not already present)
public:
    // Audio LOD configuration
    UPROPERTY(EditDefaultsOnly, Category = "Audio")
    bool bEnableAudioLOD = true;

    UPROPERTY(EditDefaultsOnly, Category = "Audio")
    float AudioLOD0Distance = GSDAudioLOD::LOD0_Distance;

    UPROPERTY(EditDefaultsOnly, Category = "Audio")
    float AudioLOD1Distance = GSDAudioLOD::LOD1_Distance;

    UPROPERTY(EditDefaultsOnly, Category = "Audio")
    float AudioLOD2Distance = GSDAudioLOD::LOD2_Distance;

    UPROPERTY(EditDefaultsOnly, Category = "Audio")
    float AudioCullDistance = GSDAudioLOD::CullDistance;

protected:
    // Calculate audio LOD based on distance
    float CalculateAudioLODVolume(float DistanceToListener) const;

    // Check if audio should be culled
    bool ShouldCullAudio(float DistanceToListener) const;
```

**Update GSDCrowdLODProcessor.cpp:**
```cpp
// Add to existing includes
#include "Audio/GSDAttenuationSettings.h"

// Add implementation methods

float UGSDCrowdLODProcessor::CalculateAudioLODVolume(float DistanceToListener) const
{
    if (!bEnableAudioLOD)
    {
        return 1.0f;  // No LOD, full volume
    }

    if (DistanceToListener < AudioLOD0Distance)
    {
        // LOD 0: Full audio
        return 1.0f;
    }
    else if (DistanceToListener < AudioLOD1Distance)
    {
        // LOD 1: Reduced audio
        return GSDAudioLOD::LOD1_VolumeMultiplier;
    }
    else if (DistanceToListener < AudioLOD2Distance)
    {
        // LOD 2: Minimal audio
        return GSDAudioLOD::LOD2_VolumeMultiplier;
    }

    // Beyond LOD 2: Culled
    return 0.0f;
}

bool UGSDCrowdLODProcessor::ShouldCullAudio(float DistanceToListener) const
{
    if (!bEnableAudioLOD)
    {
        return false;  // Never cull if LOD disabled
    }

    return DistanceToListener >= AudioCullDistance;
}

// NOTE: Integration with actual sound playback would happen in execution phase
// This provides the LOD calculation logic that can be used by audio systems
```

**Important:**
- Audio LOD distances match visual LOD for consistency
- Volume multipliers reduce audio for distant entities
- Culling prevents playing audio for very far entities
- Configuration via properties (not hardcoded)
- bEnableAudioLOD allows disabling for debugging

**Integration Note:**
Actual audio playback integration would connect to:
- Entity spawn audio (one-shot sounds)
- Looping ambient sounds (crowd murmurs)
- Event-triggered audio (moans, reactions)
  </action>
  <verify>
    ```bash
    # Verify Audio LOD integration
    grep -q "bEnableAudioLOD" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/Processors/GSDCrowdLODProcessor.h && echo "✓ Audio LOD flag added" || echo "✗ Audio LOD flag missing"
    grep -q "CalculateAudioLODVolume" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp && echo "✓ Audio LOD calculation implemented" || echo "✗ Audio LOD calculation missing"
    grep -q "ShouldCullAudio" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/Processors/GSDCrowdLODProcessor.cpp && echo "✓ Audio culling implemented" || echo "✗ Audio culling missing"

    echo "Audio LOD integration verification complete"
    ```
  </verify>
  <done>
    - Audio LOD properties added to GSDCrowdLODProcessor
    - CalculateAudioLODVolume() calculates volume based on distance
    - ShouldCullAudio() determines if audio should be skipped
    - Configuration via EditDefaultsOnly properties
    - Integration points documented for future audio playback
  </done>
</task>

</tasks>

<verification>
1. Attenuation settings defined for crowds, vehicles, voice, ambience
2. Audio LOD distances and multipliers configured
3. Occlusion and reverb settings documented
4. Audio LOD integrated into crowd processor
5. Volume calculation and culling logic implemented
</verification>

<success_criteria>
- Attenuation distances for all entity types (Crowd: 5000, Vehicle: 10000, Voice: 2000)
- Audio LOD: LOD0 (500), LOD1 (2000, 0.5x), LOD2 (4000, 0.25x), Cull (5000)
- Occlusion enabled for Voice, Crowd, Vehicle
- Reverb enabled for Ambience, Voice, Crowd
- GSDCrowdLODProcessor has audio LOD calculation
</success_criteria>

<output>
After completion, create `.planning/phases/11-council-fixes/11-06-SUMMARY.md`
</output>
