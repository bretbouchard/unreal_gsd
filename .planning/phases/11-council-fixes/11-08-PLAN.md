---
phase: 11-council-fixes
plan: 08
type: execute
wave: 5
depends_on: [11-07]
files_modified:
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDHeroAIConfig.h
  - Plugins/GSD_Crowds/Source/GSD_Crowds/Private/DataAssets/GSDHeroAIConfig.cpp
autonomous: true
must_haves:
  truths:
    - "AGSDHeroAIController exists with Behavior Tree component"
    - "AI Perception configured for sight and hearing"
    - "Behavior Tree asset structure created"
    - "Hero NPCs navigate and perceive environment"
  artifacts:
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h"
      provides: "Hero NPC AI controller"
      contains: "UBehaviorTreeComponent, UAIPerceptionComponent"
      min_lines: 60
    - path: "Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDHeroAIConfig.h"
      provides: "AI configuration"
      contains: "SightConfig, HearingConfig, BehaviorTree"
  key_links:
    - from: "AGSDHeroAIController"
      to: "Behavior Tree"
      via: "RunBehaviorTree"
      pattern: "RunBehaviorTree|OnPossess"
---

<objective>
Create Hero NPC AI system with Behavior Tree and AI Perception.

Purpose: Complete the Hero NPC AI implementation. Council review identified missing Hero NPC AI Controller as a high-priority issue. Hero NPCs need full AI capabilities for gameplay-critical interactions.

Output: AGSDHeroAIController with Behavior Tree component, AI Perception config, and UGSDHeroAIConfig DataAsset.

Council Issues: #11 - No Hero NPC AI Controller (Swarm Rick, P0)
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-council-fixes/11-RESEARCH.md

# Reference Phase 7 work
@.planning/phases/07-crowd-ai-navigation/07-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance AGSDHeroAIController</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp
  </files>
  <action>
Enhance AGSDHeroAIController with complete AI capabilities (if not already complete from Phase 7).

**GSDHeroAIController.h:**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "AIController.h"
#include "Perception/AIPerceptionComponent.h"
#include "BehaviorTree/BehaviorTreeComponent.h"
#include "BehaviorTree/BlackboardComponent.h"
#include "GSDHeroAIController.generated.h"

class UGSDHeroAIConfig;
class UAISenseConfig_Sight;
class UAISenseConfig_Hearing;

/**
 * AI Controller for Hero NPCs (gameplay-critical NPCs).
 * Provides Behavior Tree execution, AI Perception, and advanced AI behaviors.
 */
UCLASS()
class GSD_CROWDS_API AGSDHeroAIController : public AAIController
{
    GENERATED_BODY()

public:
    AGSDHeroAIController();

    // AAIController interface
    virtual void BeginPlay() override;
    virtual void OnPossess(APawn* InPawn) override;
    virtual void Tick(float DeltaTime) override;

    // Behavior Tree
    UFUNCTION(BlueprintCallable, Category = "GSD|AI")
    bool RunBehaviorTreeAsset(UBehaviorTree* BTAsset);

    UFUNCTION(BlueprintCallable, Category = "GSD|AI")
    void StopBehaviorTree();

    // Perception
    UFUNCTION(BlueprintCallable, Category = "GSD|AI")
    TArray<AActor*> GetPerceivedActors(TSubclassOf<UAISense> Sense) const;

    UFUNCTION(BlueprintCallable, Category = "GSD|AI")
    bool HasLineOfSightTo(AActor* Target) const;

    // Configuration
    UFUNCTION(BlueprintCallable, Category = "GSD|AI")
    void SetAIConfig(UGSDHeroAIConfig* NewConfig);

protected:
    // Components
    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
    UBehaviorTreeComponent* BehaviorTreeComponent;

    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
    UBlackboardComponent* BlackboardComponent;

    UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = "Components")
    UAIPerceptionComponent* PerceptionComponent;

    // Configuration
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Configuration")
    UGSDHeroAIConfig* AIConfig;

    // Perception configs (created from AIConfig)
    UPROPERTY()
    UAISenseConfig_Sight* SightConfig;

    UPROPERTY()
    UAISenseConfig_Hearing* HearingConfig;

    // State
    UPROPERTY(BlueprintReadOnly, Category = "State")
    bool bBehaviorTreeRunning;

private:
    void InitializePerception();
    void ConfigureSight();
    void ConfigureHearing();

    // Perception delegates
    UFUNCTION()
    void OnTargetPerceptionUpdated(AActor* Actor, FAIStimulus Stimulus);
};
```

**GSDHeroAIController.cpp:**
```cpp
#include "AI/GSDHeroAIController.h"
#include "DataAssets/GSDHeroAIConfig.h"
#include "Perception/AISenseConfig_Sight.h"
#include "Perception/AISenseConfig_Hearing.h"
#include "BehaviorTree/BehaviorTree.h"
#include "BehaviorTree/BlackboardComponent.h"

AGSDHeroAIController::AGSDHeroAIController()
{
    // Create components
    BehaviorTreeComponent = CreateDefaultSubobject<UBehaviorTreeComponent>(TEXT("BehaviorTreeComponent"));
    BlackboardComponent = CreateDefaultSubobject<UBlackboardComponent>(TEXT("BlackboardComponent"));
    PerceptionComponent = CreateDefaultSubobject<UAIPerceptionComponent>(TEXT("PerceptionComponent"));

    bBehaviorTreeRunning = false;
}

void AGSDHeroAIController::BeginPlay()
{
    Super::BeginPlay();

    // Initialize perception if config is available
    if (AIConfig)
    {
        InitializePerception();
    }
}

void AGSDHeroAIController::OnPossess(APawn* InPawn)
{
    Super::OnPossess(InPawn);

    // CRITICAL: Run behavior tree immediately on possess (Pitfall 5 from research)
    if (AIConfig && AIConfig->DefaultBehaviorTree)
    {
        RunBehaviorTreeAsset(AIConfig->DefaultBehaviorTree);
    }
}

void AGSDHeroAIController::Tick(float DeltaTime)
{
    Super::Tick(DeltaTime);

    // Optional: Add tick logic for AI decision making
}

bool AGSDHeroAIController::RunBehaviorTreeAsset(UBehaviorTree* BTAsset)
{
    if (!BTAsset)
    {
        UE_LOG(LogTemp, Warning, TEXT("RunBehaviorTreeAsset: Null Behavior Tree"));
        return false;
    }

    // Initialize blackboard
    if (!BlackboardComponent->InitializeBlackboard(*BTAsset->BlackboardAsset))
    {
        UE_LOG(LogTemp, Error, TEXT("Failed to initialize blackboard"));
        return false;
    }

    // Start behavior tree
    BehaviorTreeComponent->StartTree(*BTAsset);
    bBehaviorTreeRunning = true;

    UE_LOG(LogTemp, Log, TEXT("Behavior Tree started: %s"), *BTAsset->GetName());
    return true;
}

void AGSDHeroAIController::StopBehaviorTree()
{
    BehaviorTreeComponent->StopTree();
    bBehaviorTreeRunning = false;
}

TArray<AActor*> AGSDHeroAIController::GetPerceivedActors(TSubclassOf<UAISense> Sense) const
{
    TArray<AActor*> PerceivedActors;
    if (PerceptionComponent)
    {
        PerceptionComponent->GetCurrentlyPerceivedActors(Sense, PerceivedActors);
    }
    return PerceivedActors;
}

bool AGSDHeroAIController::HasLineOfSightTo(AActor* Target) const
{
    if (!Target)
    {
        return false;
    }

    FHitResult HitResult;
    FVector StartLocation = GetPawn()->GetActorLocation();
    FVector EndLocation = Target->GetActorLocation();

    FCollisionQueryParams QueryParams;
    QueryParams.AddIgnoredActor(GetPawn());

    bool bHit = GetWorld()->LineTraceSingleByChannel(
        HitResult,
        StartLocation,
        EndLocation,
        ECC_Visibility,
        QueryParams
    );

    return !bHit || HitResult.GetActor() == Target;
}

void AGSDHeroAIController::SetAIConfig(UGSDHeroAIConfig* NewConfig)
{
    AIConfig = NewConfig;

    if (AIConfig)
    {
        InitializePerception();

        // Restart behavior tree if new config has different BT
        if (AIConfig->DefaultBehaviorTree && bBehaviorTreeRunning)
        {
            RunBehaviorTreeAsset(AIConfig->DefaultBehaviorTree);
        }
    }
}

void AGSDHeroAIController::InitializePerception()
{
    if (!AIConfig || !PerceptionComponent)
    {
        return;
    }

    // Configure senses
    ConfigureSight();
    ConfigureHearing();

    // Bind perception delegate
    PerceptionComponent->OnTargetPerceptionUpdated.AddDynamic(
        this,
        &AGSDHeroAIController::OnTargetPerceptionUpdated
    );
}

void AGSDHeroAIController::ConfigureSight()
{
    SightConfig = NewObject<UAISenseConfig_Sight>(this);

    // Configure sight from AIConfig
    SightConfig->SightRadius = AIConfig->SightRadius;
    SightConfig->LoseSightRadius = AIConfig->LoseSightRadius;
    SightConfig->PeripheralVisionAngleDegrees = AIConfig->PeripheralVisionAngle;

    // Detection settings
    SightConfig->DetectionByAffiliation.bDetectEnemies = true;
    SightConfig->DetectionByAffiliation.bDetectFriendlies = true;
    SightConfig->DetectionByAffiliation.bDetectNeutrals = true;

    // Set auto success range for close-range detection
    SightConfig->AutoSuccessRangeFromLastSeenLocation = 500.0f;

    // Apply to perception component
    PerceptionComponent->ConfigureSense(*SightConfig);
}

void AGSDHeroAIController::ConfigureHearing()
{
    HearingConfig = NewObject<UAISenseConfig_Hearing>(this);

    // Configure hearing from AIConfig
    HearingConfig->HearingRange = AIConfig->HearingRange;

    // Detection settings
    HearingConfig->DetectionByAffiliation.bDetectEnemies = true;
    HearingConfig->DetectionByAffiliation.bDetectFriendlies = true;
    HearingConfig->DetectionByAffiliation.bDetectNeutrals = true;

    // Apply to perception component
    PerceptionComponent->ConfigureSense(*HearingConfig);
}

void AGSDHeroAIController::OnTargetPerceptionUpdated(AActor* Actor, FAIStimulus Stimulus)
{
    // Handle perception updates
    if (Stimulus.WasSuccessfullySensed())
    {
        UE_LOG(LogTemp, Log, TEXT("Perceived actor: %s"), *Actor->GetName());

        // Update blackboard
        if (BlackboardComponent)
        {
            BlackboardComponent->SetValueAsObject(TEXT("TargetActor"), Actor);
            BlackboardComponent->SetValueAsVector(TEXT("TargetLocation"), Stimulus.StimulusLocation);
        }
    }
    else
    {
        UE_LOG(LogTemp, Log, TEXT("Lost perception of actor: %s"), *Actor->GetName());

        // Clear blackboard
        if (BlackboardComponent)
        {
            BlackboardComponent->ClearValue(TEXT("TargetActor"));
        }
    }
}
```

**Important:**
- RunBehaviorTree in OnPossess (CRITICAL - Pitfall 5)
- Behavior Tree, Blackboard, Perception components
- Sight and Hearing configuration from AIConfig
- Perception delegate for updates
- Blackboard updates on perception changes
  </action>
  <verify>
    ```bash
    # Verify AI Controller exists
    test -f Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h && echo "✓ AI Controller header exists" || echo "✗ AI Controller header missing"

    # Check for required components
    grep -q "UBehaviorTreeComponent" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h && echo "✓ BehaviorTreeComponent present" || echo "✗ BehaviorTreeComponent missing"
    grep -q "UAIPerceptionComponent" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/AI/GSDHeroAIController.h && echo "✓ PerceptionComponent present" || echo "✗ PerceptionComponent missing"
    grep -q "OnPossess" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp && echo "✓ OnPossess implemented" || echo "✗ OnPossess missing"
    grep -q "RunBehaviorTree" Plugins/GSD_Crowds/Source/GSD_Crowds/Private/AI/GSDHeroAIController.cpp && echo "✓ RunBehaviorTree called" || echo "✗ RunBehaviorTree missing"

    echo "AI Controller verification complete"
    ```
  </verify>
  <done>
    - AGSDHeroAIController enhanced with full AI capabilities
    - Behavior Tree component and execution
    - AI Perception with Sight and Hearing
    - Configuration via UGSDHeroAIConfig
    - Blackboard updates on perception
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UGSDHeroAIConfig DataAsset</name>
  <files>
    Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDHeroAIConfig.h
    Plugins/GSD_Crowds/Source/GSD_Crowds/Private/DataAssets/GSDHeroAIConfig.cpp
  </files>
  <action>
Create UGSDHeroAIConfig DataAsset for AI configuration.

**GSDHeroAIConfig.h:**
```cpp
#pragma once

#include "CoreMinimal.h"
#include "Engine/DataAsset.h"
#include "GSDHeroAIConfig.generated.h"

class UBehaviorTree;

/**
 * Configuration for Hero NPC AI systems.
 * Provides Behavior Tree, Perception settings, and AI parameters.
 */
UCLASS(BlueprintType)
class GSD_CROWDS_API UGSDHeroAIConfig : public UDataAsset
{
    GENERATED_BODY()

public:
    // === Behavior Tree ===

    /** Default Behavior Tree to run on possess */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Behavior Tree")
    UBehaviorTree* DefaultBehaviorTree;

    /** Blackboard asset (usually part of BT, but can override) */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Behavior Tree")
    UBlackboardData* BlackboardAsset;

    // === Sight Perception ===

    /** Sight detection radius */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Perception|Sight")
    float SightRadius = 2000.0f;

    /** Distance at which sight is lost */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Perception|Sight")
    float LoseSightRadius = 2500.0f;

    /** Peripheral vision angle (degrees) */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Perception|Sight")
    float PeripheralVisionAngle = 90.0f;

    // === Hearing Perception ===

    /** Hearing detection range */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Perception|Hearing")
    float HearingRange = 1500.0f;

    /** Maximum age of hearing stimulus (seconds) */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Perception|Hearing")
    float HearingStimulusMaxAge = 3.0f;

    // === Combat ===

    /** Engagement range (start attacking) */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Combat")
    float EngagementRange = 1000.0f;

    /** Attack range (melee distance) */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Combat")
    float AttackRange = 150.0f;

    /** Time between attacks (seconds) */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Combat")
    float AttackCooldown = 1.5f;

    // === Patrol ===

    /** Patrol point reach threshold */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Patrol")
    float PatrolPointTolerance = 100.0f;

    /** Wait time at patrol points (seconds) */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Patrol")
    float PatrolWaitTime = 3.0f;

    // === Movement ===

    /** Maximum walk speed */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Movement")
    float WalkSpeed = 200.0f;

    /** Maximum run speed */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Movement")
    float RunSpeed = 400.0f;

    /** Maximum sprint speed */
    UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category = "Movement")
    float SprintSpeed = 600.0f;

    /**
     * Get the default Hero AI config.
     * @return Default config asset, or nullptr if not found
     */
    UFUNCTION(BlueprintPure, Category = "GSD|AI")
    static UGSDHeroAIConfig* GetDefaultConfig();
};
```

**GSDHeroAIConfig.cpp:**
```cpp
#include "DataAssets/GSDHeroAIConfig.h"

UGSDHeroAIConfig* UGSDHeroAIConfig::GetDefaultConfig()
{
    static UGSDHeroAIConfig* DefaultConfig = nullptr;

    if (!DefaultConfig)
    {
        DefaultConfig = LoadObject<UGSDHeroAIConfig>(
            nullptr,
            TEXT("/GSD_Crowds/Config/DefaultHeroAIConfig.DefaultHeroAIConfig")
        );
    }

    return DefaultConfig;
}
```

**Important:**
- All AI parameters configurable
- Categories: Behavior Tree, Perception, Combat, Patrol, Movement
- Sensible defaults based on gameplay requirements
- Static getter for convenient access
  </action>
  <verify>
    ```bash
    # Verify AI Config exists
    test -f Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDHeroAIConfig.h && echo "✓ AI Config header exists" || echo "✗ AI Config header missing"

    # Check for required properties
    grep -q "DefaultBehaviorTree" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDHeroAIConfig.h && echo "✓ DefaultBehaviorTree defined" || echo "✗ DefaultBehaviorTree missing"
    grep -q "SightRadius" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDHeroAIConfig.h && echo "✓ SightRadius defined" || echo "✗ SightRadius missing"
    grep -q "HearingRange" Plugins/GSD_Crowds/Source/GSD_Crowds/Public/DataAssets/GSDHeroAIConfig.h && echo "✓ HearingRange defined" || echo "✗ HearingRange missing"

    echo "AI Config verification complete"
    ```
  </verify>
  <done>
    - UGSDHeroAIConfig DataAsset created
    - Behavior Tree reference and perception settings
    - Combat, patrol, movement parameters
    - Static getter for default config
  </done>
</task>

</tasks>

<verification>
1. AGSDHeroAIController has Behavior Tree, Blackboard, Perception components
2. RunBehaviorTree called in OnPossess
3. AI Perception configured for Sight and Hearing
4. UGSDHeroAIConfig created with all parameters
5. Controller uses config for all settings
</verification>

<success_criteria>
- AGSDHeroAIController with UBehaviorTreeComponent, UBlackboardComponent, UAIPerceptionComponent
- RunBehaviorTree called in OnPossess (Pitfall 5)
- Sight config: 2000 radius, 2500 lose sight, 90 degree peripheral
- Hearing config: 1500 range, 3s max age
- UGSDHeroAIConfig with Behavior Tree, perception, combat, patrol settings
- Blackboard updates on perception changes
</success_criteria>

<output>
After completion, create `.planning/phases/11-council-fixes/11-08-SUMMARY.md`
</output>
