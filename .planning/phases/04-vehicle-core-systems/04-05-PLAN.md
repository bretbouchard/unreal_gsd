---
phase: 04-vehicle-core-systems
plan: 05
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
autonomous: true

must_haves:
  truths:
    - "GSDVehicleSpawnerSubsystem spawns vehicles from Data Assets"
    - "Spawned vehicles are tracked and can be despawned"
    - "Spawning integrates with World Partition streaming"
  artifacts:
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h"
      provides: "Vehicle spawning world subsystem"
      contains: "SpawnVehicle"
      min_lines: 50
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp"
      provides: "Spawner subsystem implementation"
      contains: "SpawnVehicle"
      min_lines: 60
  key_links:
    - from: "GSDVehicleSpawnerSubsystem"
      to: "UGSDVehicleConfig"
      via: "SpawnVehicle parameter"
      pattern: "UGSDVehicleConfig.*Config"
    - from: "GSDVehicleSpawnerSubsystem"
      to: "AGSDVehiclePawn"
      via: "spawn and track"
      pattern: "AGSDVehiclePawn"
    - from: "GSDVehicleSpawnerSubsystem"
      to: "UGSDDataLayerManager"
      via: "optional streaming integration"
      pattern: "GSDDataLayerManager"
---

<objective>
Create the GSDVehicleSpawnerSubsystem that manages vehicle spawning from Data Assets with tracking and cleanup.

Purpose: Provide centralized vehicle spawning that integrates with GSD systems and World Partition streaming.
Output: World subsystem for spawning vehicles from Data Asset configurations.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vehicle-core-systems/04-RESEARCH.md

# Reference patterns
@Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Subsystems/GSDDataLayerManager.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSDVehicleSpawnerSubsystem Header</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
  </files>
  <action>
Create GSDVehicleSpawnerSubsystem header for vehicle spawning management.

Based on research (04-RESEARCH.md Pattern 4), implement:

1. Create Subsystems directory structure if needed:
   mkdir -p Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems
   mkdir -p Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems

2. Create GSDVehicleSpawnerSubsystem.h:

   Include headers:
   - CoreMinimal.h
   - Subsystems/WorldSubsystem.h
   - DataAssets/GSDVehicleConfig.h
   - Actors/GSDVehiclePawn.h
   - GSDVehicleSpawnerSubsystem.generated.h

   Declare delegates (Council: Added OnAllVehiclesDespawned):
   - DECLARE_DYNAMIC_DELEGATE_OneParam(FOnVehicleSpawnComplete, AGSDVehiclePawn*, SpawnedVehicle)
   - DECLARE_DYNAMIC_DELEGATE(FOnAllVehiclesDespawned)  // Council: Notify when all vehicles cleared

   Class declaration:
   - UCLASS()
   - class GSD_VEHICLES_API UGSDVehicleSpawnerSubsystem : public UWorldSubsystem

   Public methods (all UFUNCTION):

   SpawnVehicle (synchronous):
   - Parameters: UGSDVehicleConfig* Config, FVector Location, FRotator Rotation = FRotator::ZeroRotator
   - Returns: AGSDVehiclePawn* (spawned vehicle, nullptr on failure)
   - Category: "GSD|Vehicles"

   SpawnVehicleAsync:
   - Parameters: UGSDVehicleConfig* Config, FVector Location, FRotator Rotation, const FOnVehicleSpawnComplete& OnComplete
   - Returns: void
   - Category: "GSD|Vehicles"

   DespawnVehicle:
   - Parameters: AGSDVehiclePawn* Vehicle
   - Returns: void
   - Category: "GSD|Vehicles"

   DespawnAllVehicles:
   - Parameters: none
   - Returns: void
   - Category: "GSD|Vehicles"

   GetSpawnedVehicles:
   - Parameters: none
   - Returns: const TArray&lt;TObjectPtr&lt;AGSDVehiclePawn&gt;&gt;&  // Council: Use TObjectPtr for UE5.4+
   - Category: "GSD|Vehicles"
   - BlueprintPure

   OnAllVehiclesDespawned (Council - NEW):
   - FOnAllVehiclesDespawned& GetOnAllVehiclesDespawned()
   - Returns: Reference to delegate for binding

   Protected members:
   - UPROPERTY() TArray&lt;TObjectPtr&lt;AGSDVehiclePawn&gt;&gt; SpawnedVehicles  // Council: Use TObjectPtr
   - FOnAllVehiclesDespawned AllVehiclesDespawnedDelegate  // Council: New delegate

   Override ShouldCreateSubsystem:
   - Return true for game worlds only (not editor preview worlds)
</action>
  <verify>
grep "class.*GSDVehicleSpawnerSubsystem.*UWorldSubsystem" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
grep "SpawnVehicle" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
grep "SpawnVehicleAsync" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
grep "GetSpawnedVehicles" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Subsystems/GSDVehicleSpawnerSubsystem.h
</verify>
  <done>
GSDVehicleSpawnerSubsystem header with sync/async spawn methods and vehicle tracking.
</done>
</task>

<task type="auto">
  <name>Task 2: Create GSDVehicleSpawnerSubsystem Implementation</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
  </files>
  <action>
Create GSDVehicleSpawnerSubsystem implementation with spawning logic.

Implement:

1. Create GSDVehicleSpawnerSubsystem.cpp with includes:
   - Subsystems/GSDVehicleSpawnerSubsystem.h
   - Actors/GSDVehiclePawn.h
   - DataAssets/GSDVehicleConfig.h
   - GSDVehicleLog.h
   - GameFramework/PlayerController.h
   - Kismet/GameplayStatics.h

2. Implement ShouldCreateSubsystem:
   - Check if world is a game world (not editor preview)
   - Return GetWorld()->IsGameWorld()

3. Implement SpawnVehicle:
   - Validate Config is not null (log error if null, return nullptr)
   - Validate Config using Config->ValidateConfig()
   - If validation fails, log error and return nullptr
   - Spawn AGSDVehiclePawn using GetWorld()->SpawnActor&lt;AGSDVehiclePawn&gt;()
   - If spawn fails, log error and return nullptr
   - Call Vehicle->SpawnFromConfig(Config) to apply configuration
   - Add vehicle to SpawnedVehicles array
   - Log spawn success using LOG_GSDVEHICLES
   - Return spawned vehicle

4. Implement SpawnVehicleAsync:
   - Same validation as SpawnVehicle
   - Spawn the vehicle
   - Call SpawnFromConfig on the vehicle
   - Add to SpawnedVehicles
   - Execute OnComplete delegate with spawned vehicle

5. Implement DespawnVehicle:
   - Validate Vehicle is not null
   - Remove from SpawnedVehicles array
   - Call Vehicle->Despawn()
   - Destroy the actor using Vehicle->Destroy()
   - Log despawn using LOG_GSDVEHICLES

6. Implement DespawnAllVehicles:
   - For each vehicle in SpawnedVehicles:
     - Call Despawn()
     - Destroy()
   - Clear SpawnedVehicles array
   - Broadcast AllVehiclesDespawnedDelegate (Council: Notify listeners)
   - Log despawn all using LOG_GSDVEHICLES

7. Implement GetSpawnedVehicles:
   - Return SpawnedVehicles array
</action>
  <verify>
grep "SpawnVehicle" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
grep "SpawnActor" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
grep "SpawnFromConfig" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
grep "DespawnAllVehicles" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
grep "AllVehiclesDespawnedDelegate" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
grep "LOG_GSDVEHICLES" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Subsystems/GSDVehicleSpawnerSubsystem.cpp
</verify>
  <done>
GSDVehicleSpawnerSubsystem implementation with spawn, despawn, and tracking.
</done>
</task>

</tasks>

<verification>
1. SpawnVehicle creates vehicle from Data Asset
2. Config validation prevents invalid spawns
3. SpawnedVehicles array tracks all spawned vehicles
4. DespawnAllVehicles cleans up properly
5. Logging uses LOG_GSDVEHICLES
</verification>

<success_criteria>
- Subsystem spawns vehicles from UGSDVehicleConfig
- Async spawn with callback support
- Vehicle tracking in SpawnedVehicles array
- Despawn individual or all vehicles
- Proper validation before spawning
</success_criteria>

<output>
After completion, create `.planning/phases/04-vehicle-core-systems/04-05-SUMMARY.md`
</output>
