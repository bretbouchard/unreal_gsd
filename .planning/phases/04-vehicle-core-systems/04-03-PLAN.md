---
phase: 04-vehicle-core-systems
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Components/GSDVehicleMovementComponent.h
  - Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Components/GSDVehicleMovementComponent.cpp
autonomous: true

must_haves:
  truths:
    - "GSDVehiclePawn extends AWheeledVehiclePawn (Chaos Vehicle base)"
    - "GSDVehiclePawn implements IGSDSpawnable interface"
    - "Vehicle can be spawned from GSDVehicleConfig Data Asset"
    - "Vehicle has GSDStreamingSourceComponent for World Partition integration"
  artifacts:
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h"
      provides: "Base vehicle pawn implementing IGSDSpawnable"
      contains: "class.*GSDVehiclePawn.*AWheeledVehiclePawn.*IGSDSpawnable"
      min_lines: 50
    - path: "Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp"
      provides: "Vehicle pawn implementation"
      contains: "SpawnAsync"
      min_lines: 100
  key_links:
    - from: "GSDVehiclePawn"
      to: "AWheeledVehiclePawn"
      via: "inheritance"
      pattern: "class.*: public AWheeledVehiclePawn"
    - from: "GSDVehiclePawn"
      to: "IGSDSpawnable"
      via: "interface implementation"
      pattern: "public IGSDSpawnable"
    - from: "GSDVehiclePawn"
      to: "UGSDVehicleConfig"
      via: "SpawnAsync parameter"
      pattern: "SpawnAsync.*UGSDDataAsset"
    - from: "GSDVehiclePawn"
      to: "GSDStreamingSourceComponent"
      via: "component"
      pattern: "UGSDStreamingSourceComponent"
---

<objective>
Create the GSDVehiclePawn that extends AWheeledVehiclePawn and implements IGSDSpawnable for integration with GSD spawning system.

Purpose: Provide the base vehicle class that can be spawned from Data Assets and integrates with World Partition streaming.
Output: Functional vehicle pawn ready for player control and Chaos Vehicle physics.
</objective>

<execution_context>
@/Users/bretbouchard/.claude/get-shit-done/workflows/execute-plan.md
@/Users/bretbouchard/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vehicle-core-systems/04-RESEARCH.md

# Reference patterns
@Plugins/GSD_Core/Source/GSD_Core/Public/Interfaces/IGSDSpawnable.h
@Plugins/GSD_CityStreaming/Source/GSD_CityStreaming/Public/Components/GSDStreamingSourceComponent.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSDVehiclePawn Header</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
  </files>
  <action>
Create GSDVehiclePawn header that extends AWheeledVehiclePawn and implements IGSDSpawnable.

Based on research (04-RESEARCH.md Pattern 3), implement:

1. Create Actors directory structure if needed:
   mkdir -p Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors
   mkdir -p Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors

2. Create GSDVehiclePawn.h:

   Include headers:
   - CoreMinimal.h
   - WheeledVehiclePawn.h (CRITICAL: use AWheeledVehiclePawn, NOT AWheeledVehicle)
   - ChaosWheeledVehicleMovementComponent.h
   - Interfaces/IGSDSpawnable.h (from GSD_Core)
   - Components/GSDStreamingSourceComponent.h (from GSD_CityStreaming)

   Class declaration:
   - UCLASS(BlueprintType, Blueprintable, Category = "GSD|Vehicles")
   - class GSD_VEHICLES_API AGSDVehiclePawn : public AWheeledVehiclePawn, public IGSDSpawnable

   Constructor:
   - AGSDVehiclePawn()

   IGSDSpawnable interface implementation:
   - virtual void SpawnAsync(UGSDDataAsset* Config) override;
   - virtual UGSDDataAsset* GetSpawnConfig() override;
   - virtual bool IsSpawned() override;
   - virtual void Despawn() override;
   - virtual void ResetSpawnState() override;

   Public methods:
   - UFUNCTION(BlueprintPure) UChaosWheeledVehicleMovementComponent* GetVehicleMovement() const;

   Components:
   - UPROPERTY(VisibleAnywhere, BlueprintReadOnly) UGSDStreamingSourceComponent* StreamingSource;

   Protected members:
   - UPROPERTY(BlueprintReadOnly) UGSDVehicleConfig* VehicleConfig;
   - bool bIsSpawned = false;

   Protected methods:
   - void ApplyVehicleConfig(UGSDVehicleConfig* Config);

CRITICAL: Use AWheeledVehiclePawn (Chaos), NOT AWheeledVehicle (PhysX, deprecated).
</action>
  <verify>
grep "class.*GSDVehiclePawn.*AWheeledVehiclePawn.*IGSDSpawnable" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
grep "SpawnAsync" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
grep "UGSDStreamingSourceComponent" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Public/Actors/GSDVehiclePawn.h
</verify>
  <done>
GSDVehiclePawn header with AWheeledVehiclePawn inheritance and IGSDSpawnable interface.
</done>
</task>

<task type="auto">
  <name>Task 2: Create GSDVehiclePawn Implementation</name>
  <files>
    Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp
  </files>
  <action>
Create GSDVehiclePawn implementation with config application logic.

Based on research (04-RESEARCH.md code examples), implement:

1. Create GSDVehiclePawn.cpp with includes:
   - Actors/GSDVehiclePawn.h
   - DataAssets/GSDVehicleConfig.h
   - DataAssets/GSDWheelConfig.h
   - GSDVehicleLog.h
   - Components/GSDStreamingSourceComponent.h
   - ChaosWheeledVehicleMovementComponent.h
   - GameFramework/Controller.h

2. Implement constructor:
   - CreateDefaultSubobject for StreamingSource
   - Set bIsSpawned = false

3. Implement SpawnAsync(UGSDDataAsset* Config):
   - Cast Config to UGSDVehicleConfig
   - If invalid, log error using LOG_GSDVEHICLES and return
   - Store VehicleConfig
   - Call ApplyVehicleConfig(VehicleConfig)
   - Set bIsSpawned = true
   - Configure StreamingSource: StreamingSource->ConfigureForVehicle(VehicleConfig->bIsFastVehicle)

4. Implement ApplyVehicleConfig(UGSDVehicleConfig* Config):
   - Load skeletal mesh: Config->VehicleMesh.LoadSynchronous()
   - Set mesh on GetMesh()
   - Load physics asset: Config->PhysicsAsset.LoadSynchronous()
   - Set physics asset on GetMesh()
   - Set animation blueprint if valid
   - Configure wheel setups:
     - Get UChaosWheeledVehicleMovementComponent from GetVehicleMovementComponent()
     - Set WheelSetups array size from Config->WheelConfigs.Num()
     - For each wheel: set WheelClass = UChaosVehicleWheel::StaticClass() and BoneName from wheel config
   - Set engine torque curve if valid
   - Set mass using GetRootComponent()->SetMassOverrideInKg()

5. Implement GetSpawnConfig():
   - Return VehicleConfig

6. Implement IsSpawned():
   - Return bIsSpawned

7. Implement Despawn():
   - Set bIsSpawned = false
   - VehicleConfig = nullptr
   - Cancel any streaming source hibernation

8. Implement ResetSpawnState():
   - Call Despawn()

9. Implement GetVehicleMovement():
   - Return Cast&lt;UChaosWheeledVehicleMovementComponent&gt;(GetVehicleMovementComponent())

CRITICAL: Use UChaosWheeledVehicleMovementComponent, NOT UWheeledVehicleMovementComponent (PhysX).
</action>
  <verify>
grep "AGSDVehiclePawn::SpawnAsync" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp
grep "ApplyVehicleConfig" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp
grep "UChaosWheeledVehicleMovementComponent" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp
grep "ConfigureForVehicle" Plugins/GSD_Vehicles/Source/GSD_Vehicles/Private/Actors/GSDVehiclePawn.cpp
</verify>
  <done>
GSDVehiclePawn implementation with SpawnAsync, ApplyVehicleConfig, and IGSDSpawnable methods.
</done>
</task>

</tasks>

<verification>
1. GSDVehiclePawn inherits from AWheeledVehiclePawn (Chaos Vehicle)
2. IGSDSpawnable interface fully implemented
3. ApplyVehicleConfig loads mesh, physics, wheels, and engine settings
4. StreamingSource component created and configured
5. Uses UChaosWheeledVehicleMovementComponent (NOT PhysX)
</verification>

<success_criteria>
- GSDVehiclePawn extends AWheeledVehiclePawn
- Implements IGSDSpawnable for GSD integration
- ApplyVehicleConfig applies all vehicle settings from Data Asset
- StreamingSource configured for World Partition integration
</success_criteria>

<output>
After completion, create `.planning/phases/04-vehicle-core-systems/04-03-SUMMARY.md`
</output>
